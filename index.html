<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الاختبارات والتقويم</title>
  <link rel="icon" type="image/png" href="https://fv5-6.files.fm/thumb_show.php?i=b48jjzgf9k&view&v=1&PHPSESSID=e461ec3f0d0a2a9d0d6628b7d393e3c11f2d88b9">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .animated-gradient {
      background: linear-gradient(-45deg, #0d47a1, #00796b, #00bfa5, #1e88e5);
      background-size: 400% 400%;
      animation: gradient-animation 15s ease infinite;
    }
    @keyframes gradient-animation-developer {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .animated-gradient-developer {
      background: linear-gradient(-45deg, #001f3f, #0074d9, #ff4136, #85144b);
      background-size: 400% 400%;
      animation: gradient-animation-developer 15s ease infinite;
    }
    .animated-gradient-student {
      background-image: url('https://fv5-5.files.fm/thumb_show.php?i=yh53zuxxxd&view&v=1&PHPSESSID=e461ec3f0d0a2a9d0d6628b7d393e3c11f2d88b9');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    .dragging-over {
        border-top: 2px solid #3b82f6; /* blue-500 */
    }
     .main-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        align-items: flex-start;
      }
      @media (max-width: 1024px) {
        .main-container {
            grid-template-columns: 1fr;
        }
      }
      .c-graph__title {
        font-size: 26px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 2rem;
        text-align: center;
        grid-column: 1 / -1; /* Span across all columns */
      }
      .chart-container {
        position: relative;
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .c-graph__bar {
        transition: all 1s ease-out;
        cursor: pointer;
      }
      .c-graph__bar.highlighted {
        fill: #a78bfa; /* A lighter purple for highlight */
      }
      .axis-line { stroke: #e2e8f0; stroke-width: 1; }
      #tooltip {
        position: absolute;
        background-color: rgba(15, 23, 42, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s, transform 0.2s;
        transform: translate(-50%, -110%);
        white-space: nowrap;
      }
      .table-container {
        max-height: 550px;
        overflow-y: auto;
        background-color: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      /* Custom scrollbar */
      .table-container::-webkit-scrollbar { width: 8px; }
      .table-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 1rem; }
      .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 1rem; }
      .table-container::-webkit-scrollbar-thumb:hover { background: #a8b2c1; }
      
      .a4-page {
        background: white;
        width: 210mm;
        min-height: 297mm;
        padding: 20mm;
        margin: 1cm auto;
        border: 1px #D3D3D3 solid;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }

      @media print {
        body * {
          visibility: hidden;
        }
        #paper-preview, #paper-preview * {
          visibility: visible;
        }
        #paper-preview {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          margin: 0;
          border: 0;
          box-shadow: none;
          border-radius: 0;
        }
        .no-print {
          display: none;
        }
      }
       @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.2s ease-out forwards;
        }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <!-- MathJax Configuration -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, updateDoc, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    window.firebase = { initializeApp, getFirestore, doc, onSnapshot, setDoc, collection, addDoc, updateDoc, deleteDoc, deleteField };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;
    const { createRoot } = ReactDOM;

    // --| Firebase Configuration | --
    const firebaseConfig = {
      apiKey: "AIzaSyDAqNYMF5H8I1jCJfDwZ5PI_qztLx1MS14",
      authDomain: "bungus-78fc6.firebaseapp.com",
      projectId: "bungus-78fc6",
      storageBucket: "bungus-78fc6.appspot.com",
      messagingSenderId: "546709528555",
      appId: "1:546709528555:web:dbed8e2e70d77ed532c3ae",
      measurementId: "G-1LB7LVN38E"
    };

    // Initialize Firebase
    let app, db;
    try {
        app = window.firebase.initializeApp(firebaseConfig);
        db = window.firebase.getFirestore(app);
    } catch (e) {
        console.error("Firebase initialization error:", e);
    }

    const MathComponent = ({ text }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (window.MathJax && ref.current) {
          window.MathJax.typesetPromise([ref.current]);
        }
      }, [text]);

      return <span ref={ref}>{text}</span>;
    };
    
    // =================================================================
    // =========== START: NEW STANDALONE COMPONENTS ====================
    // =================================================================
    
    const AnimatedProgressCircle = ({ percentage, size = 160 }) => {
        const radius = (size / 2) - 10; // 10 is stroke-width
        const circumference = 2 * Math.PI * radius;
        const [offset, setOffset] = useState(circumference);
        const [displayPercentage, setDisplayPercentage] = useState(0);

        useEffect(() => {
            const progressOffset = circumference - (percentage / 100) * circumference;
            const timeoutId = setTimeout(() => {
                setOffset(progressOffset);
            }, 200);

            let start = 0;
            const end = Math.round(percentage);
            if (end === 0) {
                setDisplayPercentage(0);
                return () => clearTimeout(timeoutId);
            }

            const duration = 1500;
            const incrementTime = Math.abs(Math.floor(duration / end)) || 1;

            const timer = setInterval(() => {
                start += 1;
                setDisplayPercentage(start);
                if (start >= end) {
                    clearInterval(timer);
                    setDisplayPercentage(end); 
                }
            }, incrementTime);

            return () => {
                clearTimeout(timeoutId);
                clearInterval(timer);
            };
        }, [percentage, circumference]);

        return (
            <div className="relative" style={{ width: size, height: size }}>
                <svg className="w-full h-full" viewBox={`0 0 ${size} ${size}`}>
                    <circle
                        className="text-green-500"
                        strokeWidth="10"
                        stroke="currentColor"
                        fill="transparent"
                        r={radius}
                        cx={size/2}
                        cy={size/2}
                    />
                    <circle
                        className="text-white transform -rotate-90 origin-center"
                        strokeWidth="10"
                        strokeLinecap="round"
                        stroke="currentColor"
                        fill="transparent"
                        r={radius}
                        cx={size/2}
                        cy={size/2}
                        style={{
                            strokeDasharray: `${circumference} ${circumference}`,
                            strokeDashoffset: offset,
                            transition: 'stroke-dashoffset 0.8s ease-out'
                        }}
                    />
                </svg>
                <span className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-3xl font-bold">
                    {displayPercentage}%
                </span>
            </div>
        );
    };

    const StatCard = ({ title, value, colorClass = "text-green-600" }) => (
        <div className="bg-white dark:bg-slate-700 p-4 rounded-lg shadow-sm">
            <h3 className="font-semibold text-gray-600 dark:text-gray-300">{title}</h3>
            <p className={`text-3xl font-bold ${colorClass} mt-2`}>{value}</p>
        </div>
    );
    
    const SiteInfoModal = ({ onClose }) => {
        return (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" onClick={onClose}>
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                    <main className="w-full p-8 lg:p-12">
                        <section>
                            <h2 className="text-4xl font-bold text-[#003366] dark:text-teal-300 border-b-4 border-teal-400 pb-3 mb-8">الإشراف</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="bg-gray-50 dark:bg-slate-700 p-6 rounded-xl shadow-md">
                                    <h3 className="text-xl font-bold text-teal-600 dark:text-teal-400">أ/ ياسر بن محمد العمري</h3>
                                    <p className="text-gray-600 dark:text-gray-300 mt-1">مدير مدرسة أجيال الزرقاء الأهلية</p>
                                </div>
                                <div className="bg-gray-50 dark:bg-slate-700 p-6 rounded-xl shadow-md">
                                    <h3 className="text-xl font-bold text-teal-600 dark:text-teal-400">أ/ محمد مختار عبد الحليم</h3>
                                    <p className="text-gray-600 dark:text-gray-300 mt-1">معلم رياضيات و مدرب قدرات مدرسة اجيال الزرقاء الأهلية</p>
                                </div>
                            </div>
                        </section>

                        <section className="mt-12">
                            <h2 className="text-4xl font-bold text-[#003366] dark:text-teal-300 border-b-4 border-teal-400 pb-3 mb-6">المصادر والمراجع</h2>
                            <ul className="space-y-3 text-base text-gray-700 dark:text-gray-300">
                                <li>- العبد الكريم، ناصر. (2024). <span className="font-semibold">كتاب ناصر العبد الكريم في القدرات: القسم الكمي.</span> دار الحرف للنشر والتوزيع، المملكة العربية السعودية.</li>
                                <li>- عبد العظيم، إيهاب، وعبد العظيم، أيمن. (2023). <span className="font-semibold">هدفك 8 الشامل في القدرات.</span></li>
                                <li>- أسئلة اختبار القدرات العامة: القسم الكمي للأعوام 1440–1443 هـ. المركز الوطني للقياس، المملكة العربية السعودية.</li>
                                <li>- الجزيري، عماد. (2024). <span className="font-semibold">المعاصر 9 في القدرات: القسم الكمي.</span></li>
                                <li>- الجزيري، عماد. (2025). <span className="font-semibold">المعاصر 10 في القدرات: القسم الكمي.</span></li>
                                <li>- المنصف لأسئلة اختبار القدرات: القسم الكمي (1445 هـ).</li>
                                <li>- سلسلة رام للقدرات: القسم الكمي. (إصدارات 2016–2021). مكتبة المتنبي، المملكة العربية السعودية.</li>
                                <li>- المركز الوطني للقياس (قياس). (2025). <span className="font-semibold">دليل اختبار القدرات العامة.</span> المركز الوطني للقياس، المملكة العربية السعودية. (تم الاسترداد في 3 سبتمبر 2025).</li>
                            </ul>
                            <div className="mt-10 pt-6 border-t border-gray-200 dark:border-slate-700 text-left" dir="ltr">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div className="text-sm">
                                        <p className="font-bold text-gray-800 dark:text-gray-200">TAREK MOHAMED MOKHTAR</p>
                                        <p className="text-teal-700 dark:text-teal-400 font-semibold">DEVELOPER</p>
                                        <p className="text-gray-600 dark:text-gray-400">Researcher in Minya University - Instruction Technology Department.</p>
                                    </div>
                                    <div className="text-sm">
                                        <p className="font-bold text-gray-800 dark:text-gray-200">REHAM MOHAMED MOKHTAR</p>
                                        <p className="text-teal-700 dark:text-teal-400 font-semibold">DESIGNER</p>
                                        <p className="text-gray-600 dark:text-gray-400">Computer Science and (IT) Information Technology Department in Minya University.</p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <footer className="mt-12 text-center text-gray-500 border-t pt-6 dark:border-slate-700">
                           <button onClick={onClose} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">عودة</button>
                        </footer>
                    </main>
                </div>
            </div>
        );
    };

    const SettingsDropdown = ({ setDarkMode, darkMode, handleReturnToLanding, onShowInfo }) => {
        const [isOpen, setIsOpen] = useState(false);
        const dropdownRef = useRef(null);

        useEffect(() => {
            const handleClickOutside = (event) => {
                if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                    setIsOpen(false);
                }
            };
            document.addEventListener("mousedown", handleClickOutside);
            return () => document.removeEventListener("mousedown", handleClickOutside);
        }, [dropdownRef]);
        
        const DropdownItem = ({ icon, text, onClick }) => (
             <button onClick={onClick} title={text} className="w-full text-right flex items-center px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors duration-200">
                {icon}
            </button>
        );

        return (
            <div className="relative" ref={dropdownRef}>
                <button onClick={() => setIsOpen(!isOpen)} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors duration-200">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-slate-800 dark:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                        <path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                {isOpen && (
                    <div className="absolute left-0 mt-2 w-auto bg-white dark:bg-slate-800 rounded-lg shadow-xl z-20 overflow-hidden transform transition-all duration-300 origin-top-left scale-95 opacity-0 animate-fade-in-up flex flex-col p-1" style={{ animation: 'fadeInUp 0.2s ease-out forwards' }}>
                        <DropdownItem 
                            text="حجم الصفحة"
                            onClick={() => { /* Placeholder */ setIsOpen(false); }}
                            icon={<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" /></svg>}
                        />
                        <DropdownItem 
                            text={darkMode ? 'الوضع الفاتح' : 'الوضع الداكن'}
                            onClick={() => { setDarkMode(!darkMode); setIsOpen(false); }}
                            icon={darkMode ? <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg> : <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>}
                        />
                        <DropdownItem 
                            text="معلومات الموقع"
                            onClick={() => { onShowInfo(); setIsOpen(false); }}
                            icon={<svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>}
                        />
                         <div className="border-t border-gray-200 dark:border-gray-700 my-1"></div>
                         <button onClick={() => { handleReturnToLanding(); setIsOpen(false); }} title="تسجيل الخروج" className="w-full text-right flex items-center px-4 py-3 text-sm text-red-600 dark:text-red-400 hover:bg-slate-100 dark:hover:bg-slate-700">
                             <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                         </button>
                    </div>
                )}
            </div>
        );
    };

    const MainDashboard = ({
      currentUser,
      setDevPage,
      devUsernameToGenerate,
      setDevUsernameToGenerate,
      handleGenerateAccessCode,
      showCreateTestForm,
      setShowCreateTestForm,
      setNewTestCategory,
      editingTestId,
      newTestCategory,
      newTestTitle,
      setNewTestTitle,
      newTestDuration,
      setNewTestDuration,
      newTestMaxAttempts,
      setNewTestMaxAttempts,
      newTestPrerequisite,
      setNewTestPrerequisite,
      newTestQuestions,
      handleDragStart,
      handleDragEnter,
      handleUpdateQuestion,
      handleUpdateOption,
      handleUpdateCorrectAnswer,
      handleDeleteQuestion,
      handleAddQuestion,
      handleSaveNewTest,
      resetCreateTestForm,
      testsData,
      activeTestTab,
      setActiveTestTab,
      dragTest,
      dragOverTest,
      handleTestSort,
      handlePreviewQuiz,
      handlePaperPreview,
      handleEditTest,
      handleDeleteTest,
      newTestDifficulty,
      setNewTestDifficulty,
      levels,
      handleAddNewLevel,
      handleMoveTest,
      handleDeleteLevel,
      handleUpdateLevel,
      createTestFormRef,
      saveButtonContainerRef,
      onTriggerImport, 
      onShowExportModal
    }) => {
      const [newLevelName, setNewLevelName] = useState('');
      const [draggedTestId, setDraggedTestId] = useState(null);
      const [editingLevel, setEditingLevel] = useState(null);

      const levelsForCategory = useMemo(() => 
          levels.filter(l => l.category === activeTestTab)
          .sort((a,b) => (a.order || 0) - (b.order || 0)), 
      [levels, activeTestTab]);

      const testsByLevel = useMemo(() => {
          const grouped = {};
          levelsForCategory.forEach(l => grouped[l.id] = []);
          grouped['unassigned'] = [];

          (testsData[activeTestTab] || []).forEach(test => {
              if (test.levelId && grouped[test.levelId]) {
                  grouped[test.levelId].push(test);
              } else {
                  grouped['unassigned'].push(test);
              }
          });
          return grouped;
      }, [testsData, levelsForCategory, activeTestTab]);

      const onAddNewLevel = () => {
          if (newLevelName.trim()) {
              handleAddNewLevel(newLevelName, activeTestTab);
              setNewLevelName('');
          }
      };

      const onUpdateLevel = () => {
          if (editingLevel && editingLevel.name.trim()) {
              handleUpdateLevel(editingLevel.id, editingLevel.name);
              setEditingLevel(null);
          }
      };
      
      const handleDropOnLevel = (levelId) => {
          if (draggedTestId) {
              handleMoveTest(draggedTestId, levelId);
              setDraggedTestId(null);
          }
      };

      return (
        <div className="space-y-8">
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold mb-4">الإدارة والتقارير</h2>
                {currentUser.role !== 'supervisor' && (
                    <>
                        <div className="flex items-center mb-4 space-x-4 rtl:space-x-reverse">
                            <input
                                type="text"
                                placeholder="اسم مستخدم جديد"
                                value={devUsernameToGenerate}
                                onChange={(e) => setDevUsernameToGenerate(e.target.value)}
                                className="p-2 border rounded-lg flex-grow bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-slate-600"
                            />
                            <button onClick={() => handleGenerateAccessCode(devUsernameToGenerate)} className="bg-green-500 text-white py-2 px-4 rounded-lg">إنشاء رمز دخول</button>
                        </div>
                         <button onClick={() => setDevPage('users')} className="text-blue-500 hover:underline mb-2 block">
                            الانتقال إلى الإدارة المتقدمة للمستخدمين &larr;
                        </button>
                    </>
                )}
                <button onClick={() => setDevPage('results')} className="text-blue-500 hover:underline block">
                    الانتقال الي النتائج المتقدمة للمستخدمين &larr;
                </button>
            </div>

            {currentUser.role !== 'supervisor' && (
                <div ref={createTestFormRef} className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                  <h2 className="text-2xl font-bold mb-4">إنشاء اختبار</h2>
                  {!showCreateTestForm ? (
                      <div className="flex flex-wrap gap-4">
                          <button onClick={() => { setShowCreateTestForm(true); setNewTestCategory('كمي'); }} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                              اضافة اختبار كمي
                          </button>
                          <button onClick={() => { setShowCreateTestForm(true); setNewTestCategory('لفظي'); }} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">
                              اضافة اختبار لفظي
                          </button>
                          <button onClick={onTriggerImport} className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">
                              استيراد اختبار
                          </button>
                          <button onClick={onShowExportModal} className="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">
                              تصدير اختبار
                          </button>
                      </div>
                  ) : (
                      <div>
                          <div className="flex items-center justify-between mb-4">
                            <h3 className="text-xl font-semibold">{editingTestId ? `تعديل اختبار ${newTestCategory}` : `إضافة اختبار ${newTestCategory} جديد`}</h3>
                            <button
                                onClick={() => saveButtonContainerRef.current?.scrollIntoView({ behavior: 'smooth', block: 'end' })}
                                className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"
                                title="الانتقال إلى زر الحفظ"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                          </div>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                              <input type="text" placeholder="عنوان الاختبار" value={newTestTitle} onChange={(e) => setNewTestTitle(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                              <select value={newTestDifficulty} onChange={(e) => setNewTestDifficulty(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700">
                                    <option value="سهل">سهل</option>
                                    <option value="متوسط">متوسط</option>
                                    <option value="صعب">صعب</option>
                              </select>
                              <input type="number" placeholder="المدة (دقائق)" value={newTestDuration} onChange={(e) => setNewTestDuration(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                              <input type="number" placeholder="أقصى عدد محاولات" value={newTestMaxAttempts} onChange={(e) => setNewTestMaxAttempts(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                              <input type="number" placeholder="النسبة المطلوبة (%)" value={newTestPrerequisite} onChange={(e) => setNewTestPrerequisite(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                          </div>
                          {newTestQuestions.map((q, qIndex) => (
                              <div 
                                key={q.id} 
                                className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg mb-4 border dark:border-slate-600"
                              >
                                <div 
                                    className="cursor-grab"
                                    draggable
                                    onDragStart={(e) => handleDragStart(e, qIndex)}
                                    onDragEnter={(e) => handleDragEnter(e, qIndex)}
                                >
                                  <h4 className="font-bold mb-2">السؤال {qIndex + 1}</h4>
                                  <textarea value={q.text} onChange={(e) => handleUpdateQuestion(qIndex, 'text', e.target.value)} placeholder="نص السؤال" className="w-full p-2 border rounded-lg mb-2 bg-white dark:bg-slate-600"></textarea>
                                </div>
                                  <input
                                    type="text"
                                    placeholder="أدخل رابط صورة للسؤال (اختياري)"
                                    value={q.imageUrl}
                                    onChange={(e) => handleUpdateQuestion(qIndex, 'imageUrl', e.target.value)}
                                    className="w-full p-2 border rounded-lg mb-2 bg-white dark:bg-slate-600"
                                  />
                                  {q.imageUrl && <img src={q.imageUrl} className="w-32 h-32 object-cover rounded-lg my-2 mx-auto" alt="معاينة السؤال"/>}
                                  
                                  {q.options.map((opt, oIndex) => (
                                      <div key={opt.id} className="flex items-center mb-2 bg-white dark:bg-slate-600 p-2 rounded-lg">
                                          <input type="radio" name={`correct-answer-${q.id}`} checked={q.correctAnswer === opt.id} onChange={() => handleUpdateCorrectAnswer(qIndex, opt.id)} className="ml-2"/>
                                          <input type="text" value={opt.text} onChange={(e) => handleUpdateOption(qIndex, oIndex, 'text', e.target.value)} placeholder={`الخيار ${String.fromCharCode(97 + oIndex)}`} className="p-2 border rounded-lg flex-grow bg-white dark:bg-slate-500"/>
                                          <input type="text" placeholder="رابط صورة للخيار" value={opt.imageUrl} onChange={(e) => handleUpdateOption(qIndex, oIndex, 'imageUrl', e.target.value)} className="p-2 border rounded-lg w-1/3 ml-2 bg-white dark:bg-slate-500"/>
                                          {opt.imageUrl && <img src={opt.imageUrl} className="w-16 h-16 object-cover rounded-md ml-2" alt="معاينة الخيار"/>}
                                      </div>
                                  ))}
                                  <button onClick={() => handleDeleteQuestion(qIndex)} className="text-red-500 hover:text-red-700 text-xs mt-2">حذف السؤال</button>
                              </div>
                          ))}
                          <div ref={saveButtonContainerRef} className="flex space-x-4 rtl:space-x-reverse">
                              <button onClick={handleAddQuestion} className="bg-slate-200 dark:bg-slate-600 p-2 rounded-lg">إضافة سؤال</button>
                              <button onClick={handleSaveNewTest} className="bg-green-500 text-white p-2 rounded-lg">{editingTestId ? 'تحديث الاختبار' : 'حفظ الاختبار'}</button>
                              <button onClick={resetCreateTestForm} className="bg-red-500 text-white p-2 rounded-lg">إلغاء</button>
                          </div>
                      </div>
                  )}
                </div>
            )}
            
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
               <h2 className="text-2xl font-bold mb-4">الاختبارات الحالية</h2>
                <div className="border-b border-slate-200 dark:border-slate-700 mb-4">
                    <nav className="-mb-px flex space-x-8 rtl:space-x-reverse" aria-label="Tabs">
                        <button onClick={() => setActiveTestTab('كمي')} className={`${activeTestTab === 'كمي' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
                            كمي
                        </button>
                        <button onClick={() => setActiveTestTab('لفظي')} className={`${activeTestTab === 'لفظي' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
                            لفظي
                        </button>
                    </nav>
                </div>
                
                 {currentUser.role !== 'supervisor' && (
                     <div className="mb-4 flex space-x-2 rtl:space-x-reverse">
                        <input 
                            type="text"
                            value={newLevelName}
                            onChange={(e) => setNewLevelName(e.target.value)}
                            placeholder="اسم المستوى الجديد"
                            className="p-2 border rounded-lg flex-grow bg-slate-50 dark:bg-slate-700"
                        />
                        <button onClick={onAddNewLevel} className="bg-indigo-500 text-white py-2 px-4 rounded-lg">إضافة مستوى</button>
                    </div>
                 )}

                <div className="space-y-4">
                    {levelsForCategory.map(level => (
                        <div 
                            key={level.id}
                            className="bg-slate-100 dark:bg-slate-700 p-4 rounded-lg"
                            onDragOver={e => e.preventDefault()}
                            onDrop={currentUser.role !== 'supervisor' ? () => handleDropOnLevel(level.id) : null}
                        >
                           <div className="flex justify-between items-center mb-2">
                                {editingLevel?.id === level.id ? (
                                    <div className="flex-grow flex items-center space-x-2 rtl:space-x-reverse">
                                        <input 
                                            type="text" 
                                            value={editingLevel.name}
                                            onChange={(e) => setEditingLevel({...editingLevel, name: e.target.value})}
                                            className="p-1 border rounded-lg flex-grow bg-white dark:bg-slate-600"
                                        />
                                        <button onClick={onUpdateLevel} className="bg-green-500 text-white p-1 rounded-md text-xs">حفظ</button>
                                        <button onClick={() => setEditingLevel(null)} className="bg-gray-500 text-white p-1 rounded-md text-xs">إلغاء</button>
                                    </div>
                                ) : (
                                    <>
                                        <h3 className="font-bold text-lg">{level.name}</h3>
                                        {currentUser.role !== 'supervisor' && (
                                            <div className="flex space-x-2 rtl:space-x-reverse">
                                                <button onClick={() => setEditingLevel({id: level.id, name: level.name})} className="text-blue-500 hover:text-blue-700 text-xs">تعديل</button>
                                                <button onClick={() => handleDeleteLevel(level.id)} className="text-red-500 hover:text-red-700 text-xs">حذف</button>
                                            </div>
                                        )}
                                    </>
                                )}
                            </div>
                             <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {(testsByLevel[level.id] || []).map(test => (
                                     <div key={test.id} draggable={currentUser.role !== 'supervisor'} onDragStart={() => setDraggedTestId(test.id)} className="p-4 bg-white dark:bg-slate-600 rounded-lg border dark:border-slate-500 cursor-move">
                                        <h4 className="text-md font-bold">{test.title}</h4>
                                        <p className="text-sm">{test.questions.length} أسئلة</p>
                                        <p className="text-xs text-slate-500 dark:text-slate-400">الصعوبة: {test.difficulty || 'متوسط'}</p>
                                        <div className="mt-2 grid grid-cols-2 gap-2">
                                            <button onClick={() => handlePreviewQuiz(test)} className="bg-blue-500 text-white p-1 rounded-md text-sm">معاينة</button>
                                            <button onClick={() => handlePaperPreview(test)} className="bg-green-500 text-white p-1 rounded-md text-sm">المعاينة الورقية</button>
                                            {currentUser.role !== 'supervisor' && (
                                                <>
                                                    <button onClick={() => handleEditTest(test, activeTestTab)} className="bg-yellow-500 text-white p-1 rounded-md text-sm">تعديل</button>
                                                    <button onClick={() => handleDeleteTest(test.id)} className="bg-red-500 text-white p-1 rounded-md text-sm">حذف</button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    ))}
                    <div 
                        className="bg-slate-200 dark:bg-slate-800 p-4 rounded-lg border-2 border-dashed border-slate-400"
                        onDragOver={e => e.preventDefault()}
                        onDrop={currentUser.role !== 'supervisor' ? () => handleDropOnLevel(null) : null}
                    >
                         <h3 className="font-bold text-lg mb-2 text-slate-500">اختبارات غير مصنفة</h3>
                         <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {(testsByLevel['unassigned'] || []).map(test => (
                                <div key={test.id} draggable={currentUser.role !== 'supervisor'} onDragStart={() => setDraggedTestId(test.id)} className="p-4 bg-white dark:bg-slate-600 rounded-lg border dark:border-slate-500 cursor-move">
                                    <h4 className="text-md font-bold">{test.title}</h4>
                                    <p className="text-sm">{test.questions.length} أسئلة</p>
                                    <p className="text-xs text-slate-500 dark:text-slate-400">الصعوبة: {test.difficulty || 'متوسط'}</p>
                                     <div className="mt-2 grid grid-cols-2 gap-2">
                                        <button onClick={() => handlePreviewQuiz(test)} className="bg-blue-500 text-white p-1 rounded-md text-sm">معاينة</button>
                                        <button onClick={() => handlePaperPreview(test)} className="bg-green-500 text-white p-1 rounded-md text-sm">المعاينة الورقية</button>
                                        {currentUser.role !== 'supervisor' && (
                                            <>
                                                <button onClick={() => handleEditTest(test, activeTestTab)} className="bg-yellow-500 text-white p-1 rounded-md text-sm">تعديل</button>
                                                <button onClick={() => handleDeleteTest(test.id)} className="bg-red-500 text-white p-1 rounded-md text-sm">حذف</button>
                                            </>
                                        )}
                                    </div>
                                </div>
                            ))}
                         </div>
                    </div>
                </div>
            </div>
        </div>
      );
    };

    const UserManagementPage = ({ 
        currentUser, setDevPage, usersData, handleShowUserScores, 
        handleToggleUserRole, handleDeleteUser, handleSectionPermissionChange, 
        handleDeleteSelectedUsers, handleResetAttemptsForSelectedUsers,
        blacklist, handleAddToBlacklist, handleRemoveFromBlacklist,
        handleExportAllUsers, handleTriggerBlacklistImport
    }) => {
        const [userSearchTerm, setUserSearchTerm] = useState('');
        const [selectedUsers, setSelectedUsers] = useState([]);
        const [blacklistedUsername, setBlacklistedUsername] = useState('');
        
        const filteredUsers = useMemo(() => usersData
            .filter(user => 
                user.username.toLowerCase().includes(userSearchTerm.toLowerCase())
            )
            .sort((a, b) => {
                if (a.role === 'teacher' && b.role !== 'teacher') return -1;
                if (a.role !== 'teacher' && b.role === 'teacher') return 1;
                if (a.role === 'supervisor' && b.role === 'student') return -1;
                if (a.role === 'student' && b.role === 'supervisor') return 1;
                return a.username.localeCompare(b.username);
            }), [usersData, userSearchTerm]);

        const handleSelectAll = () => {
            if (selectedUsers.length === filteredUsers.length) {
                setSelectedUsers([]);
            } else {
                setSelectedUsers(filteredUsers.map(u => u.id));
            }
        };

        const handleSelectUser = (userId) => {
            setSelectedUsers(prevSelected => 
                prevSelected.includes(userId)
                    ? prevSelected.filter(id => id !== userId)
                    : [...prevSelected, userId]
            );
        };

        const onDeleteSelected = async () => {
            await handleDeleteSelectedUsers(selectedUsers);
            setSelectedUsers([]);
        };

        const onResetSelected = async () => {
            await handleResetAttemptsForSelectedUsers(selectedUsers);
            setSelectedUsers([]);
        };
        
        const onAddToBlacklist = () => {
            if(blacklistedUsername.trim()){
                handleAddToBlacklist(blacklistedUsername.trim());
                setBlacklistedUsername('');
            }
        };

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg space-y-8">
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">الإدارة المتقدمة للمستخدمين</h2>
                        <button onClick={() => setDevPage('dashboard')} className="text-blue-500 hover:underline">
                            &rarr; العودة إلى لوحة التحكم الرئيسية
                        </button>
                    </div>
                    {currentUser.role !== 'supervisor' && (
                        <div className="flex flex-wrap gap-4 mb-4">
                            <button onClick={handleExportAllUsers} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">تصدير جميع المستخدمين</button>
                            <button onClick={handleTriggerBlacklistImport} className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg">استيراد إلى القائمة السوداء</button>
                        </div>
                    )}

                    {selectedUsers.length > 0 && currentUser.role !== 'supervisor' && (
                        <div className="bg-blue-100 dark:bg-blue-900/50 border border-blue-300 dark:border-blue-700 rounded-lg p-3 mb-4 flex items-center justify-between">
                            <span className="font-bold">{selectedUsers.length} مستخدم(ين) محدد(ين)</span>
                            <div className="flex space-x-2 rtl:space-x-reverse">
                                <button onClick={onResetSelected} className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded-lg text-sm">تجديد المحاولات</button>
                                <button onClick={onDeleteSelected} className="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm">حذف</button>
                            </div>
                        </div>
                    )}
                    
                    <div className="mb-4">
                        <input 
                            type="text"
                            placeholder="ابحث عن اسم مستخدم..."
                            value={userSearchTerm}
                            onChange={(e) => setUserSearchTerm(e.target.value)}
                            className="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg"
                        />
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                            <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                                <tr>
                                    {currentUser.role !== 'supervisor' && (
                                        <th scope="col" className="p-4">
                                            <div className="flex items-center">
                                                <input id="checkbox-all-search" type="checkbox"
                                                    checked={filteredUsers.length > 0 && selectedUsers.length === filteredUsers.length}
                                                    onChange={handleSelectAll}
                                                    className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                                                <label htmlFor="checkbox-all-search" className="sr-only">checkbox</label>
                                            </div>
                                        </th>
                                    )}
                                    <th scope="col" className="px-6 py-3">اسم المستخدم</th>
                                    <th scope="col" className="px-6 py-3">رمز الدخول</th>
                                    <th scope="col" className="px-6 py-3">الصلاحية</th>
                                    <th scope="col" className="px-6 py-3">الأقسام المتاحة</th>
                                    <th scope="col" className="px-6 py-3 text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredUsers.map(user => (
                                    <tr key={user.id} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
                                        {currentUser.role !== 'supervisor' && (
                                            <td className="w-4 p-4">
                                                <div className="flex items-center">
                                                    <input id={`checkbox-table-search-${user.id}`} type="checkbox"
                                                        checked={selectedUsers.includes(user.id)}
                                                        onChange={() => handleSelectUser(user.id)}
                                                        className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                                                    <label htmlFor={`checkbox-table-search-${user.id}`} className="sr-only">checkbox</label>
                                                </div>
                                            </td>
                                        )}
                                        <td className="px-6 py-4 font-medium text-slate-900 dark:text-white">{user.username}</td>
                                        <td className="px-6 py-4">{user.accessCode}</td>
                                        <td className="px-6 py-4">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                user.role === 'teacher' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' 
                                                : user.role === 'supervisor' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300'
                                                : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300'}`
                                            }>
                                                {user.role === 'teacher' ? 'مطور' : user.role === 'supervisor' ? 'مشرف' : 'طالب'}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4">
                                            <div className="flex items-center space-x-4 rtl:space-x-reverse">
                                                <label className="flex items-center">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={user.allowedSections?.includes('كمي') ?? true} 
                                                        onChange={() => handleSectionPermissionChange(user.id, 'كمي')}
                                                        className="form-checkbox h-4 w-4 text-blue-600 rounded"
                                                        disabled={currentUser.role === 'supervisor'}
                                                    />
                                                    <span className="mr-2">كمي</span>
                                                </label>
                                                <label className="flex items-center">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={user.allowedSections?.includes('لفظي') ?? true} 
                                                        onChange={() => handleSectionPermissionChange(user.id, 'لفظي')}
                                                        className="form-checkbox h-4 w-4 text-green-600 rounded"
                                                        disabled={currentUser.role === 'supervisor'}
                                                    />
                                                    <span className="mr-2">لفظي</span>
                                                </label>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 flex items-center justify-center space-x-2 rtl:space-x-reverse">
                                            <button onClick={() => handleShowUserScores(user)} title="عرض بيانات المستخدم" className="p-2 text-slate-500 hover:text-blue-600 dark:hover:text-blue-400">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fillRule="evenodd" d="M.458 10C3.732 4.943 9.522 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-9.064 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd" /></svg>
                                            </button>
                                            {currentUser.role !== 'supervisor' && (
                                                <>
                                                    <button onClick={() => handleToggleUserRole(user.id)} title="تغيير الصلاحية" className="p-2 text-slate-500 hover:text-green-600 dark:hover:text-green-400">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>
                                                    </button>
                                                    <button onClick={() => handleDeleteUser(user.id)} title="حذف المستخدم" className="p-2 text-slate-500 hover:text-red-600 dark:hover:text-red-400">
                                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
                                                    </button>
                                                </>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
                {currentUser.role !== 'supervisor' && (
                    <div className="border-t dark:border-slate-700 pt-8">
                        <h2 className="text-2xl font-bold mb-4">القائمة السوداء</h2>
                        <div className="flex items-center mb-4 space-x-4 rtl:space-x-reverse">
                            <input
                                type="text"
                                placeholder="إضافة اسم مستخدم للحظر"
                                value={blacklistedUsername}
                                onChange={(e) => setBlacklistedUsername(e.target.value)}
                                className="p-2 border rounded-lg flex-grow bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-slate-600"
                            />
                            <button onClick={onAddToBlacklist} className="bg-red-500 text-white py-2 px-4 rounded-lg">حظر</button>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg max-h-60 overflow-y-auto">
                            {blacklist.length > 0 ? (
                                <ul className="space-y-2">
                                    {blacklist.map(username => (
                                        <li key={username} className="flex justify-between items-center p-2 bg-white dark:bg-slate-600 rounded">
                                            <span>{username}</span>
                                            <button onClick={() => handleRemoveFromBlacklist(username)} className="text-green-500 hover:underline text-xs">إلغاء الحظر</button>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-center text-slate-500 dark:text-slate-400">القائمة السوداء فارغة.</p>
                            )}
                        </div>
                    </div>
                )}
            </div>
        );
    };

    const ResultsChart = ({ data }) => {
        const containerRef = useRef(null);
        const [highlightedIndex, setHighlightedIndex] = useState(null);
        
        const renderChart = useCallback(() => {
            const container = containerRef.current;
            if (!container) return;
            container.innerHTML = '';
            
            let tooltip = document.getElementById('tooltip');
            if(!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'tooltip';
                document.body.appendChild(tooltip);
            }

            const padding = { top: 20, right: 10, bottom: 20, left: 10 };
            const containerWidth = container.clientWidth || 800;
            const containerHeight = 500;
            const chartWidth = containerWidth - padding.left - padding.right;
            const chartHeight = containerHeight - padding.top - padding.bottom;
            
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', containerHeight);
            svg.setAttribute('viewBox', `0 0 ${containerWidth} ${containerHeight}`);

            const mainGroup = document.createElementNS(svgNS, 'g');
            mainGroup.setAttribute('transform', `translate(${padding.left}, ${padding.top})`);
            svg.appendChild(mainGroup);

            for(let i = 0; i <= 10; i++) {
                const y = chartHeight - (i * chartHeight / 10);
                const line = document.createElementNS(svgNS, 'line');
                line.setAttribute('class', 'axis-line');
                line.setAttribute('x1', 0);
                line.setAttribute('y1', y);
                line.setAttribute('x2', chartWidth);
                line.setAttribute('y2', y);
                mainGroup.appendChild(line);
            }

            const barWidth = data.length > 0 ? chartWidth / data.length * 0.8 : 0;
            const barSpacing = data.length > 0 ? chartWidth / data.length * 0.2 : 0;

            data.forEach((student, i) => {
                const barHeight = (student.score / 100) * chartHeight;
                const xPos = i * (barWidth + barSpacing);

                const rect = document.createElementNS(svgNS, 'rect');
                rect.setAttribute('class', 'c-graph__bar');
                rect.id = `student-bar-${i}`;
                rect.setAttribute('x', xPos);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('fill', '#007FFF'); // Azure Blue
                rect.setAttribute('rx', '2');
                if (i === highlightedIndex) {
                    rect.classList.add('highlighted');
                }
                
                rect.setAttribute('y', chartHeight);
                rect.setAttribute('height', 0);
                mainGroup.appendChild(rect);
                
                setTimeout(() => {
                    rect.setAttribute('y', chartHeight - barHeight);
                    rect.setAttribute('height', barHeight);
                }, 100 + i * 50);


                rect.addEventListener('mousemove', (e) => {
                    tooltip.style.opacity = '1';
                    tooltip.style.left = `${e.pageX}px`;
                    tooltip.style.top = `${e.pageY}px`;
                    tooltip.innerHTML = `<strong>${student.name}</strong><br>النسبة: ${student.score}%`;
                });
                rect.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = '0';
                });
            });
            container.appendChild(svg);
        }, [data, highlightedIndex]);

        useEffect(() => {
            renderChart();
            let resizeTimeout;
            const handleResize = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(renderChart, 250);
            };
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
        }, [renderChart]);

        return (
            <div className="w-full">
                <div id="graph-container" ref={containerRef} className="chart-container"></div>
                <div className="table-container mt-8">
                    <table className="w-full text-sm text-left text-gray-500">
                        <thead className="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" className="px-6 py-3">اسم الطالب</th>
                                <th scope="col" className="px-6 py-3">النسبة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((student, index) => (
                                <tr 
                                    key={index} 
                                    className="bg-white border-b hover:bg-gray-50"
                                    onMouseEnter={() => setHighlightedIndex(index)}
                                    onMouseLeave={() => setHighlightedIndex(null)}
                                >
                                    <td className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">{student.name}</td>
                                    <td className="px-6 py-4">{student.score}%</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <div id="tooltip"></div>
            </div>
        );
    };

    const DonutChart = ({ percentage, size = 200, label }) => {
        const strokeWidth = 20;
        const radius = (size / 2) - (strokeWidth / 2);
        const circumference = 2 * Math.PI * radius;
        const [offset, setOffset] = useState(circumference);
        const [displayPercentage, setDisplayPercentage] = useState(0);

        useEffect(() => {
            const progressOffset = circumference - (percentage / 100) * circumference;
            setOffset(progressOffset);

            let start = 0;
            const end = Math.round(percentage);
            if (end === 0) {
                 setDisplayPercentage(0);
                 return;
            }

            const duration = 1500;
            const incrementTime = duration / end;
            
            const timer = setInterval(() => {
                start += 1;
                setDisplayPercentage(start);
                if (start >= end) clearInterval(timer);
            }, incrementTime);

            return () => clearInterval(timer);
        }, [percentage, circumference]);

        return (
            <div className="flex flex-col items-center justify-center p-4 bg-white dark:bg-slate-700 rounded-xl shadow-lg h-full">
                <h3 className="text-xl font-bold mb-4 text-slate-900 dark:text-white">{label}</h3>
                <div className="relative" style={{ width: size, height: size }}>
                    <svg width={size} height={size} className="transform -rotate-90">
                        <circle
                            cx={size / 2}
                            cy={size / 2}
                            r={radius}
                            stroke="#e2e8f0"
                            strokeWidth={strokeWidth}
                            fill="transparent"
                            className="dark:stroke-slate-600"
                        />
                        <circle
                            cx={size / 2}
                            cy={size / 2}
                            r={radius}
                            stroke="#4f46e5"
                            strokeWidth={strokeWidth}
                            fill="transparent"
                            strokeDasharray={circumference}
                            strokeDashoffset={offset}
                            strokeLinecap="round"
                            style={{ transition: 'stroke-dashoffset 1.5s ease-out' }}
                        />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className="text-4xl font-bold text-slate-900 dark:text-white">
                          {displayPercentage}%
                      </span>
                    </div>
                </div>
            </div>
        );
    };
    
    const DifficultyProgressBar = ({ difficulty, attempted, total }) => {
        const percentage = total > 0 ? (attempted / total) * 100 : 0;
        const [displayWidth, setDisplayWidth] = useState(0);

        useEffect(() => {
            const timer = setTimeout(() => {
                setDisplayWidth(percentage);
            }, 100);
            return () => clearTimeout(timer);
        }, [percentage]);

        return (
            <div>
                <div className="flex justify-between mb-1">
                    <span className="text-base font-medium text-slate-700 dark:text-slate-300">{difficulty}</span>
                    <span className="text-sm font-medium text-slate-700 dark:text-slate-300">{attempted} / {total}</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-600">
                    <div 
                        className="bg-green-500 h-4 rounded-full" 
                        style={{ width: `${displayWidth}%`, transition: 'width 1.5s ease-out' }}
                    ></div>
                </div>
            </div>
        );
    };

    const TestsByDifficultyChart = ({ data, label }) => {
        const categories = Object.keys(data);
        return (
            <div className="flex flex-col justify-center p-4 bg-white dark:bg-slate-700 rounded-xl shadow-lg h-full">
                <h3 className="text-xl font-bold mb-4 text-center text-slate-900 dark:text-white">{label}</h3>
                <div className="w-full space-y-4">
                    {categories.map(difficulty => (
                        <DifficultyProgressBar 
                            key={difficulty}
                            difficulty={difficulty}
                            attempted={data[difficulty].attempted}
                            total={data[difficulty].total}
                        />
                    ))}
                </div>
            </div>
        );
    };

    const TestResultsSummaryTable = ({ summaryData }) => {
        const [searchTerm, setSearchTerm] = useState('');
        const [sortBy, setSortBy] = useState({ key: 'participantCount', direction: 'desc' });

        const sortedAndFilteredData = useMemo(() => {
            let data = [...summaryData];

            if (searchTerm) {
                data = data.filter(item => item.title.toLowerCase().includes(searchTerm.toLowerCase()));
            }

            data.sort((a, b) => {
                if (a[sortBy.key] < b[sortBy.key]) return sortBy.direction === 'asc' ? -1 : 1;
                if (a[sortBy.key] > b[sortBy.key]) return sortBy.direction === 'asc' ? 1 : -1;
                return 0;
            });

            return data;
        }, [summaryData, searchTerm, sortBy]);

        const handleSort = (key) => {
            setSortBy(prevSortBy => ({
                key,
                direction: prevSortBy.key === key && prevSortBy.direction === 'desc' ? 'asc' : 'desc'
            }));
        };
        
        const SortIcon = ({ columnKey }) => {
            if (sortBy.key !== columnKey) return null;
            return sortBy.direction === 'asc' ? '▲' : '▼';
        };

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg mt-8">
                <h2 className="text-2xl font-bold mb-4">ملخص نتائج الاختبارات</h2>
                <input 
                    type="text"
                    placeholder="ابحث عن اختبار..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg"
                />
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                        <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                            <tr>
                                <th scope="col" className="px-6 py-3 cursor-pointer" onClick={() => handleSort('title')}>
                                    الاختبار <SortIcon columnKey="title" />
                                </th>
                                <th scope="col" className="px-6 py-3 cursor-pointer" onClick={() => handleSort('participantCount')}>
                                    عدد المشاركين <SortIcon columnKey="participantCount" />
                                </th>
                                <th scope="col" className="px-6 py-3 cursor-pointer" onClick={() => handleSort('averageScore')}>
                                    متوسط النسبة <SortIcon columnKey="averageScore" />
                                </th>
                                <th scope="col" className="px-6 py-3 cursor-pointer" onClick={() => handleSort('highestScore')}>
                                    أعلى نسبة <SortIcon columnKey="highestScore" />
                                </th>
                                <th scope="col" className="px-6 py-3 cursor-pointer" onClick={() => handleSort('lowestScore')}>
                                    أدنى نسبة <SortIcon columnKey="lowestScore" />
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {sortedAndFilteredData.map(item => (
                                <tr key={item.id} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
                                    <td className="px-6 py-4 font-medium text-slate-900 dark:text-white">{item.title}</td>
                                    <td className="px-6 py-4 text-center">{item.participantCount}</td>
                                    <td className="px-6 py-4 text-center">{item.averageScore.toFixed(1)}%</td>
                                    <td className="px-6 py-4 text-center text-green-500 font-semibold">{item.highestScore.toFixed(1)}%</td>
                                    <td className="px-6 py-4 text-center text-red-500 font-semibold">{item.lowestScore.toFixed(1)}%</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );
    };

    const ResultsManagementPage = ({ setDevPage, usersData, testsData }) => {
        const studentResults = useMemo(() => {
            return usersData
                .filter(user => user.role === 'student')
                .map(user => {
                    const allAttempts = Object.values(user.scores).flat();
                    const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
                    const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
                    const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
                    return { name: user.username, score: parseFloat(overallPercentage.toFixed(2)) };
                })
                .sort((a, b) => b.score - a.score);
        }, [usersData]);

        const participationData = useMemo(() => {
            const students = usersData.filter(user => user.role === 'student');
            const totalStudents = students.length;
            const activeStudents = students.filter(user => Object.keys(user.scores).length > 0).length;
            const percentage = totalStudents > 0 ? (activeStudents / totalStudents) * 100 : 0;
            return { percentage, activeStudents, totalStudents };
        }, [usersData]);
        
        const testsByDifficultyData = useMemo(() => {
            const stats = {
                'سهل': { total: 0, attempted: 0 },
                'متوسط': { total: 0, attempted: 0 },
                'صعب': { total: 0, attempted: 0 }
            };

            const allTests = [...(testsData['كمي'] || []), ...(testsData['لفظي'] || [])];
            if (!allTests.length) return stats;

            const activeStudents = usersData.filter(user => user.role === 'student' && Object.keys(user.scores).length > 0);
            
            const attemptedTestIds = new Set();
            activeStudents.forEach(user => {
                Object.keys(user.scores).forEach(testId => {
                    attemptedTestIds.add(testId);
                });
            });

            allTests.forEach(test => {
                const difficulty = test.difficulty || 'متوسط';
                if (stats[difficulty]) {
                    stats[difficulty].total += 1;
                    if (attemptedTestIds.has(test.id)) {
                        stats[difficulty].attempted += 1;
                    }
                }
            });

            return stats;
        }, [usersData, testsData]);

        const testResultsSummary = useMemo(() => {
            const allTests = [...(testsData['كمي'] || []), ...(testsData['لفظي'] || [])];
            if (!allTests.length) return [];

            const summary = allTests.map(test => {
                const attempts = [];
                usersData
                    .filter(user => user.role === 'student' && user.scores[test.id])
                    .forEach(user => {
                        const userAttemptsForTest = user.scores[test.id];
                        userAttemptsForTest.forEach(attempt => {
                            if (attempt.total > 0) {
                                attempts.push((attempt.score / attempt.total) * 100);
                            }
                        });
                    });

                const participantCount = new Set(
                    usersData
                    .filter(user => user.role === 'student' && user.scores[test.id])
                    .map(user => user.id)
                ).size;

                if (attempts.length === 0) {
                    return {
                        id: test.id,
                        title: test.title,
                        category: test.category,
                        participantCount: 0,
                        averageScore: 0,
                        highestScore: 0,
                        lowestScore: 0,
                    };
                }

                const averageScore = attempts.reduce((acc, score) => acc + score, 0) / attempts.length;
                const highestScore = Math.max(...attempts);
                const lowestScore = Math.min(...attempts);

                return {
                    id: test.id,
                    title: test.title,
                    category: test.category,
                    participantCount,
                    averageScore,
                    highestScore,
                    lowestScore,
                };
            });

            return summary.sort((a,b) => b.participantCount - a.participantCount);
        }, [usersData, testsData]);

        return (
            <div className="bg-transparent p-0">
                <div className="flex justify-between items-center mb-6 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h2 className="text-2xl font-bold">النتائج المتقدمة للمستخدمين</h2>
                    <button onClick={() => setDevPage('dashboard')} className="text-blue-500 hover:underline">
                        &rarr; العودة إلى لوحة التحكم الرئيسية
                    </button>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
                    <div className="lg:col-span-1 flex flex-col gap-8">
                         <DonutChart percentage={participationData.percentage} label="نسبة مشاركة الطلاب" />
                         <div className="text-center -mt-4 text-slate-600 dark:text-slate-400 p-4 bg-white dark:bg-slate-800 rounded-xl shadow-lg">
                            <p>
                                <span className="font-bold">{participationData.activeStudents}</span>
                                {" "}من أصل{" "}
                                <span className="font-bold">{participationData.totalStudents}</span>
                                {" "}طلاب شاركوا في الاختبارات.
                            </p>
                        </div>
                        <TestsByDifficultyChart data={testsByDifficultyData} label="الاختبارات المنجزة حسب الصعوبة" />
                    </div>
                    <div className="lg:col-span-2">
                        <ResultsChart data={studentResults} />
                    </div>
                </div>
                <TestResultsSummaryTable summaryData={testResultsSummary} />
            </div>
        );
    };

    const Leaderboard = ({ users, limit = 10 }) => {
        const leaderboardData = useMemo(() => {
            return users
                .filter(user => user.role === 'student') // Filter out teachers
                .map(user => {
                    const allAttempts = Object.values(user.scores).flat();
                    const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
                    const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
                    const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
                    return { username: user.username, score: overallPercentage.toFixed(2) };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, limit);
        }, [users]);

        const Medal = ({ rank }) => {
            if (rank === 0) return <span title="المركز الأول" className="text-yellow-400">🥇</span>;
            if (rank === 1) return <span title="المركز الثاني" className="text-slate-400">🥈</span>;
            if (rank === 2) return <span title="المركز الثالث" className="text-yellow-600">🥉</span>;
            return <span className="text-slate-400">{rank + 1}</span>;
        };

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold mb-4 text-center">قائمة المتصدرين</h2>
                <ul className="space-y-4">
                    {leaderboardData.map((user, index) => (
                        <li key={user.username} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                            <div className="flex items-center">
                                <span className="text-lg font-bold w-8 text-center"><Medal rank={index} /></span>
                                <span className="font-medium text-slate-900 dark:text-white">{user.username}</span>
                            </div>
                            <span className="font-bold text-blue-500">{user.score}%</span>
                        </li>
                    ))}
                </ul>
            </div>
        );
      };
    
    // =================================================================
    // ===========  END: NEW STANDALONE COMPONENTS  ====================
    // =================================================================

    const ExportModal = ({ tests, onClose, onExport }) => {
        return (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" onClick={onClose}>
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden max-w-2xl w-full max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}>
                    <header className="p-4 border-b dark:border-slate-700">
                        <h2 className="text-xl font-bold text-center">تصدير اختبار</h2>
                    </header>
                    <main className="p-6 overflow-y-auto">
                       { tests.length > 0 ? (
                            <ul className="space-y-3">
                                {tests.map(test => (
                                    <li key={test.id} className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                                        <div>
                                            <span className="font-semibold">{test.title}</span>
                                            <span className={`text-xs px-2 py-1 rounded-full mr-2 ${test.category === 'كمي' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'}`}>{test.category}</span>
                                        </div>
                                        <button onClick={() => onExport(test)} className="bg-teal-500 hover:bg-teal-600 text-white font-bold py-1 px-3 rounded-md text-sm">تصدير</button>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-center text-slate-500">لا توجد اختبارات لتصديرها.</p>
                        )}
                    </main>
                     <footer className="p-4 border-t dark:border-slate-700 text-center">
                        <button onClick={onClose} className="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-6 rounded-lg">إغلاق</button>
                    </footer>
                </div>
            </div>
        );
    };

    function App() {
      const [testsData, setTestsData] = useState({ 'كمي': [], 'لفظي': [] });
      const [usersData, setUsersData] = useState([]);
      const [levels, setLevels] = useState([]);
      const [blacklist, setBlacklist] = useState([]);
      const [isDataLoaded, setIsDataLoaded] = useState(false);
      const [openLevel, setOpenLevel] = useState(null);
      
      const createTestFormRef = useRef(null);
      const saveButtonContainerRef = useRef(null);

      useEffect(() => {
        if (!db) {
            console.error("فشل تهيئة Firebase. يرجى التحقق من معلومات الإعداد.");
            setIsDataLoaded(true);
            return;
        }
        const unsubscribeTests = window.firebase.onSnapshot(window.firebase.collection(db, "tests"), (snapshot) => {
            const newTestsData = { 'كمي': [], 'لفظي': [] };
            snapshot.forEach(doc => {
                const test = { id: doc.id, ...doc.data() };
                if (newTestsData[test.category]) {
                    newTestsData[test.category].push(test);
                }
            });
            setTestsData(newTestsData);
        });

        const unsubscribeUsers = window.firebase.onSnapshot(window.firebase.collection(db, "users"), (snapshot) => {
            const newUsersData = [];
            snapshot.forEach(doc => {
                newUsersData.push({ id: doc.id, ...doc.data() });
            });
            setUsersData(newUsersData);
        });
        
        const unsubscribeLevels = window.firebase.onSnapshot(window.firebase.collection(db, "levels"), (snapshot) => {
            const newLevelsData = [];
            snapshot.forEach(doc => {
                newLevelsData.push({ id: doc.id, ...doc.data() });
            });
            setLevels(newLevelsData);
        });
        
        const unsubscribeBlacklist = window.firebase.onSnapshot(window.firebase.doc(db, "config", "blacklist"), (doc) => {
            if (doc.exists()) {
                setBlacklist(doc.data().usernames || []);
            } else {
                setBlacklist([]);
            }
            setIsDataLoaded(true);
        });


        return () => {
            unsubscribeTests();
            unsubscribeUsers();
            unsubscribeLevels();
            unsubscribeBlacklist();
        };
      }, []);

      const [currentPage, setCurrentPage] = useState('landing');
      const [devPage, setDevPage] = useState('dashboard');
      const [loginRole, setLoginRole] = useState(null);
      const [currentUser, setCurrentUser] = useState(null);
      const [selectedTest, setSelectedTest] = useState(null);
      const [answers, setAnswers] = useState({});
      const [timer, setTimer] = useState(0);
      const [quizSubmitted, setQuizSubmitted] = useState(false);
      const [darkMode, setDarkMode] = useState(false);
      const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
      const [paperPreviewTest, setPaperPreviewTest] = useState(null);
      const [showInfoModal, setShowInfoModal] = useState(false);


      // State for manual quiz creation
      const [showCreateTestForm, setShowCreateTestForm] = useState(false);
      const [editingTestId, setEditingTestId] = useState(null);
      const [newTestTitle, setNewTestTitle] = useState('');
      const [newTestDuration, setNewTestDuration] = useState('');
      const [newTestMaxAttempts, setNewTestMaxAttempts] = useState('');
      const [newTestPrerequisite, setNewTestPrerequisite] = useState('');
      const [newTestQuestions, setNewTestQuestions] = useState([]);
      const [newTestCategory, setNewTestCategory] = useState('كمي');
      const [newTestDifficulty, setNewTestDifficulty] = useState('متوسط');
      const [previewQuiz, setPreviewQuiz] = useState(null);

      // State for Import/Export
      const [showExportModal, setShowExportModal] = useState(false);
      const importFileRef = useRef(null);
      const blacklistImportFileRef = useRef(null);

      // State for Login
      const [devUsername, setDevUsername] = useState('');
      const [devPassword, setDevPassword] = useState('');
      const [userUsernameInput, setUserUsernameInput] = useState('');
      const [userAccessCodeInput, setUserAccessCodeInput] = useState('');
      const [devUsernameToGenerate, setDevUsernameToGenerate] = useState('');
      const [loginError, setLoginError] = useState('');
      
      const DEV_USERNAME = 'tarek2000';
      const DEV_PASSWORD = 'BossX@786';
      
      const [activeTestTab, setActiveTestTab] = useState('كمي');

      // Refs for drag and drop tests
      const dragTest = useRef(null);
      const dragOverTest = useRef(null);
      const dragItem = useRef();
      const dragOverItem = useRef();

      useEffect(() => {
        if (darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [darkMode]);

      useEffect(() => {
        if (currentPage === 'test' && timer > 0) {
          const intervalId = setInterval(() => {
            setTimer(prevTimer => prevTimer - 1);
          }, 1000);
          return () => clearInterval(intervalId);
        } else if (currentPage === 'test' && timer === 0 && !quizSubmitted) {
          handleSubmitTest();
        }
      }, [currentPage, timer, quizSubmitted]);
      
      const handleLogin = () => {
        setLoginError('');
        const username = loginRole === 'teacher' ? devUsername : userUsernameInput;
        if (blacklist.includes(username)) {
            setLoginError('هذا المستخدم محظور ولا يمكنه الدخول.');
            return;
        }

        if (loginRole === 'teacher') {
          if (devUsername === DEV_USERNAME && devPassword === DEV_PASSWORD) {
            setCurrentUser({username: DEV_USERNAME, role: 'superadmin'});
            setCurrentPage('dashboard');
            setDevPage('dashboard');
            return;
          }
          const developer = usersData.find(u => (u.role === 'teacher' || u.role === 'supervisor') && u.username === devUsername && u.password === devPassword);
          if (developer) {
            setCurrentUser(developer);
            setCurrentPage('dashboard');
            setDevPage('dashboard');
          } else {
            setLoginError('اسم المستخدم أو كلمة المرور غير صحيحة.');
          }
        } else if (loginRole === 'student') {
          const user = usersData.find(u => u.username === userUsernameInput && u.accessCode === userAccessCodeInput);
          if (user) {
            setCurrentUser(user);
            setCurrentPage('dashboard');
          } else {
            setLoginError('اسم المستخدم أو رمز الدخول غير صحيح.');
          }
        }
      };
      
      const handleGenerateAccessCode = async (username) => {
        if (!username) {
            alert('الرجاء إدخال اسم المستخدم أولاً.');
            return;
        }
        const existingUser = usersData.find(u => u.username === username);
        if (existingUser) {
            alert('هذا المستخدم موجود بالفعل.');
            return;
        }

        const newCode = Math.floor(100000 + Math.random() * 900000).toString();
        const newUser = {
          username: username,
          accessCode: newCode,
          scores: {},
          attemptsLeft: {},
          role: 'student',
          allowedSections: ['كمي', 'لفظي'],
          incorrectQuestions: [],
        };
        
        await window.firebase.addDoc(window.firebase.collection(db, "users"), newUser);
        setDevUsernameToGenerate('');
        alert(`تم توليد رمز دخول جديد للمستخدم ${username}: ${newCode}`);
      };

      const handleDeleteUser = async (userId) => {
        if(window.confirm(`هل أنت متأكد من رغبتك في حذف هذا المستخدم؟ لا يمكن التراجع عن هذا الإجراء.`)){
            await window.firebase.deleteDoc(window.firebase.doc(db, "users", userId));
        }
      };
      
      const handleDeleteSelectedUsers = async (userIds) => {
        if (window.confirm(`هل أنت متأكد من رغبتك في حذف ${userIds.length} مستخدم(ين)؟`)) {
            const deletePromises = userIds.map(id => window.firebase.deleteDoc(window.firebase.doc(db, "users", id)));
            await Promise.all(deletePromises);
        }
    };

    const handleResetAttemptsForSelectedUsers = async (userIds) => {
        if (window.confirm(`هل أنت متأكد من رغبتك في تجديد محاولات ${userIds.length} مستخدم(ين)؟`)) {
            const resetPromises = userIds.map(id => window.firebase.updateDoc(window.firebase.doc(db, "users", id), { attemptsLeft: {} }));
            await Promise.all(resetPromises);
        }
    };

      const handleResetSingleTestAttempts = async (userId, testId) => {
         if(window.confirm(`هل أنت متأكد من رغبتك في تجديد محاولة هذا الاختبار لهذا المستخدم؟`)){
            const userToUpdate = usersData.find(u => u.id === userId);
            const newAttemptsLeft = { ...userToUpdate.attemptsLeft };
            delete newAttemptsLeft[testId];
            await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), { attemptsLeft: newAttemptsLeft });
        }
      };
      
      const handleToggleUserRole = async (userId) => {
        const userToUpdate = usersData.find(u => u.id === userId);
        let newRole;
        let rolePromptText = '';

        if (userToUpdate.role === 'student') {
            newRole = 'supervisor';
            rolePromptText = 'مشرف';
        } else if (userToUpdate.role === 'supervisor') {
            newRole = 'teacher';
            rolePromptText = 'مطور';
        } else { // teacher or undefined
            newRole = 'student';
        }

        let updateData = { role: newRole };

        if (newRole === 'teacher' || newRole === 'supervisor') {
          const password = prompt(`الرجاء تعيين كلمة مرور للمستخدم: ${userToUpdate.username} (${rolePromptText})`);
          if (password && password.length > 0) {
            updateData.password = password;
          } else {
            return; // User cancelled or entered empty password
          }
        } else {
          updateData.password = window.firebase.deleteField();
        }
        await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), updateData);
      };
      
      const handleSectionPermissionChange = async (userId, section) => {
        const userToUpdate = usersData.find(u => u.id === userId);
        const allowed = userToUpdate.allowedSections || ['كمي', 'لفظي'];
        const newAllowedSections = allowed.includes(section)
            ? allowed.filter(s => s !== section)
            : [...allowed, section];
        await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), { allowedSections: newAllowedSections });
    };

      const handleDeleteTest = async (testId) => {
        if(window.confirm('هل أنت متأكد من رغبتك في حذف هذا الاختبار؟ سيتم حذف جميع درجات الطلاب المتعلقة به.')){
            await window.firebase.deleteDoc(window.firebase.doc(db, "tests", testId));
        }
      };
      
      const handleDeleteLevel = async (levelId) => {
        if (!window.confirm('هل أنت متأكد من حذف هذا المستوى؟ سيتم نقل جميع الاختبارات داخله إلى قسم "غير مصنفة".')) return;
        
        const allTests = [...testsData['كمي'], ...testsData['لفظي']];
        const testsToUpdate = allTests.filter(test => test.levelId === levelId);
        
        const updatePromises = testsToUpdate.map(test => {
            const testRef = window.firebase.doc(db, "tests", test.id);
            return window.firebase.updateDoc(testRef, { levelId: null });
        });
        
        await Promise.all(updatePromises);
        await window.firebase.deleteDoc(window.firebase.doc(db, "levels", levelId));
    };

    const handleUpdateLevel = async (levelId, newName) => {
        if (newName.trim() === '') return;
        const levelRef = window.firebase.doc(db, "levels", levelId);
        await window.firebase.updateDoc(levelRef, { name: newName });
    };

      const handleReturnToLanding = () => {
        setDevUsername('');
        setDevPassword('');
        setUserUsernameInput('');
        setUserAccessCodeInput('');
        setLoginError('');
        setCurrentPage('landing');
        setCurrentUser(null);
        setLoginRole(null);
      };

      const handleStartTest = (testId) => {
        const allTests = [...(testsData['كمي'] || []), ...(testsData['لفظي'] || [])];
        const test = allTests.find(t => t.id === testId);
        
        const shuffledQuestions = [...test.questions].sort(() => Math.random() - 0.5);
        const testWithShuffledQuestions = { ...test, questions: shuffledQuestions };

        const currentUserData = usersData.find(u => u.username === currentUser.username);
        if (!currentUserData) return;
        
        const attemptsLeft = currentUserData.attemptsLeft[test.id] !== undefined
          ? currentUserData.attemptsLeft[test.id]
          : test.maxAttempts;

        if (attemptsLeft <= 0) return;

        const allAttempts = Object.values(currentUserData.scores).flat();
        const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
        const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
        const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
        const prerequisite = test.prerequisitePercentage || 0;

        if (overallPercentage < prerequisite) return;

        setSelectedTest(testWithShuffledQuestions);
        setAnswers({});
        setQuizSubmitted(false);
        setTimer(test.duration * 60);
        setCurrentPage('test');
        setCurrentQuestionIndex(0);
      };
      
      const handleStartIncorrectTest = () => {
        const currentUserData = usersData.find(u => u.id === currentUser.id);
        if (!currentUserData || !currentUserData.incorrectQuestions || currentUserData.incorrectQuestions.length === 0) {
            return;
        }

        const incorrectTest = {
            id: 'incorrect_questions_test',
            title: 'الأسئلة الصعبة',
            questions: currentUserData.incorrectQuestions,
            duration: currentUserData.incorrectQuestions.length, // 1 minute per question
            isIncorrectTest: true
        };
        
        setSelectedTest(incorrectTest);
        setAnswers({});
        setQuizSubmitted(false);
        setTimer(incorrectTest.duration * 60);
        setCurrentPage('test');
        setCurrentQuestionIndex(0);
    };

      const handleNextQuestion = () => {
        if (currentQuestionIndex < selectedTest.questions.length - 1) {
          setCurrentQuestionIndex(prevIndex => prevIndex + 1);
        }
      };

      const handlePreviousQuestion = () => {
        if (currentQuestionIndex > 0) {
          setCurrentQuestionIndex(prevIndex => prevIndex - 1);
        }
      };

      const handleAnswerChange = (questionId, selectedOption) => {
        setAnswers({ ...answers, [questionId]: selectedOption });
      };

      const handleSubmitTest = async () => {
        if (quizSubmitted) return;
        setQuizSubmitted(true);
        const userToUpdate = usersData.find(user => user.username === currentUser.username);
        const userRef = window.firebase.doc(db, "users", userToUpdate.id);

        if (selectedTest.isIncorrectTest) {
            const correctlyAnsweredIds = selectedTest.questions
                .filter(q => answers[q.id] === q.correctAnswer)
                .map(q => q.id);

            const remainingIncorrect = userToUpdate.incorrectQuestions.filter(q => !correctlyAnsweredIds.includes(q.id));
            await window.firebase.updateDoc(userRef, {
                incorrectQuestions: remainingIncorrect
            });
        } else {
            const incorrectQuestionsFromThisTest = selectedTest.questions
                .filter(q => answers[q.id] !== q.correctAnswer);

            const existingIncorrectIds = new Set((userToUpdate.incorrectQuestions || []).map(q => q.id));
            const newIncorrectQuestions = incorrectQuestionsFromThisTest.filter(q => !existingIncorrectIds.has(q.id));

            const score = selectedTest.questions.filter(q => answers[q.id] === q.correctAnswer).length;
            const timeTaken = selectedTest.duration * 60 - timer;

            const newAttemptsLeft = (userToUpdate.attemptsLeft[selectedTest.id] !== undefined
                ? userToUpdate.attemptsLeft[selectedTest.id]
                : selectedTest.maxAttempts) - 1;

            const newScoreData = {
                score: score,
                total: selectedTest.questions.length,
                date: new Date().toLocaleDateString('ar-SA'),
                time: new Date().toLocaleTimeString('ar-SA'),
                timeTaken: timeTaken
            };

            const updatedScores = { ...userToUpdate.scores };
            if (!updatedScores[selectedTest.id]) {
                updatedScores[selectedTest.id] = [];
            }
            updatedScores[selectedTest.id].push(newScoreData);

            await window.firebase.updateDoc(userRef, {
                scores: updatedScores,
                [`attemptsLeft.${selectedTest.id}`]: newAttemptsLeft,
                incorrectQuestions: [...(userToUpdate.incorrectQuestions || []), ...newIncorrectQuestions]
            });
        }

        setCurrentPage('results');
      };

      const [showUserScores, setShowUserScores] = useState(false);
      const [userScoresToShow, setUserScoresToShow] = useState(null);

      const handleShowUserScores = (user) => {
        setUserScoresToShow(user);
        setShowUserScores(true);
      };

      const handleCloseUserScores = () => {
        setShowUserScores(false);
        setUserScoresToShow(null);
      };

      const handleDragStart = (e, position) => {
        dragItem.current = position;
      };

      const handleDragEnter = (e, position) => {
        dragOverItem.current = position;
        const list = [...newTestQuestions];
        const dragItemContent = list[dragItem.current];
        list.splice(dragItem.current, 1);
        list.splice(dragOverItem.current, 0, dragItemContent);
        dragItem.current = dragOverItem.current;
        dragOverItem.current = null;
        setNewTestQuestions(list);
      };
      
      const handleTestSort = () => {
        if (dragTest.current === null || dragOverTest.current === null) return;

        const testsCopy = [...testsData[activeTestTab]];
        const draggedItemContent = testsCopy.splice(dragTest.current, 1)[0];
        testsCopy.splice(dragOverTest.current, 0, draggedItemContent);

        setTestsData(prev => ({
            ...prev,
            [activeTestTab]: testsCopy
        }));

        dragTest.current = null;
        dragOverTest.current = null;
    };

      const handleAddQuestion = () => {
        setNewTestQuestions([...newTestQuestions, {
          id: Date.now(),
          text: '',
          imageUrl: '',
          type: 'mcq',
          options: [
            { id: 'a', text: '', imageUrl: '' },
            { id: 'b', text: '', imageUrl: '' },
            { id: 'c', text: '', imageUrl: '' },
            { id: 'd', text: '', imageUrl: '' }
          ],
          correctAnswer: 'a'
        }]);
      };

      const handleUpdateQuestion = (qIndex, field, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex][field] = value;
        setNewTestQuestions(updatedQuestions);
      };
      
      const handleDeleteQuestion = (qIndex) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions.splice(qIndex, 1);
        setNewTestQuestions(updatedQuestions);
      };
      
      const handleUpdateCorrectAnswer = (qIndex, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex].correctAnswer = value;
        setNewTestQuestions(updatedQuestions);
      };

      const handleUpdateOption = (qIndex, oIndex, field, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex].options[oIndex][field] = value;
        setNewTestQuestions(updatedQuestions);
      };
      
      const resetCreateTestForm = () => {
          setNewTestTitle('');
          setNewTestDuration('');
          setNewTestMaxAttempts('');
          setNewTestPrerequisite('');
          setNewTestDifficulty('متوسط');
          setNewTestQuestions([]);
          setShowCreateTestForm(false);
          setEditingTestId(null);
      }

      const handleSaveNewTest = async () => {
        if (!newTestTitle || !newTestDuration || !newTestMaxAttempts || newTestQuestions.length === 0) return;
        
        const originalTest = editingTestId ? [...testsData['كمي'], ...testsData['لفظي']].find(t => t.id === editingTestId) : null;

        const newTest = {
          title: newTestTitle,
          category: newTestCategory,
          duration: parseInt(newTestDuration, 10),
          maxAttempts: parseInt(newTestMaxAttempts, 10),
          prerequisitePercentage: parseInt(newTestPrerequisite, 10) || 0,
          difficulty: newTestDifficulty,
          questions: newTestQuestions,
          levelId: originalTest ? originalTest.levelId : null // Preserve the levelId
        };

        if(editingTestId) {
            await window.firebase.setDoc(window.firebase.doc(db, "tests", editingTestId), newTest);
        } else {
            await window.firebase.addDoc(window.firebase.collection(db, "tests"), newTest);
        }
        resetCreateTestForm();
      };

      const handleEditTest = (testToEdit, category) => {
        setEditingTestId(testToEdit.id);
        setNewTestTitle(testToEdit.title);
        setNewTestDuration(testToEdit.duration.toString());
        setNewTestMaxAttempts(testToEdit.maxAttempts.toString());
        setNewTestPrerequisite(testToEdit.prerequisitePercentage?.toString() || '0');
        setNewTestDifficulty(testToEdit.difficulty || 'متوسط');
        setNewTestQuestions(JSON.parse(JSON.stringify(testToEdit.questions)));
        setNewTestCategory(category);
        setShowCreateTestForm(true);

        setTimeout(() => {
            createTestFormRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
      };
      
      const handleAddNewLevel = async (levelName, category) => {
        if (levelName.trim() === '') return;
        await window.firebase.addDoc(window.firebase.collection(db, "levels"), {
            name: levelName,
            category: category,
            order: levels.filter(l => l.category === category).length
        });
      };
      
      const handleMoveTest = async (testId, levelId) => {
          if(!testId) return;
          const testRef = window.firebase.doc(db, "tests", testId);
          await window.firebase.updateDoc(testRef, { levelId: levelId });
      };

      // --- Import/Export Functions ---
      const handleExportTest = (test) => {
          if (!test) return;
          
          const exportData = {
              title: test.title,
              category: test.category,
              duration: test.duration,
              maxAttempts: test.maxAttempts,
              prerequisitePercentage: test.prerequisitePercentage || 0,
              difficulty: test.difficulty || 'متوسط',
              questions: test.questions.map(q => ({
                  text: q.text,
                  imageUrl: q.imageUrl || '',
                  type: q.type,
                  options: q.options.map(o => ({
                      id: o.id,
                      text: o.text,
                      imageUrl: o.imageUrl || ''
                  })),
                  correctAnswer: q.correctAnswer
              })),
          };

          const jsonString = JSON.stringify(exportData, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${test.title.replace(/[\s/\\?%*:|"<>]/g, '_')}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          setShowExportModal(false);
      };

      const handleTriggerImport = () => {
          importFileRef.current.click();
      };

      const handleFileImport = (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = async (e) => {
              try {
                  const importedData = JSON.parse(e.target.result);
                  
                  if (!importedData.title || !importedData.questions || !importedData.category) {
                      alert("ملف JSON غير صالح أو يفتقد للحقول المطلوبة.");
                      return;
                  }
                  
                  const processedQuestions = importedData.questions.map((q, i) => ({
                      ...q,
                      id: q.id || Date.now() + i,
                      options: q.options.map((o, j) => ({
                          ...o,
                          id: o.id || String.fromCharCode(97 + j)
                      }))
                  }));

                  const newTest = {
                      title: importedData.title,
                      category: importedData.category,
                      duration: parseInt(importedData.duration, 10) || 60,
                      maxAttempts: parseInt(importedData.maxAttempts, 10) || 3,
                      prerequisitePercentage: parseInt(importedData.prerequisitePercentage, 10) || 0,
                      difficulty: importedData.difficulty || 'متوسط',
                      questions: processedQuestions,
                      levelId: null
                  };

                  await window.firebase.addDoc(window.firebase.collection(db, "tests"), newTest);
                  alert(`تم استيراد اختبار "${newTest.title}" بنجاح!`);

              } catch (error) {
                  console.error("Error importing test:", error);
                  alert("حدث خطأ أثناء استيراد الاختبار. يرجى التحقق من تنسيق الملف.");
              }
          };
          reader.readAsText(file);
          event.target.value = null; // Reset file input
      };
      
      const handleExportAllUsers = () => {
        const usersToExport = usersData.map(({ id, password, ...rest }) => rest);
        const jsonString = JSON.stringify(usersToExport, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'all_users.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    const handleTriggerBlacklistImport = () => {
        blacklistImportFileRef.current.click();
    };

    const handleBlacklistFileImport = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedUsernames = JSON.parse(e.target.result);
                if (!Array.isArray(importedUsernames)) {
                    alert("الملف يجب أن يحتوي على قائمة (array) من أسماء المستخدمين.");
                    return;
                }
                const newBlacklist = [...new Set([...blacklist, ...importedUsernames])];
                await window.firebase.setDoc(window.firebase.doc(db, "config", "blacklist"), { usernames: newBlacklist });
                alert(`تم استيراد ${importedUsernames.length} مستخدم إلى القائمة السوداء.`);
            } catch (error) {
                alert("خطأ في قراءة الملف. تأكد أنه ملف JSON صالح.");
            }
        };
        reader.readAsText(file);
        event.target.value = null;
    };

    const handleAddToBlacklist = async (username) => {
        if (!username || blacklist.includes(username)) return;
        const newBlacklist = [...blacklist, username];
        await window.firebase.setDoc(window.firebase.doc(db, "config", "blacklist"), { usernames: newBlacklist });
    };

    const handleRemoveFromBlacklist = async (usernameToRemove) => {
        const newBlacklist = blacklist.filter(u => u !== usernameToRemove);
        await window.firebase.setDoc(window.firebase.doc(db, "config", "blacklist"), { usernames: newBlacklist });
    };


      const handlePreviewQuiz = (test) => {
        setPreviewQuiz(JSON.parse(JSON.stringify(test)));
        setCurrentPage('preview');
      };
      
      const handlePaperPreview = (test) => {
        setPaperPreviewTest(test);
        setCurrentPage('paperPreview');
      };

      const handleClosePreview = () => {
        setPreviewQuiz(null);
        setCurrentPage('dashboard');
        setCurrentQuestionIndex(0);
      };

      const formatTime = (seconds) => {
          if (isNaN(seconds) || seconds < 0) return "00:00";
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      };

      const renderLandingPage = () => (
        <div className="flex flex-col items-center justify-center min-h-screen animated-gradient text-center p-4 relative" dir="rtl">
          <div className="absolute top-8 left-1/2 -translate-x-1/2 bg-white p-2 rounded-full shadow-lg">
              <img 
                src="https://fv5-6.files.fm/thumb_show.php?i=w64km6762j&view&v=1&PHPSESSID=e461ec3f0d0a2a9d0d6628b7d393e3c11f2d88b9" 
                alt="شعار" 
                className="h-48 w-48 rounded-full object-contain"
                onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/192x192/FFFFFF/000000?text=شعار" }}
              />
          </div>
          <h1 className="text-5xl font-bold text-white mb-4 drop-shadow-lg mt-72">أهلاً بك في منصة الاختبارات</h1>
          <p className="text-xl text-gray-200 mb-12 drop-shadow-md">اختر طريقة الدخول للمتابعة</p>
          <div className="flex flex-col space-y-6 items-center">
             <button 
              onClick={() => { setLoginRole('student'); setCurrentPage('login'); }} 
              className="bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-10 rounded-full text-xl transition duration-300 transform hover:scale-105 shadow-lg backdrop-blur-sm border border-white/30 w-64 flex items-center justify-center space-x-3"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>
              <span>الدخول كمستخدم</span>
            </button>
            <button 
              onClick={() => { setLoginRole('teacher'); setCurrentPage('login'); }} 
              className="bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-10 rounded-full text-xl transition duration-300 transform hover:scale-105 shadow-lg backdrop-blur-sm border border-white/30 w-64 flex items-center justify-center space-x-3"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
              <span>الدخول كمطور</span>
            </button>
          </div>
          <footer className="absolute bottom-4 text-white/70 text-sm">
            &copy; 1447 هـ - جميع الحقوق محفوظة لمنصة الاختبارات الإلكترونية.
          </footer>
        </div>
      );

      const renderLoginPage = () => (
        <div className={`flex items-center justify-center min-h-screen ${
            loginRole === 'teacher' 
            ? 'animated-gradient-developer' 
            : loginRole === 'student' 
            ? 'animated-gradient-student' 
            : 'bg-slate-100 dark:bg-slate-900'
        }`} dir="rtl">
            <div className="absolute top-4 left-4">
                <SettingsDropdown 
                    setDarkMode={setDarkMode} 
                    darkMode={darkMode}
                    handleReturnToLanding={handleReturnToLanding}
                    onShowInfo={() => setShowInfoModal(true)}
                />
            </div>
          <div className="w-full max-w-md">
              <div className="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-8 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold text-center text-slate-900 dark:text-white mb-6">
                  تسجيل الدخول - {loginRole === 'teacher' ? 'مطور' : 'مستخدم'}
                </h2>
                {loginError && <p className="text-red-500 text-center mb-4">{loginError}</p>}
                {loginRole === 'teacher' ? (
                  <div>
                    <input
                      type="text"
                      placeholder="اسم المستخدم"
                      value={devUsername}
                      onChange={(e) => setDevUsername(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <input
                      type="password"
                      placeholder="كلمة المرور"
                      value={devPassword}
                      onChange={(e) => setDevPassword(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                ) : (
                  <div>
                    <input
                      type="text"
                      placeholder="اسم المستخدم"
                      value={userUsernameInput}
                      onChange={(e) => setUserUsernameInput(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <input
                      type="text"
                      placeholder="رمز الدخول"
                      value={userAccessCodeInput}
                      onChange={(e) => setUserAccessCodeInput(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                )}
                <button onClick={handleLogin} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-300">
                  دخول
                </button>
                <button onClick={handleReturnToLanding} className="w-full mt-4 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 rounded-lg transition duration-300">
                  العودة
                </button>
              </div>
          </div>
        </div>
      );
      
      // Main Developer Dashboard Container
      const renderTeacherDashboard = () => (
        <div className="min-h-screen text-slate-900 dark:text-slate-100 p-4 sm:p-8">
            <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-8">
                    <h1 className="text-3xl font-bold">مرحباً بك، {currentUser.username}</h1>
                    <SettingsDropdown 
                        setDarkMode={setDarkMode} 
                        darkMode={darkMode}
                        handleReturnToLanding={handleReturnToLanding}
                        onShowInfo={() => setShowInfoModal(true)}
                    />
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-2 order-2 lg:order-1">
                        {devPage === 'dashboard' && <MainDashboard 
                          currentUser={currentUser}
                          setDevPage={setDevPage}
                          devUsernameToGenerate={devUsernameToGenerate}
                          setDevUsernameToGenerate={setDevUsernameToGenerate}
                          handleGenerateAccessCode={handleGenerateAccessCode}
                          showCreateTestForm={showCreateTestForm}
                          setShowCreateTestForm={setShowCreateTestForm}
                          setNewTestCategory={setNewTestCategory}
                          editingTestId={editingTestId}
                          newTestCategory={newTestCategory}
                          newTestTitle={newTestTitle}
                          setNewTestTitle={setNewTestTitle}
                          newTestDuration={newTestDuration}
                          setNewTestDuration={setNewTestDuration}
                          newTestMaxAttempts={newTestMaxAttempts}
                          setNewTestMaxAttempts={setNewTestMaxAttempts}
                          newTestPrerequisite={newTestPrerequisite}
                          setNewTestPrerequisite={setNewTestPrerequisite}
                          newTestDifficulty={newTestDifficulty}
                          setNewTestDifficulty={setNewTestDifficulty}
                          newTestQuestions={newTestQuestions}
                          handleDragStart={handleDragStart}
                          handleDragEnter={handleDragEnter}
                          handleUpdateQuestion={handleUpdateQuestion}
                          handleUpdateOption={handleUpdateOption}
                          handleUpdateCorrectAnswer={handleUpdateCorrectAnswer}
                          handleDeleteQuestion={handleDeleteQuestion}
                          handleAddQuestion={handleAddQuestion}
                          handleSaveNewTest={handleSaveNewTest}
                          resetCreateTestForm={resetCreateTestForm}
                          testsData={testsData}
                          activeTestTab={activeTestTab}
                          setActiveTestTab={setActiveTestTab}
                          dragTest={dragTest}
                          dragOverTest={dragOverTest}
                          handleTestSort={handleTestSort}
                          handlePreviewQuiz={handlePreviewQuiz}
                          handlePaperPreview={handlePaperPreview}
                          handleEditTest={handleEditTest}
                          handleDeleteTest={handleDeleteTest}
                          levels={levels}
                          handleAddNewLevel={handleAddNewLevel}
                          handleMoveTest={handleMoveTest}
                          handleDeleteLevel={handleDeleteLevel}
                          handleUpdateLevel={handleUpdateLevel}
                          createTestFormRef={createTestFormRef}
                          saveButtonContainerRef={saveButtonContainerRef}
                          onTriggerImport={handleTriggerImport}
                          onShowExportModal={() => setShowExportModal(true)}
                        />}
                        {devPage === 'users' && <UserManagementPage 
                           currentUser={currentUser}
                           setDevPage={setDevPage}
                           usersData={usersData}
                           handleShowUserScores={handleShowUserScores}
                           handleToggleUserRole={handleToggleUserRole}
                           handleDeleteUser={handleDeleteUser}
                           handleSectionPermissionChange={handleSectionPermissionChange}
                           handleDeleteSelectedUsers={handleDeleteSelectedUsers}
                           handleResetAttemptsForSelectedUsers={handleResetAttemptsForSelectedUsers}
                           blacklist={blacklist}
                           handleAddToBlacklist={handleAddToBlacklist}
                           handleRemoveFromBlacklist={handleRemoveFromBlacklist}
                           handleExportAllUsers={handleExportAllUsers}
                           handleTriggerBlacklistImport={handleTriggerBlacklistImport}
                        />}
                        {devPage === 'results' && <ResultsManagementPage 
                            setDevPage={setDevPage} 
                            usersData={usersData} 
                            testsData={testsData}
                        />}
                    </div>
                    <div className="lg:col-span-1 order-1 lg:order-2">
                        <Leaderboard users={usersData} />
                    </div>
                </div>
            </div>
        </div>
      );
      
      // Render Student Dashboard
      const renderStudentDashboard = () => {
        if (!isDataLoaded) {
            return <div className="min-h-screen flex items-center justify-center"><p>جاري تحميل البيانات...</p></div>;
        }

        const currentUserData = usersData.find(u => u.id === currentUser.id);
        
        if (!currentUserData || currentUserData.role !== 'student') {
            return (
                <div className="min-h-screen flex items-center justify-center">
                    <p>خطأ في تحميل بيانات المستخدم. الرجاء محاولة تسجيل الدخول مرة أخرى.</p>
                </div>
            );
        }

        const allowedSections = currentUserData.allowedSections || ['كمي', 'لفظي'];
        const allTests = [
            ...(allowedSections.includes('كمي') ? (testsData['كمي'] || []) : []),
            ...(allowedSections.includes('لفظي') ? (testsData['لفظي'] || []) : [])
        ];
        
        const levelsForCategory = (category) => levels
            .filter(l => l.category === category)
            .sort((a,b) => (a.order || 0) - (b.order || 0));
            
        const testsByLevel = (category) => {
            const grouped = {};
            levelsForCategory(category).forEach(l => grouped[l.id] = []);
            
            allTests.filter(t => t.category === category).forEach(test => {
                if (test.levelId && grouped[test.levelId]) {
                    grouped[test.levelId].push(test);
                }
            });
            return grouped;
        };
        
        const allAttempts = Object.values(currentUserData.scores).flat();
        const completedTestsCount = Object.keys(currentUserData.scores).length;

        const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
        const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
        const overallPercentage = totalPossible > 0 ? parseFloat(((totalScored / totalPossible) * 100).toFixed(2)) : 0;

        const highestScore = allAttempts.length > 0
            ? Math.max(...allAttempts.map(attempt => (attempt.total > 0 ? (attempt.score / attempt.total) * 100 : 0)))
            : 0;

        const totalTimeInSeconds = allAttempts.reduce((acc, attempt) => acc + (attempt.timeTaken || 0), 0);
        const hours = Math.floor(totalTimeInSeconds / 3600);
        const minutes = Math.floor((totalTimeInSeconds % 3600) / 60);
        const totalTimeSpentFormatted = `${hours} س ${minutes} د`;
        
        const incorrectQuestionsCount = currentUserData.incorrectQuestions?.length || 0;

        const renderCategoryTests = (category) => (
            <div>
                <h3 className="text-2xl font-bold mb-4 text-center">{category}</h3>
                <div className="space-y-4">
                {levelsForCategory(category).length > 0 ? (
                    levelsForCategory(category).map(level => {
                        const testsInLevel = testsByLevel(category)[level.id] || [];
                        if (testsInLevel.length === 0) return null;
                        return (
                            <div key={level.id} className="mb-2">
                                <button onClick={() => setOpenLevel(openLevel === level.id ? null : level.id)} className="w-full text-right bg-slate-100 dark:bg-slate-700 p-3 rounded-lg font-bold flex justify-between items-center">
                                    <span>{level.name}</span>
                                    <span>{openLevel === level.id ? '−' : '+'}</span>
                                </button>
                                {openLevel === level.id && (
                                    <div className="grid grid-cols-1 gap-6 p-4">
                                        {testsInLevel.map(test => {
                                            const attemptsLeft = currentUserData.attemptsLeft[test.id] !== undefined ? currentUserData.attemptsLeft[test.id] : test.maxAttempts;
                                            const prerequisite = test.prerequisitePercentage || 0;
                                            const isLocked = overallPercentage < prerequisite;

                                            return (
                                                <div key={test.id} className={`p-4 rounded-lg border ${isLocked ? 'bg-slate-200 dark:bg-slate-700' : 'bg-slate-50 dark:bg-slate-600'} dark:border-slate-500`}>
                                                    <h3 className="text-lg font-bold">{test.title}</h3>
                                                    <p>المدة: {test.duration} دقيقة</p>
                                                    <p>المحاولات المتبقية: {attemptsLeft}</p>
                                                    {isLocked && <p className="text-sm text-red-500 mt-1">مغلق (يتطلب {prerequisite}% للوصول)</p>}
                                                    <button 
                                                        onClick={() => handleStartTest(test.id)}
                                                        disabled={attemptsLeft <= 0 || isLocked}
                                                        className="mt-4 w-full bg-blue-500 text-white p-2 rounded-lg disabled:bg-slate-400 disabled:cursor-not-allowed">
                                                        {isLocked ? 'مغلق' : (attemptsLeft > 0 ? 'ابدأ الاختبار' : 'لا توجد محاولات')}
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        );
                    })
                ) : (
                    <p className="text-center text-slate-500 dark:text-slate-400">لا توجد اختبارات متاحة في هذا القسم.</p>
                )}
                </div>
            </div>
        );


        return (
          <div className="min-h-screen text-slate-900 dark:text-slate-100 p-4 sm:p-8">
            <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-8 pb-4 border-b dark:border-slate-700">
                  <div>
                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-200">أهلاً بعودتك، {currentUser.username}!</h1>
                    <p className="text-gray-500 dark:text-gray-400">لدينا ملخص جديد لأدائك.</p>
                  </div>
                    <SettingsDropdown 
                        setDarkMode={setDarkMode} 
                        darkMode={darkMode}
                        handleReturnToLanding={handleReturnToLanding}
                        onShowInfo={() => setShowInfoModal(true)}
                    />
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div className="lg:col-span-2 bg-slate-50 dark:bg-slate-800 p-6 rounded-xl">
                        <h2 className="text-xl font-bold text-gray-700 dark:text-gray-200 mb-6">ملخص الأداء</h2>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <StatCard title="الاختبارات المكتملة" value={completedTestsCount} />
                            <StatCard title="متوسط الدرجات" value={`${overallPercentage.toFixed(0)}%`} />
                            <StatCard title="أعلى درجة" value={`${highestScore.toFixed(0)}%`} />
                            <StatCard title="الوقت المستغرق" value={totalTimeSpentFormatted} />
                        </div>
                    </div>

                    <div className="lg:col-span-1 bg-green-600 text-white p-6 rounded-xl flex flex-col items-center justify-center text-center">
                        <h2 className="text-xl font-bold mb-4">النسبة الكلية</h2>
                        <AnimatedProgressCircle percentage={overallPercentage} />
                        <p className="mt-4 text-green-100">
                            {overallPercentage >= 85 ? 'أداء ممتاز، استمر!' : 'واصل التقدم، يمكنك فعل ما هو أفضل!'}
                        </p>
                    </div>
                </div>
                
                <div className="bg-yellow-100 dark:bg-yellow-900/50 border-r-4 border-yellow-500 p-6 rounded-xl shadow-lg mb-8">
                   <h2 className="text-2xl font-bold mb-2 text-yellow-800 dark:text-yellow-300">الأسئلة الصعبة</h2>
                   <p className="text-yellow-700 dark:text-yellow-400 mb-4">
                       هنا تجد جميع الأسئلة التي أخطأت فيها. قم بحلها لإزالتها من القائمة.
                   </p>
                   <p className="font-semibold mb-4">عدد الأسئلة: {incorrectQuestionsCount}</p>
                   <button 
                        onClick={handleStartIncorrectTest}
                        disabled={incorrectQuestionsCount === 0}
                        className="w-full bg-yellow-500 text-white p-3 rounded-lg disabled:bg-slate-400 disabled:cursor-not-allowed font-bold"
                    >
                       {incorrectQuestionsCount > 0 ? 'ابدأ اختبار الأسئلة الصعبة' : 'لا توجد أسئلة صعبة حالياً'}
                   </button>
                </div>

                <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
                  <h2 className="text-2xl font-bold mb-4 text-center">الاختبارات المتاحة</h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    { allowedSections.includes('كمي') && renderCategoryTests('كمي') }
                    { allowedSections.includes('لفظي') && renderCategoryTests('لفظي') }
                  </div>
                </div>

            </div>
          </div>
        );
      };

      const renderPreviewPage = () => {
        if (!previewQuiz) return null;
        const question = previewQuiz.questions[currentQuestionIndex];
        const isFirstQuestion = currentQuestionIndex === 0;
        const isLastQuestion = currentQuestionIndex === previewQuiz.questions.length - 1;

        return (
          <div className="flex flex-col items-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl mt-10">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">{previewQuiz.title}</h1>
                <button onClick={handleClosePreview} className="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-xl transition duration-300">
                    إغلاق المعاينة
                </button>
              </div>

              <div className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600">
                {question.imageUrl && <img src={question.imageUrl} alt={`صورة للسؤال رقم ${currentQuestionIndex + 1}`} className="w-full max-h-60 object-contain rounded-lg mb-4"/>}
                <p className="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                  {currentQuestionIndex + 1}. {question.text}
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {question.options.map(option => (
                    <div key={option.id} className={`flex flex-col items-center justify-center p-4 rounded-lg border-2 ${question.correctAnswer === option.id ? 'bg-green-100 dark:bg-green-900 border-green-500' : 'bg-white dark:bg-slate-800'}`}>
                      {option.imageUrl && <img src={option.imageUrl} className="w-24 h-24 object-contain rounded-md mb-2" />}
                      <span className="text-slate-900 dark:text-white text-center font-bold">{option.text}</span>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="mt-8 flex justify-between">
                <button onClick={() => setCurrentQuestionIndex(prev => prev - 1)} disabled={isFirstQuestion} className={`bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md ${isFirstQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}>
                  السابق
                </button>
                <button onClick={() => setCurrentQuestionIndex(prev => prev + 1)} disabled={isLastQuestion} className={`bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md ${isLastQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}>
                  التالي
                </button>
              </div>
            </div>
          </div>
        );
      };
      
      const renderPaperPreviewPage = () => {
        if (!paperPreviewTest) return null;

        return (
          <div className="bg-slate-200 dark:bg-slate-900 min-h-screen py-10" dir="rtl">
            <div className="no-print flex justify-center mb-4 space-x-4 rtl:space-x-reverse">
                 <button onClick={() => window.print()} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl">
                    طباعة
                 </button>
                 <button onClick={() => { setCurrentPage('dashboard'); setPaperPreviewTest(null); }} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl">
                    إغلاق
                 </button>
            </div>
            <div id="paper-preview" className="a4-page text-black">
                <div className="border-b-2 border-black pb-4 mb-8 text-center">
                    <h1 className="text-3xl font-bold mb-2">{paperPreviewTest.title}</h1>
                    <p className="text-lg">المدة: {paperPreviewTest.duration} دقيقة</p>
                </div>
                <div className="space-y-8">
                    {paperPreviewTest.questions.map((question, qIndex) => (
                        <div key={question.id} className="question-block" style={{breakInside: 'avoid-page'}}>
                            <div className="flex items-start mb-4">
                                <span className="font-bold ml-2">{qIndex + 1}.</span>
                                <div className="flex-1">
                                    <p className="text-xl font-semibold"><MathComponent text={question.text} /></p>
                                    {question.imageUrl && <img src={question.imageUrl} alt={`صورة للسؤال`} className="max-w-[220px] my-2 rounded-lg"/>}
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-x-8 gap-y-4 pr-6">
                                {question.options.map((option, oIndex) => {
                                    const optionLabels = ['أ', 'ب', 'ج', 'د'];
                                    return (
                                        <div key={option.id} className="flex items-center">
                                            <span className="font-bold w-8 mr-3">{optionLabels[oIndex]})</span>
                                            <div className="flex-1">
                                                {option.imageUrl ? (
                                                    <img src={option.imageUrl} className="max-w-[80px] max-h-[80px] rounded" />
                                                ) : (
                                                    <p className="text-lg"><MathComponent text={option.text} /></p>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
          </div>
        );
    };

      const renderTestPage = () => {
        if (!selectedTest) return null;
        const question = selectedTest.questions[currentQuestionIndex];
        const isFirstQuestion = currentQuestionIndex === 0;
        const isLastQuestion = currentQuestionIndex === selectedTest.questions.length - 1;

        return (
          <div className="flex flex-col items-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl mt-10">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">{selectedTest.title}</h1>
                <div className="flex items-center space-x-4">
                   <button 
                     onClick={() => {
                        if (window.confirm("هل أنت متأكد من رغبتك في الخروج؟ سيتم فقدان تقدمك.")) {
                            setCurrentPage('dashboard');
                        }
                    }}
                    className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl"
                   >
                     مغادرة الاختبار
                   </button>
                  <div className="bg-red-100 text-red-700 px-4 py-2 rounded-full font-bold">
                    متبقي: {formatTime(timer)}
                  </div>
                </div>
              </div>

              <div className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600">
                {question.imageUrl && <img src={question.imageUrl} alt={`صورة للسؤال رقم ${currentQuestionIndex + 1}`} className="w-full max-h-60 object-contain rounded-lg mb-4"/>}
                <p className="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                  {currentQuestionIndex + 1}. {question.text}
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {question.options.map(option => (
                    <label key={option.id} onClick={() => handleAnswerChange(question.id, option.id)} className={`flex flex-col items-center justify-center cursor-pointer p-4 rounded-lg border-2 transition duration-200 ${answers[question.id] === option.id ? 'bg-blue-100 dark:bg-blue-900 border-blue-500' : 'bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                      {option.imageUrl && <img src={option.imageUrl} className="w-24 h-24 object-contain rounded-md mb-2" />}
                      <span className="text-slate-900 dark:text-white text-center font-bold">{option.text}</span>
                    </label>
                  ))}
                </div>
              </div>
              
              <div className="mt-8 flex justify-between">
                <button onClick={handlePreviousQuestion} disabled={isFirstQuestion} className={`bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md ${isFirstQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}>
                  السابق
                </button>
                {isLastQuestion ? (
                  <button onClick={handleSubmitTest} disabled={quizSubmitted} className={`bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md ${quizSubmitted ? 'opacity-50 cursor-not-allowed' : ''}`}>
                    إرسال الاختبار
                  </button>
                ) : (
                  <button onClick={handleNextQuestion} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md">
                    التالي
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      };

      const renderResultsPage = () => {
        if (!selectedTest) return null;
        let score = 0;
        let totalQuestions = selectedTest.questions.length;
        selectedTest.questions.forEach(q => {
          if (answers[q.id] === q.correctAnswer) score++;
        });
        
        const percentage = totalQuestions > 0 ? (score / totalQuestions) * 100 : 0;
        
        const ScoreIndicator = () => {
            if (percentage >= 80) return <span className="text-green-500 text-2xl ml-2">✅</span>;
            if (percentage >= 60) return <span className="text-orange-500 text-2xl ml-2">⚠️</span>;
            if (percentage >= 50) return <span className="text-red-500 text-2xl ml-2">❌</span>;
            return <span className="text-slate-500 text-2xl ml-2">⚪️</span>;
        };

        return (
          <div className="flex flex-col items-center justify-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl text-center">
              <div className="absolute top-4 left-4">
                <SettingsDropdown 
                    setDarkMode={setDarkMode} 
                    darkMode={darkMode}
                    handleReturnToLanding={handleReturnToLanding}
                    onShowInfo={() => setShowInfoModal(true)}
                />
              </div>
              <h1 className="text-3xl font-bold mb-6 text-slate-900 dark:text-white">نتائج الاختبار</h1>
              <p className="text-xl text-slate-600 dark:text-slate-300 mb-8">
                لقد أنهيت اختبار: <span className="font-semibold text-blue-500">{selectedTest.title}</span>
              </p>

              <div className="mb-8 flex items-center justify-center">
                <p className="text-2xl font-bold text-slate-900 dark:text-white">
                  درجتك: <span className="text-green-500">{score}</span> / <span className="text-blue-500">{totalQuestions}</span>
                </p>
                <ScoreIndicator />
              </div>
              
              <div className="text-right">
                {selectedTest.questions.map((question, qIndex) => (
                  <div key={question.id} className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600 text-right">
                    {question.imageUrl && <img src={question.imageUrl} alt={`صورة للسؤال رقم ${qIndex + 1}`} className="w-full max-h-60 object-contain rounded-lg mb-4"/>}
                    <p className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                      {qIndex + 1}. <MathComponent text={question.text} />
                    </p>
                    <div className="mt-2 text-slate-700 dark:text-slate-300">
                      <p className={`mb-1 ${answers[question.id] === question.correctAnswer ? 'text-green-600' : 'text-red-600'}`}>
                        <span className="font-bold">إجابتك:</span> <MathComponent text={question.options.find(opt => opt.id === answers[question.id])?.text || 'لم يتم الإجابة'} />
                      </p>
                      <p>
                        <span className="font-bold text-green-600 dark:text-green-400">الإجابة الصحيحة:</span> <MathComponent text={question.options.find(opt => opt.id === question.correctAnswer)?.text} />
                      </p>
                    </div>
                  </div>
                ))}
              </div>

              <button onClick={() => setCurrentPage('dashboard')} className="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105 shadow-md">
                العودة إلى لوحة التحكم
              </button>
            </div>
          </div>
        );
      };

      const UserScoresModal = ({ user, onClose, onResetAttempt, allTests }) => {
          if (!user) return null;
          
          const allUserTests = Array.from(new Set(Object.keys(user.scores).concat(Object.keys(user.attemptsLeft))));

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-4xl w-full text-slate-900 dark:text-slate-100">
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="text-xl font-bold">بيانات المستخدم: {user.username}</h3>
                          <button onClick={onClose} className="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white">&times;</button>
                      </div>
                      
                      <div className="max-h-96 overflow-y-auto">
                          <table className="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                              <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                                  <tr>
                                      <th scope="col" className="px-6 py-3">الاختبار</th>
                                      <th scope="col" className="px-6 py-3">الدرجات (التاريخ والوقت)</th>
                                      <th scope="col" className="px-6 py-3">المحاولات المتبقية</th>
                                      <th scope="col" className="px-6 py-3">إجراء</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {allUserTests.length > 0 ? allUserTests.map(testId => {
                                      const test = allTests.find(t => t.id == testId);
                                      if (!test) return null;
                                      const scoresForTest = user.scores[testId] || [];
                                      const attemptsLeftForTest = user.attemptsLeft[test.id] !== undefined ? user.attemptsLeft[test.id] : test.maxAttempts;

                                      return (
                                          <tr key={test.id} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700">
                                              <th scope="row" className="px-6 py-4 font-medium text-slate-900 dark:text-white whitespace-nowrap">{test.title}</th>
                                              <td className="px-6 py-4">
                                                  {scoresForTest.length > 0 ? scoresForTest.map((scoreData, index) => (
                                                      <div key={index} className="text-xs">
                                                          {scoreData.score}/{scoreData.total} - {scoreData.date} ({formatTime(scoreData.timeTaken)})
                                                      </div>
                                                  )) : "لا توجد درجات"}
                                              </td>
                                              <td className="px-6 py-4">{attemptsLeftForTest}</td>
                                              <td className="px-6 py-4">
                                                  <button onClick={() => onResetAttempt(user.id, test.id)} className="text-blue-500 hover:underline text-xs">
                                                      تجديد المحاولة
                                                  </button>
                                              </td>
                                          </tr>
                                      );
                                  }) : (
                                      <tr><td colSpan="4" className="text-center py-4">لا توجد بيانات اختبارات لهذا المستخدم.</td></tr>
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          );
      };
      
      // Render the correct page based on the current state
      const renderCurrentPage = () => {
        switch (currentPage) {
          case 'landing': return renderLandingPage();
          case 'login': return renderLoginPage();
          case 'dashboard': 
            const isPrivilegedUser = currentUser?.role === 'teacher' || currentUser?.role === 'supervisor' || currentUser?.role === 'superadmin';
            return isPrivilegedUser ? renderTeacherDashboard() : renderStudentDashboard();
          case 'test': return renderTestPage();
          case 'results': return renderResultsPage();
          case 'preview': return renderPreviewPage();
          case 'paperPreview': return renderPaperPreviewPage();
          default: return renderLandingPage();
        }
      };
      
      const allTests = useMemo(() => [...(testsData['كمي'] || []), ...(testsData['لفظي'] || [])], [testsData]);

      return (
        <div className="font-sans">
          <input 
              type="file" 
              ref={importFileRef} 
              style={{ display: 'none' }} 
              accept=".json" 
              onChange={handleFileImport} 
          />
          <input 
              type="file" 
              ref={blacklistImportFileRef} 
              style={{ display: 'none' }} 
              accept=".json" 
              onChange={handleBlacklistFileImport} 
          />
          {renderCurrentPage()}
          {showInfoModal && <SiteInfoModal onClose={() => setShowInfoModal(false)} />}
          {showUserScores && <UserScoresModal user={userScoresToShow} onClose={handleCloseUserScores} onResetAttempt={handleResetSingleTestAttempts} allTests={allTests} />}
          {showExportModal && <ExportModal tests={allTests} onClose={() => setShowExportModal(false)} onExport={handleExportTest} />}
        </div>
      );
    }
    
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

