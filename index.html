<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ§Ù„ØªÙ‚ÙˆÙŠÙ…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .animated-gradient {
      background: linear-gradient(-45deg, #0d47a1, #00796b, #00bfa5, #1e88e5);
      background-size: 400% 400%;
      animation: gradient-animation 15s ease infinite;
    }
    .dragging-over {
        border-top: 2px solid #3b82f6; /* blue-500 */
    }
     .main-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        align-items: flex-start;
      }
      @media (max-width: 1024px) {
        .main-container {
            grid-template-columns: 1fr;
        }
      }
      .c-graph__title {
        font-size: 26px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 2rem;
        text-align: center;
        grid-column: 1 / -1; /* Span across all columns */
      }
      .chart-container {
        position: relative;
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .c-graph__bar {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
      }
      .c-graph__bar.highlighted {
        fill: #a78bfa; /* A lighter purple for highlight */
      }
      .axis-line { stroke: #e2e8f0; stroke-width: 1; }
      #tooltip {
        position: absolute;
        background-color: rgba(15, 23, 42, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s, transform 0.2s;
        transform: translate(-50%, -110%);
        white-space: nowrap;
      }
      .table-container {
        max-height: 550px;
        overflow-y: auto;
        background-color: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      /* Custom scrollbar */
      .table-container::-webkit-scrollbar { width: 8px; }
      .table-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 1rem; }
      .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 1rem; }
      .table-container::-webkit-scrollbar-thumb:hover { background: #a8b2c1; }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <!-- MathJax Configuration -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    window.firebase = { initializeApp, getFirestore, doc, onSnapshot, setDoc, collection, addDoc, updateDoc, deleteDoc };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;
    const { createRoot } = ReactDOM;

    // --| Firebase Configuration | --
    const firebaseConfig = {
      apiKey: "AIzaSyDAqNYMF5H8I1jCJfDwZ5PI_qztLx1MS14",
      authDomain: "bungus-78fc6.firebaseapp.com",
      projectId: "bungus-78fc6",
      storageBucket: "bungus-78fc6.appspot.com",
      messagingSenderId: "546709528555",
      appId: "1:546709528555:web:dbed8e2e70d77ed532c3ae",
      measurementId: "G-1LB7LVN38E"
    };

    // Initialize Firebase
    let app, db;
    try {
        app = window.firebase.initializeApp(firebaseConfig);
        db = window.firebase.getFirestore(app);
    } catch (e) {
        console.error("Firebase initialization error:", e);
    }

    const MathComponent = ({ text }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (window.MathJax && ref.current) {
          window.MathJax.typesetPromise([ref.current]);
        }
      }, [text]);

      return <span ref={ref}>{text}</span>;
    };
    
    // =================================================================
    // =========== START: NEW STANDALONE COMPONENTS ====================
    // =================================================================

    const MainDashboard = ({
      setDevPage,
      devUsernameToGenerate,
      setDevUsernameToGenerate,
      handleGenerateAccessCode,
      showCreateTestForm,
      setShowCreateTestForm,
      setNewTestCategory,
      editingTestId,
      newTestCategory,
      newTestTitle,
      setNewTestTitle,
      newTestDuration,
      setNewTestDuration,
      newTestMaxAttempts,
      setNewTestMaxAttempts,
      newTestPrerequisite,
      setNewTestPrerequisite,
      newTestQuestions,
      handleDragStart,
      handleDragEnter,
      handleUpdateQuestion,
      handleUpdateOption,
      handleUpdateCorrectAnswer,
      handleDeleteQuestion,
      handleAddQuestion,
      handleSaveNewTest,
      resetCreateTestForm,
      testsData,
      activeTestTab,
      setActiveTestTab,
      dragTest,
      dragOverTest,
      handleTestSort,
      handlePreviewQuiz,
      handleEditTest,
      handleDeleteTest
    }) => {
      return (
        <div className="space-y-8">
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
                <div className="flex items-center mb-4 space-x-4 rtl:space-x-reverse">
                    <input
                        type="text"
                        placeholder="Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯"
                        value={devUsernameToGenerate}
                        onChange={(e) => setDevUsernameToGenerate(e.target.value)}
                        className="p-2 border rounded-lg flex-grow bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-slate-600"
                    />
                    <button onClick={() => handleGenerateAccessCode(devUsernameToGenerate)} className="bg-green-500 text-white py-2 px-4 rounded-lg">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„</button>
                </div>
                <div className="flex flex-col space-y-2 items-start">
                    <button onClick={() => setDevPage('users')} className="text-blue-500 hover:underline">
                        Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† &larr;
                    </button>
                    <button onClick={() => setDevPage('results')} className="text-blue-500 hover:underline">
                        Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„ÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† &larr;
                    </button>
                </div>
            </div>

            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
              <h2 className="text-2xl font-bold mb-4">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±</h2>
              {!showCreateTestForm ? (
                  <div className="flex space-x-4 rtl:space-x-reverse">
                      <button onClick={() => { setShowCreateTestForm(true); setNewTestCategory('ÙƒÙ…ÙŠ'); }} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                          Ø§Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø± ÙƒÙ…ÙŠ
                      </button>
                      <button onClick={() => { setShowCreateTestForm(true); setNewTestCategory('Ù„ÙØ¸ÙŠ'); }} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">
                          Ø§Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø± Ù„ÙØ¸ÙŠ
                      </button>
                  </div>
              ) : (
                  <div>
                      <h3 className="text-xl font-semibold mb-4">{editingTestId ? `ØªØ¹Ø¯ÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± ${newTestCategory}` : `Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø± ${newTestCategory} Ø¬Ø¯ÙŠØ¯`}</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                          <input type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±" value={newTestTitle} onChange={(e) => setNewTestTitle(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                          <input type="number" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)" value={newTestDuration} onChange={(e) => setNewTestDuration(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                          <input type="number" placeholder="Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª" value={newTestMaxAttempts} onChange={(e) => setNewTestMaxAttempts(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                          <input type="number" placeholder="Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (%)" value={newTestPrerequisite} onChange={(e) => setNewTestPrerequisite(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                      </div>
                      {newTestQuestions.map((q, qIndex) => (
                          <div 
                            key={q.id} 
                            className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg mb-4 border dark:border-slate-600"
                          >
                            <div 
                                className="cursor-grab"
                                draggable
                                onDragStart={(e) => handleDragStart(e, qIndex)}
                                onDragEnter={(e) => handleDragEnter(e, qIndex)}
                            >
                              <h4 className="font-bold mb-2">Ø§Ù„Ø³Ø¤Ø§Ù„ {qIndex + 1}</h4>
                              <textarea value={q.text} onChange={(e) => handleUpdateQuestion(qIndex, 'text', e.target.value)} placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" className="w-full p-2 border rounded-lg mb-2 bg-white dark:bg-slate-600"></textarea>
                            </div>
                              <input
                                type="text"
                                placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
                                value={q.imageUrl}
                                onChange={(e) => handleUpdateQuestion(qIndex, 'imageUrl', e.target.value)}
                                className="w-full p-2 border rounded-lg mb-2 bg-white dark:bg-slate-600"
                              />
                              {q.imageUrl && <img src={q.imageUrl} className="w-32 h-32 object-cover rounded-lg my-2 mx-auto" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø¤Ø§Ù„"/>}
                              
                              {q.options.map((opt, oIndex) => (
                                  <div key={opt.id} className="flex items-center mb-2 bg-white dark:bg-slate-600 p-2 rounded-lg">
                                      <input type="radio" name={`correct-answer-${q.id}`} checked={q.correctAnswer === opt.id} onChange={() => handleUpdateCorrectAnswer(qIndex, opt.id)} className="ml-2"/>
                                      <input type="text" value={opt.text} onChange={(e) => handleUpdateOption(qIndex, oIndex, 'text', e.target.value)} placeholder={`Ø§Ù„Ø®ÙŠØ§Ø± ${String.fromCharCode(97 + oIndex)}`} className="p-2 border rounded-lg flex-grow bg-white dark:bg-slate-500"/>
                                      <input type="text" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù„Ù„Ø®ÙŠØ§Ø±" value={opt.imageUrl} onChange={(e) => handleUpdateOption(qIndex, oIndex, 'imageUrl', e.target.value)} className="p-2 border rounded-lg w-1/3 ml-2 bg-white dark:bg-slate-500"/>
                                      {opt.imageUrl && <img src={opt.imageUrl} className="w-16 h-16 object-cover rounded-md ml-2" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®ÙŠØ§Ø±"/>}
                                  </div>
                              ))}
                              <button onClick={() => handleDeleteQuestion(qIndex)} className="text-red-500 hover:text-red-700 text-xs mt-2">Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„</button>
                          </div>
                      ))}
                      <div className="flex space-x-4 rtl:space-x-reverse">
                          <button onClick={handleAddQuestion} className="bg-slate-200 dark:bg-slate-600 p-2 rounded-lg">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
                          <button onClick={handleSaveNewTest} className="bg-green-500 text-white p-2 rounded-lg">{editingTestId ? 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'}</button>
                          <button onClick={resetCreateTestForm} className="bg-red-500 text-white p-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                      </div>
                  </div>
              )}
            </div>
            
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
               <h2 className="text-2xl font-bold mb-4">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                <div className="border-b border-slate-200 dark:border-slate-700 mb-4">
                    <nav className="-mb-px flex space-x-8 rtl:space-x-reverse" aria-label="Tabs">
                        <button onClick={() => setActiveTestTab('ÙƒÙ…ÙŠ')} className={`${activeTestTab === 'ÙƒÙ…ÙŠ' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
                            ÙƒÙ…ÙŠ
                        </button>
                        <button onClick={() => setActiveTestTab('Ù„ÙØ¸ÙŠ')} className={`${activeTestTab === 'Ù„ÙØ¸ÙŠ' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
                            Ù„ÙØ¸ÙŠ
                        </button>
                    </nav>
                </div>
                
                <div>
                    {(testsData[activeTestTab]?.length ?? 0) === 0 ? (
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙÙŠ Ù‚Ø³Ù… {activeTestTab}.</p>
                    ) : (
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {testsData[activeTestTab].map((test, index) => (
                                <div 
                                    key={test.id} 
                                    className="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg border dark:border-slate-600 cursor-move"
                                    draggable
                                    onDragStart={() => dragTest.current = index}
                                    onDragEnter={() => dragOverTest.current = index}
                                    onDragEnd={handleTestSort}
                                    onDragOver={(e) => e.preventDefault()}
                                >
                                    <h4 className="text-lg font-bold">{test.title}</h4>
                                    <p>{test.questions.length} Ø£Ø³Ø¦Ù„Ø©</p>
                                    <div className="mt-4 flex space-x-2 rtl:space-x-reverse">
                                        <button onClick={() => handlePreviewQuiz(test)} className="flex-1 bg-blue-500 text-white p-2 rounded-lg">Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
                                        <button onClick={() => handleEditTest(test, activeTestTab)} className="flex-1 bg-yellow-500 text-white p-2 rounded-lg">ØªØ¹Ø¯ÙŠÙ„</button>
                                        <button onClick={() => handleDeleteTest(test.id)} className="flex-1 bg-red-500 text-white p-2 rounded-lg">Ø­Ø°Ù</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
      );
    };

    const UserManagementPage = ({ setDevPage, usersData, handleShowUserScores, handleToggleUserRole, handleDeleteUser, handleSectionPermissionChange }) => {
        const [userSearchTerm, setUserSearchTerm] = useState('');
        
        const filteredUsers = useMemo(() => usersData
            .filter(user => 
                user.username.toLowerCase().includes(userSearchTerm.toLowerCase())
            )
            .sort((a, b) => {
                if (a.role === 'teacher' && b.role !== 'teacher') return -1;
                if (a.role !== 'teacher' && b.role === 'teacher') return 1;
                return a.username.localeCompare(b.username);
            }), [usersData, userSearchTerm]);

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
                    <button onClick={() => setDevPage('dashboard')} className="text-blue-500 hover:underline">
                        &rarr; Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                </div>
                <div className="mb-4">
                    <input 
                        type="text"
                        placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…..."
                        value={userSearchTerm}
                        onChange={(e) => setUserSearchTerm(e.target.value)}
                        className="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg"
                    />
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                        <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                            <tr>
                                <th scope="col" className="px-6 py-3">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th scope="col" className="px-6 py-3">Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                                <th scope="col" className="px-6 py-3">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                                <th scope="col" className="px-6 py-3">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©</th>
                                <th scope="col" className="px-6 py-3 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredUsers.map(user => (
                                <tr key={user.username} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
                                    <td className="px-6 py-4 font-medium text-slate-900 dark:text-white">{user.username}</td>
                                    <td className="px-6 py-4">{user.accessCode}</td>
                                    <td className="px-6 py-4">
                                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${user.role === 'teacher' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300'}`}>
                                            {user.role === 'teacher' ? 'Ù…Ø·ÙˆØ±' : 'Ø·Ø§Ù„Ø¨'}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4">
                                        <div className="flex items-center space-x-4 rtl:space-x-reverse">
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    checked={user.allowedSections?.includes('ÙƒÙ…ÙŠ') ?? true} 
                                                    onChange={() => handleSectionPermissionChange(user.id, 'ÙƒÙ…ÙŠ')}
                                                    className="form-checkbox h-4 w-4 text-blue-600 rounded"
                                                />
                                                <span className="mr-2">ÙƒÙ…ÙŠ</span>
                                            </label>
                                            <label className="flex items-center">
                                                <input 
                                                    type="checkbox" 
                                                    checked={user.allowedSections?.includes('Ù„ÙØ¸ÙŠ') ?? true} 
                                                    onChange={() => handleSectionPermissionChange(user.id, 'Ù„ÙØ¸ÙŠ')}
                                                    className="form-checkbox h-4 w-4 text-green-600 rounded"
                                                />
                                                <span className="mr-2">Ù„ÙØ¸ÙŠ</span>
                                            </label>
                                        </div>
                                    </td>
                                    <td className="px-6 py-4 flex items-center justify-center space-x-2 rtl:space-x-reverse">
                                        <button onClick={() => handleShowUserScores(user)} title="Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" className="p-2 text-slate-500 hover:text-blue-600 dark:hover:text-blue-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fillRule="evenodd" d="M.458 10C3.732 4.943 9.522 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-9.064 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd" /></svg>
                                        </button>
                                        <button onClick={() => handleToggleUserRole(user.id)} title="Ø§Ø¬Ø¹Ù„Ù‡ Ù…Ø·ÙˆØ±" className="p-2 text-slate-500 hover:text-green-600 dark:hover:text-green-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>
                                        </button>
                                        <button onClick={() => handleDeleteUser(user.id)} title="Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" className="p-2 text-slate-500 hover:text-red-600 dark:hover:text-red-400">
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );
    };

    const ResultsChart = ({ data }) => {
        const containerRef = useRef(null);
        const [highlightedIndex, setHighlightedIndex] = useState(null);
        
        const renderChart = useCallback(() => {
            const container = containerRef.current;
            if (!container) return;
            container.innerHTML = '';
            
            let tooltip = document.getElementById('tooltip');
            if(!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'tooltip';
                document.body.appendChild(tooltip);
            }

            const padding = { top: 20, right: 10, bottom: 20, left: 10 };
            const containerWidth = container.clientWidth || 800;
            const containerHeight = 500;
            const chartWidth = containerWidth - padding.left - padding.right;
            const chartHeight = containerHeight - padding.top - padding.bottom;

            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', containerHeight);
            svg.setAttribute('viewBox', `0 0 ${containerWidth} ${containerHeight}`);

            const mainGroup = document.createElementNS(svgNS, 'g');
            mainGroup.setAttribute('transform', `translate(${padding.left}, ${padding.top})`);
            svg.appendChild(mainGroup);

            for(let i = 0; i <= 10; i++) {
                const y = chartHeight - (i * chartHeight / 10);
                const line = document.createElementNS(svgNS, 'line');
                line.setAttribute('class', 'axis-line');
                line.setAttribute('x1', 0);
                line.setAttribute('y1', y);
                line.setAttribute('x2', chartWidth);
                line.setAttribute('y2', y);
                mainGroup.appendChild(line);
            }

            const barWidth = data.length > 0 ? chartWidth / data.length * 0.8 : 0;
            const barSpacing = data.length > 0 ? chartWidth / data.length * 0.2 : 0;

            data.forEach((student, i) => {
                const barHeight = (student.score / 100) * chartHeight;
                const xPos = i * (barWidth + barSpacing);
                const yPos = chartHeight - barHeight;

                const rect = document.createElementNS(svgNS, 'rect');
                rect.setAttribute('class', 'c-graph__bar');
                rect.id = `student-bar-${i}`;
                rect.setAttribute('x', xPos);
                rect.setAttribute('y', yPos);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', '#6d28d9');
                rect.setAttribute('rx', '2');
                if (i === highlightedIndex) {
                    rect.classList.add('highlighted');
                }
                mainGroup.appendChild(rect);

                rect.addEventListener('mousemove', (e) => {
                    tooltip.style.opacity = '1';
                    tooltip.style.left = `${e.pageX}px`;
                    tooltip.style.top = `${e.pageY}px`;
                    tooltip.innerHTML = `<strong>${student.name}</strong><br>Ø§Ù„Ù†Ø³Ø¨Ø©: ${student.score}%`;
                });
                rect.addEventListener('mouseleave', () => {
                    tooltip.style.opacity = '0';
                });
            });
            container.appendChild(svg);
        }, [data, highlightedIndex]);

        useEffect(() => {
            renderChart();
            let resizeTimeout;
            const handleResize = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(renderChart, 250);
            };
            window.addEventListener('resize', handleResize);
            return () => window.removeEventListener('resize', handleResize);
        }, [renderChart]);

        return (
            <div className="w-full">
                <div id="graph-container" ref={containerRef} className="chart-container"></div>
                <div className="table-container mt-8">
                    <table className="w-full text-sm text-left text-gray-500">
                        <thead className="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                            <tr>
                                <th scope="col" className="px-6 py-3">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                <th scope="col" className="px-6 py-3">Ø§Ù„Ù†Ø³Ø¨Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((student, index) => (
                                <tr 
                                    key={index} 
                                    className="bg-white border-b hover:bg-gray-50"
                                    onMouseEnter={() => setHighlightedIndex(index)}
                                    onMouseLeave={() => setHighlightedIndex(null)}
                                >
                                    <td className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">{student.name}</td>
                                    <td className="px-6 py-4">{student.score}%</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                <div id="tooltip"></div>
            </div>
        );
    };

    const ResultsManagementPage = ({ setDevPage, usersData }) => {
        const studentResults = useMemo(() => {
            return usersData
                .filter(user => user.role === 'student')
                .map(user => {
                    const allAttempts = Object.values(user.scores).flat();
                    const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
                    const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
                    const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
                    return { name: user.username, score: parseFloat(overallPercentage.toFixed(2)) };
                })
                .sort((a, b) => b.score - a.score);
        }, [usersData]);

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
                    <button onClick={() => setDevPage('dashboard')} className="text-blue-500 hover:underline">
                        &rarr; Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                </div>
                <ResultsChart data={studentResults} />
            </div>
        );
    };

    const Leaderboard = ({ users, limit = 10 }) => {
        const leaderboardData = useMemo(() => {
            return users
                .filter(user => user.role === 'student') // Filter out teachers
                .map(user => {
                    const allAttempts = Object.values(user.scores).flat();
                    const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
                    const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
                    const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
                    return { username: user.username, score: overallPercentage.toFixed(2) };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, limit);
        }, [users]);

        const Medal = ({ rank }) => {
            if (rank === 0) return <span title="Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø£ÙˆÙ„" className="text-yellow-400">ğŸ¥‡</span>;
            if (rank === 1) return <span title="Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù†ÙŠ" className="text-slate-400">ğŸ¥ˆ</span>;
            if (rank === 2) return <span title="Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø«" className="text-yellow-600">ğŸ¥‰</span>;
            return <span className="text-slate-400">{rank + 1}</span>;
        };

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold mb-4 text-center">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
                <ul className="space-y-4">
                    {leaderboardData.map((user, index) => (
                        <li key={user.username} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                            <div className="flex items-center">
                                <span className="text-lg font-bold w-8 text-center"><Medal rank={index} /></span>
                                <span className="font-medium text-slate-900 dark:text-white">{user.username}</span>
                            </div>
                            <span className="font-bold text-blue-500">{user.score}%</span>
                        </li>
                    ))}
                </ul>
            </div>
        );
      };
    
    // =================================================================
    // ===========  END: NEW STANDALONE COMPONENTS  ====================
    // =================================================================


    function App() {
      const [testsData, setTestsData] = useState({ 'ÙƒÙ…ÙŠ': [], 'Ù„ÙØ¸ÙŠ': [] });
      const [usersData, setUsersData] = useState([]);
      const [isDataLoaded, setIsDataLoaded] = useState(false);

      useEffect(() => {
        if (!db) {
            console.error("ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Firebase. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯.");
            setIsDataLoaded(true);
            return;
        }
        const unsubscribeTests = window.firebase.onSnapshot(window.firebase.collection(db, "tests"), (snapshot) => {
            const newTestsData = { 'ÙƒÙ…ÙŠ': [], 'Ù„ÙØ¸ÙŠ': [] };
            snapshot.forEach(doc => {
                const test = { id: doc.id, ...doc.data() };
                if (newTestsData[test.category]) {
                    newTestsData[test.category].push(test);
                }
            });
            // Data is not sorted here anymore to allow manual sorting
            setTestsData(newTestsData);
        });

        const unsubscribeUsers = window.firebase.onSnapshot(window.firebase.collection(db, "users"), (snapshot) => {
            const newUsersData = [];
            snapshot.forEach(doc => {
                newUsersData.push({ id: doc.id, ...doc.data() });
            });
            setUsersData(newUsersData);
            setIsDataLoaded(true);
        });

        return () => {
            unsubscribeTests();
            unsubscribeUsers();
        };
      }, []);

      const [currentPage, setCurrentPage] = useState('landing');
      const [devPage, setDevPage] = useState('dashboard');
      const [loginRole, setLoginRole] = useState(null);
      const [currentUser, setCurrentUser] = useState(null);
      const [selectedTest, setSelectedTest] = useState(null);
      const [answers, setAnswers] = useState({});
      const [timer, setTimer] = useState(0);
      const [quizSubmitted, setQuizSubmitted] = useState(false);
      const [darkMode, setDarkMode] = useState(false);
      const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);

      // State for manual quiz creation
      const [showCreateTestForm, setShowCreateTestForm] = useState(false);
      const [editingTestId, setEditingTestId] = useState(null);
      const [newTestTitle, setNewTestTitle] = useState('');
      const [newTestDuration, setNewTestDuration] = useState('');
      const [newTestMaxAttempts, setNewTestMaxAttempts] = useState('');
      const [newTestPrerequisite, setNewTestPrerequisite] = useState('');
      const [newTestQuestions, setNewTestQuestions] = useState([]);
      const [newTestCategory, setNewTestCategory] = useState('ÙƒÙ…ÙŠ');
      const [previewQuiz, setPreviewQuiz] = useState(null);

      // State for file upload
      const [uploadedFile, setUploadedFile] = useState(null);
      const [fileLoading, setFileLoading] = useState(false);
      const [showFileUploadModal, setShowFileUploadModal] = useState(false);
      const [uploadedQuizDuration, setUploadedQuizDuration] = useState('');
      const [uploadedQuizAttempts, setUploadedQuizAttempts] = useState('');
      const [uploadedQuizCategory, setUploadedQuizCategory] = useState('ÙƒÙ…ÙŠ');
      const [uploadedQuizPrerequisite, setUploadedQuizPrerequisite] = useState('');

      // State for Login
      const [devUsername, setDevUsername] = useState('');
      const [devPassword, setDevPassword] = useState('');
      const [userUsernameInput, setUserUsernameInput] = useState('');
      const [userAccessCodeInput, setUserAccessCodeInput] = useState('');
      const [devUsernameToGenerate, setDevUsernameToGenerate] = useState('');
      const [loginError, setLoginError] = useState('');
      
      const DEV_USERNAME = 'tarek2000';
      const DEV_PASSWORD = 'BossX@786';
      
      const [activeTestTab, setActiveTestTab] = useState('ÙƒÙ…ÙŠ');

      // Refs for drag and drop tests
      const dragTest = useRef(null);
      const dragOverTest = useRef(null);
      const dragItem = useRef();
      const dragOverItem = useRef();

      useEffect(() => {
        if (darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [darkMode]);

      useEffect(() => {
        if (currentPage === 'test' && timer > 0) {
          const intervalId = setInterval(() => {
            setTimer(prevTimer => prevTimer - 1);
          }, 1000);
          return () => clearInterval(intervalId);
        } else if (currentPage === 'test' && timer === 0 && !quizSubmitted) {
          handleSubmitTest();
        }
      }, [currentPage, timer, quizSubmitted]);
      
      const handleLogin = () => {
        setLoginError('');
        if (loginRole === 'teacher') {
          if (devUsername === DEV_USERNAME && devPassword === DEV_PASSWORD) {
            setCurrentUser({username: DEV_USERNAME, role: 'superadmin'});
            setCurrentPage('dashboard');
            setDevPage('dashboard');
            return;
          }
          const developer = usersData.find(u => u.role === 'teacher' && u.username === devUsername && u.password === devPassword);
          if (developer) {
            setCurrentUser(developer);
            setCurrentPage('dashboard');
            setDevPage('dashboard');
          } else {
            setLoginError('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù„Ù„Ù…Ø·ÙˆØ±.');
          }
        } else if (loginRole === 'student') {
          const user = usersData.find(u => u.username === userUsernameInput && u.accessCode === userAccessCodeInput);
          if (user) {
            setCurrentUser(user);
            setCurrentPage('dashboard');
          } else {
            setLoginError('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.');
          }
        }
      };
      
      const handleGenerateAccessCode = async (username) => {
        if (!username) {
            console.error('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }
        const existingUser = usersData.find(u => u.username === username);
        if (existingUser) {
            console.error('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.');
            return;
        }

        const newCode = Math.floor(100000 + Math.random() * 900000).toString();
        const newUser = {
          username: username,
          accessCode: newCode,
          scores: {},
          attemptsLeft: {},
          role: 'student',
          allowedSections: ['ÙƒÙ…ÙŠ', 'Ù„ÙØ¸ÙŠ']
        };
        
        await window.firebase.addDoc(window.firebase.collection(db, "users"), newUser);
        setDevUsernameToGenerate('');
        console.log(`ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ${username}: ${newCode}`);
      };

      const handleDeleteUser = async (userId) => {
        if(window.confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.`)){
            await window.firebase.deleteDoc(window.firebase.doc(db, "users", userId));
        }
      };

      const handleResetSingleTestAttempts = async (userId, testId) => {
         if(window.confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ ØªØ¬Ø¯ÙŠØ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)){
            const userToUpdate = usersData.find(u => u.id === userId);
            const newAttemptsLeft = { ...userToUpdate.attemptsLeft };
            delete newAttemptsLeft[testId];
            await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), { attemptsLeft: newAttemptsLeft });
        }
      };
      
      const handleToggleUserRole = async (userId) => {
        const userToUpdate = usersData.find(u => u.id === userId);
        const newRole = userToUpdate.role === 'teacher' ? 'student' : 'teacher';
        let updateData = { role: newRole };

        if (newRole === 'teacher') {
          const password = prompt(`Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø·ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${userToUpdate.username}`);
          if (password && password.length > 0) {
            updateData.password = password;
          } else {
            return;
          }
        } else {
          updateData.password = null;
        }
        await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), updateData);
      };
      
      const handleSectionPermissionChange = async (userId, section) => {
        const userToUpdate = usersData.find(u => u.id === userId);
        const allowed = userToUpdate.allowedSections || ['ÙƒÙ…ÙŠ', 'Ù„ÙØ¸ÙŠ'];
        const newAllowedSections = allowed.includes(section)
            ? allowed.filter(s => s !== section)
            : [...allowed, section];
        await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), { allowedSections: newAllowedSections });
    };

      const handleDeleteTest = async (testId) => {
        if(window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ù‡.')){
            await window.firebase.deleteDoc(window.firebase.doc(db, "tests", testId));
        }
      };

      const handleReturnToLanding = () => {
        setDevUsername('');
        setDevPassword('');
        setUserUsernameInput('');
        setUserAccessCodeInput('');
        setLoginError('');
        setCurrentPage('landing');
        setCurrentUser(null);
        setLoginRole(null);
      };

      const handleStartTest = (testId) => {
        const allTests = [...(testsData['ÙƒÙ…ÙŠ'] || []), ...(testsData['Ù„ÙØ¸ÙŠ'] || [])];
        const test = allTests.find(t => t.id === testId);
        
        const shuffledQuestions = [...test.questions].sort(() => Math.random() - 0.5);
        const testWithShuffledQuestions = { ...test, questions: shuffledQuestions };

        const currentUserData = usersData.find(u => u.username === currentUser.username);
        if (!currentUserData) return;
        
        const attemptsLeft = currentUserData.attemptsLeft[test.id] !== undefined
          ? currentUserData.attemptsLeft[test.id]
          : test.maxAttempts;

        if (attemptsLeft <= 0) return;

        const allAttempts = Object.values(currentUserData.scores).flat();
        const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
        const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
        const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
        const prerequisite = test.prerequisitePercentage || 0;

        if (overallPercentage < prerequisite) return;

        setSelectedTest(testWithShuffledQuestions);
        setAnswers({});
        setQuizSubmitted(false);
        setTimer(test.duration * 60);
        setCurrentPage('test');
        setCurrentQuestionIndex(0);
      };
      
      const handleNextQuestion = () => {
        if (currentQuestionIndex < selectedTest.questions.length - 1) {
          setCurrentQuestionIndex(prevIndex => prevIndex + 1);
        }
      };

      const handlePreviousQuestion = () => {
        if (currentQuestionIndex > 0) {
          setCurrentQuestionIndex(prevIndex => prevIndex - 1);
        }
      };

      const handleAnswerChange = (questionId, selectedOption) => {
        setAnswers({ ...answers, [questionId]: selectedOption });
      };

      const handleSubmitTest = async () => {
        if (quizSubmitted) return;
        setQuizSubmitted(true);

        const score = selectedTest.questions.filter(q => answers[q.id] === q.correctAnswer).length;
        const timeTaken = selectedTest.duration * 60 - timer;
        
        const userToUpdate = usersData.find(user => user.username === currentUser.username);
        const userRef = window.firebase.doc(db, "users", userToUpdate.id);

        const newAttemptsLeft = (userToUpdate.attemptsLeft[selectedTest.id] !== undefined
            ? userToUpdate.attemptsLeft[selectedTest.id]
            : selectedTest.maxAttempts) - 1;
            
        const newScoreData = {
            score: score,
            total: selectedTest.questions.length,
            date: new Date().toLocaleDateString('ar-SA'),
            time: new Date().toLocaleTimeString('ar-SA'),
            timeTaken: timeTaken
        };

        const updatedScores = { ...userToUpdate.scores };
        if (!updatedScores[selectedTest.id]) {
            updatedScores[selectedTest.id] = [];
        }
        updatedScores[selectedTest.id].push(newScoreData);

        await window.firebase.updateDoc(userRef, {
            scores: updatedScores,
            [`attemptsLeft.${selectedTest.id}`]: newAttemptsLeft
        });

        setCurrentPage('results');
      };

      const [showUserScores, setShowUserScores] = useState(false);
      const [userScoresToShow, setUserScoresToShow] = useState(null);

      const handleShowUserScores = (user) => {
        setUserScoresToShow(user);
        setShowUserScores(true);
      };

      const handleCloseUserScores = () => {
        setShowUserScores(false);
        setUserScoresToShow(null);
      };

      const handleDragStart = (e, position) => {
        dragItem.current = position;
      };

      const handleDragEnter = (e, position) => {
        dragOverItem.current = position;
        const list = [...newTestQuestions];
        const dragItemContent = list[dragItem.current];
        list.splice(dragItem.current, 1);
        list.splice(dragOverItem.current, 0, dragItemContent);
        dragItem.current = dragOverItem.current;
        dragOverItem.current = null;
        setNewTestQuestions(list);
      };
      
      const handleTestSort = () => {
        if (dragTest.current === null || dragOverTest.current === null) return;

        const testsCopy = [...testsData[activeTestTab]];
        const draggedItemContent = testsCopy.splice(dragTest.current, 1)[0];
        testsCopy.splice(dragOverTest.current, 0, draggedItemContent);

        setTestsData(prev => ({
            ...prev,
            [activeTestTab]: testsCopy
        }));

        dragTest.current = null;
        dragOverTest.current = null;
    };

      const handleAddQuestion = () => {
        setNewTestQuestions([...newTestQuestions, {
          id: Date.now(),
          text: '',
          imageUrl: '',
          type: 'mcq',
          options: [
            { id: 'a', text: '', imageUrl: '' },
            { id: 'b', text: '', imageUrl: '' },
            { id: 'c', text: '', imageUrl: '' },
            { id: 'd', text: '', imageUrl: '' }
          ],
          correctAnswer: 'a'
        }]);
      };

      const handleUpdateQuestion = (qIndex, field, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex][field] = value;
        setNewTestQuestions(updatedQuestions);
      };
      
      const handleDeleteQuestion = (qIndex) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions.splice(qIndex, 1);
        setNewTestQuestions(updatedQuestions);
      };
      
      const handleUpdateCorrectAnswer = (qIndex, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex].correctAnswer = value;
        setNewTestQuestions(updatedQuestions);
      };

      const handleUpdateOption = (qIndex, oIndex, field, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex].options[oIndex][field] = value;
        setNewTestQuestions(updatedQuestions);
      };
      
      const resetCreateTestForm = () => {
          setNewTestTitle('');
          setNewTestDuration('');
          setNewTestMaxAttempts('');
          setNewTestPrerequisite('');
          setNewTestQuestions([]);
          setShowCreateTestForm(false);
          setEditingTestId(null);
      }

      const handleSaveNewTest = async () => {
        if (!newTestTitle || !newTestDuration || !newTestMaxAttempts || newTestQuestions.length === 0) return;
        
        const newTest = {
          title: newTestTitle,
          category: newTestCategory,
          duration: parseInt(newTestDuration, 10),
          maxAttempts: parseInt(newTestMaxAttempts, 10),
          prerequisitePercentage: parseInt(newTestPrerequisite, 10) || 0,
          questions: newTestQuestions
        };

        if(editingTestId) {
            await window.firebase.setDoc(window.firebase.doc(db, "tests", editingTestId), newTest);
        } else {
            await window.firebase.addDoc(window.firebase.collection(db, "tests"), newTest);
        }
        resetCreateTestForm();
      };

      const handleEditTest = (testToEdit, category) => {
        setEditingTestId(testToEdit.id);
        setNewTestTitle(testToEdit.title);
        setNewTestDuration(testToEdit.duration.toString());
        setNewTestMaxAttempts(testToEdit.maxAttempts.toString());
        setNewTestPrerequisite(testToEdit.prerequisitePercentage?.toString() || '0');
        setNewTestQuestions(JSON.parse(JSON.stringify(testToEdit.questions)));
        setNewTestCategory(category);
        setShowCreateTestForm(true);
      };
      
      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
          setUploadedFile(file);
          setShowFileUploadModal(true);
        }
      };

      const handleGenerateQuizFromFile = async () => {
        if (!uploadedFile || !uploadedQuizDuration || !uploadedQuizAttempts) return;

        setShowFileUploadModal(false);
        setFileLoading(true);

        const simulatedFileContent = `
        Ø§Ù„Ø³Ø¤Ø§Ù„ 1: Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ
        Ø£) Ø¬Ø¯Ø©
        Ø¨) Ø§Ù„Ø±ÙŠØ§Ø¶
        Ø¬) Ø§Ù„Ø¯Ù…Ø§Ù…
        Ø¯) Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©
        Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: Ø¨
        `;

        const prompt = `Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† 3 Ø£Ø³Ø¦Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ø¹Ù„Ù‰ 4 Ø®ÙŠØ§Ø±Ø§Øª ÙˆØ¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙˆØ§Ø­Ø¯Ø©. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ùˆ: "${simulatedFileContent}"`;

        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = {
          contents: chatHistory,
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "OBJECT",
              properties: {
                "title": { "type": "STRING" },
                "questions": {
                  "type": "ARRAY",
                  "items": {
                    "type": "OBJECT",
                    "properties": {
                      "id": { "type": "INTEGER" },
                      "text": { "type": "STRING" },
                      "type": { "type": "STRING", "default": "mcq" },
                      "options": {
                        "type": "ARRAY",
                        "items": {
                          "type": "OBJECT",
                          "properties": {
                            "id": { "type": "STRING" },
                            "text": { "type": "STRING" }
                          }
                        }
                      },
                      "correctAnswer": { "type": "STRING" }
                    }
                  }
                }
              }
            }
          }
        };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await response.json();
          if (result.candidates?.[0]?.content?.parts?.[0]) {
            const jsonString = result.candidates[0].content.parts[0].text.replace(/```json\n|\n```/g, '');
            try {
                const uploadedQuiz = JSON.parse(jsonString);
                
                const newTest = {
                  id: Date.now(),
                  title: uploadedQuiz.title || (uploadedFile ? uploadedFile.name : "Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯"),
                  duration: parseInt(uploadedQuizDuration, 10),
                  maxAttempts: parseInt(uploadedQuizAttempts, 10),
                  prerequisitePercentage: parseInt(uploadedQuizPrerequisite, 10) || 0,
                  questions: uploadedQuiz.questions.map(q => ({...q, imageUrl: '', options: q.options.map(o => ({...o, imageUrl: ''}))}))
                };

                setTestsData(prev => ({
                  ...prev,
                  [uploadedQuizCategory]: [...(prev[uploadedQuizCategory] || []), newTest]
                }));

            } catch (parseError) {
                console.error("Error parsing JSON:", parseError, "String:", jsonString);
            }
          } else {
            console.error("Unexpected API response:", result);
          }
        } catch (error) {
          console.error("Error generating quiz:", error);
        } finally {
          setFileLoading(false);
          setUploadedFile(null);
          setUploadedQuizDuration('');
          setUploadedQuizAttempts('');
          setUploadedQuizPrerequisite('');
        }
      };


      const handlePreviewQuiz = (test) => {
        setPreviewQuiz(JSON.parse(JSON.stringify(test)));
        setCurrentPage('preview');
      };

      const handleClosePreview = () => {
        setPreviewQuiz(null);
        setCurrentPage('dashboard');
        setCurrentQuestionIndex(0);
      };
      
      const handleSavePreview = () => {
        if (!previewQuiz) return;
        setTestsData(prevTests => {
          const newTests = { ...prevTests };
          let found = false;
          for (const category in newTests) {
            const testIndex = newTests[category].findIndex(t => t.id === previewQuiz.id);
            if (testIndex !== -1) {
              newTests[category][testIndex] = previewQuiz;
              found = true;
              break;
            }
          }
          return newTests;
        });
        handleClosePreview();
      };

      const formatTime = (seconds) => {
          if (isNaN(seconds) || seconds < 0) return "00:00";
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      };

      const ThemeToggleButton = () => (
          <button
              onClick={() => setDarkMode(!darkMode)}
              className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200"
          >
              {darkMode ? (
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
              ) : (
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
              )}
          </button>
      );
      
      const renderLandingPage = () => (
        <div className="flex flex-col items-center justify-center min-h-screen animated-gradient text-center p-4 relative" dir="rtl">
          <div className="absolute top-8 left-1/2 -translate-x-1/2 bg-white p-2 rounded-full shadow-lg">
              <img 
                src="https://fv5-6.files.fm/thumb_show.php?i=jtsxwvdzx7&view&v=1&PHPSESSID=840289eb9c827cf9e763225e5338ec7bcb614132" 
                alt="Ø´Ø¹Ø§Ø±" 
                className="h-48 w-48 rounded-full object-contain"
                onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/192x192/FFFFFF/000000?text=Ø´Ø¹Ø§Ø±" }}
              />
          </div>
          <h1 className="text-5xl font-bold text-white mb-4 drop-shadow-lg mt-72">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h1>
          <p className="text-xl text-gray-200 mb-12 drop-shadow-md">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
          <div className="flex flex-col space-y-6 items-center">
             <button 
              onClick={() => { setLoginRole('student'); setCurrentPage('login'); }} 
              className="bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-10 rounded-full text-xl transition duration-300 transform hover:scale-105 shadow-lg backdrop-blur-sm border border-white/30 w-64 flex items-center justify-center space-x-3"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>
              <span>Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù…</span>
            </button>
            <button 
              onClick={() => { setLoginRole('teacher'); setCurrentPage('login'); }} 
              className="bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-10 rounded-full text-xl transition duration-300 transform hover:scale-105 shadow-lg backdrop-blur-sm border border-white/30 w-64 flex items-center justify-center space-x-3"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
              <span>Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø·ÙˆØ±</span>
            </button>
          </div>
          <footer className="absolute bottom-4 text-white/70 text-sm">
            Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Bungus Â® 2025-2026
          </footer>
        </div>
      );

      const renderLoginPage = () => (
        <div className="flex items-center justify-center min-h-screen bg-slate-100 dark:bg-slate-900" dir="rtl">
          <div className="absolute top-4 left-4">
              <ThemeToggleButton />
          </div>
          <div className="w-full max-w-md">
              <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold text-center text-slate-900 dark:text-white mb-6">
                  ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - {loginRole === 'teacher' ? 'Ù…Ø·ÙˆØ±' : 'Ù…Ø³ØªØ®Ø¯Ù…'}
                </h2>
                {loginError && <p className="text-red-500 text-center mb-4">{loginError}</p>}
                {loginRole === 'teacher' ? (
                  <div>
                    <input
                      type="text"
                      placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
                      value={devUsername}
                      onChange={(e) => setDevUsername(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <input
                      type="password"
                      placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                      value={devPassword}
                      onChange={(e) => setDevPassword(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                ) : (
                  <div>
                    <input
                      type="text"
                      placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"
                      value={userUsernameInput}
                      onChange={(e) => setUserUsernameInput(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <input
                      type="text"
                      placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„"
                      value={userAccessCodeInput}
                      onChange={(e) => setUserAccessCodeInput(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                )}
                <button onClick={handleLogin} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-300">
                  Ø¯Ø®ÙˆÙ„
                </button>
                <button onClick={handleReturnToLanding} className="w-full mt-4 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 rounded-lg transition duration-300">
                  Ø§Ù„Ø¹ÙˆØ¯Ø©
                </button>
              </div>
          </div>
        </div>
      );
      
      // Main Developer Dashboard Container
      const renderTeacherDashboard = () => (
        <div className="min-h-screen text-slate-900 dark:text-slate-100 p-4 sm:p-8">
            <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-8">
                    <h1 className="text-3xl font-bold">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ {currentUser.username}</h1>
                    <div className="flex items-center space-x-4">
                        <ThemeToggleButton />
                        <button onClick={handleReturnToLanding} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                    </div>
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-2 order-2 lg:order-1">
                        {devPage === 'dashboard' && <MainDashboard 
                          setDevPage={setDevPage}
                          devUsernameToGenerate={devUsernameToGenerate}
                          setDevUsernameToGenerate={setDevUsernameToGenerate}
                          handleGenerateAccessCode={handleGenerateAccessCode}
                          showCreateTestForm={showCreateTestForm}
                          setShowCreateTestForm={setShowCreateTestForm}
                          setNewTestCategory={setNewTestCategory}
                          editingTestId={editingTestId}
                          newTestCategory={newTestCategory}
                          newTestTitle={newTestTitle}
                          setNewTestTitle={setNewTestTitle}
                          newTestDuration={newTestDuration}
                          setNewTestDuration={setNewTestDuration}
                          newTestMaxAttempts={newTestMaxAttempts}
                          setNewTestMaxAttempts={setNewTestMaxAttempts}
                          newTestPrerequisite={newTestPrerequisite}
                          setNewTestPrerequisite={setNewTestPrerequisite}
                          newTestQuestions={newTestQuestions}
                          handleDragStart={handleDragStart}
                          handleDragEnter={handleDragEnter}
                          handleUpdateQuestion={handleUpdateQuestion}
                          handleUpdateOption={handleUpdateOption}
                          handleUpdateCorrectAnswer={handleUpdateCorrectAnswer}
                          handleDeleteQuestion={handleDeleteQuestion}
                          handleAddQuestion={handleAddQuestion}
                          handleSaveNewTest={handleSaveNewTest}
                          resetCreateTestForm={resetCreateTestForm}
                          testsData={testsData}
                          activeTestTab={activeTestTab}
                          setActiveTestTab={setActiveTestTab}
                          dragTest={dragTest}
                          dragOverTest={dragOverTest}
                          handleTestSort={handleTestSort}
                          handlePreviewQuiz={handlePreviewQuiz}
                          handleEditTest={handleEditTest}
                          handleDeleteTest={handleDeleteTest}
                        />}
                        {devPage === 'users' && <UserManagementPage 
                           setDevPage={setDevPage}
                           usersData={usersData}
                           handleShowUserScores={handleShowUserScores}
                           handleToggleUserRole={handleToggleUserRole}
                           handleDeleteUser={handleDeleteUser}
                           handleSectionPermissionChange={handleSectionPermissionChange}
                        />}
                        {devPage === 'results' && <ResultsManagementPage 
                            setDevPage={setDevPage} 
                            usersData={usersData} 
                        />}
                    </div>
                    <div className="lg:col-span-1 order-1 lg:order-2">
                        <Leaderboard users={usersData} />
                    </div>
                </div>
            </div>
        </div>
      );
      
      // Render Student Dashboard
      const renderStudentDashboard = () => {
        const currentUserData = currentUser;
        
        if (!isDataLoaded) {
            return <div className="min-h-screen flex items-center justify-center"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p></div>;
        }
        
        if (!currentUserData || currentUserData.role !== 'student') {
            return <div className="min-h-screen flex items-center justify-center"><p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p></div>;
        }

        const allowedSections = currentUserData.allowedSections || ['ÙƒÙ…ÙŠ', 'Ù„ÙØ¸ÙŠ'];
        const allTests = [
            ...(allowedSections.includes('ÙƒÙ…ÙŠ') ? (testsData['ÙƒÙ…ÙŠ'] || []) : []),
            ...(allowedSections.includes('Ù„ÙØ¸ÙŠ') ? (testsData['Ù„ÙØ¸ÙŠ'] || []) : [])
        ].sort((a, b) => a.title.localeCompare(b.title, 'ar', { numeric: true }));
        
        const allAttempts = Object.values(currentUserData.scores).flat();
        const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
        const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
        const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100).toFixed(2) : 0;

        return (
          <div className="min-h-screen text-slate-900 dark:text-slate-100 p-4 sm:p-8">
            <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-8">
                  <h1 className="text-3xl font-bold">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ {currentUser.username}</h1>
                  <div className="flex items-center space-x-4">
                    <ThemeToggleButton />
                    <button onClick={handleReturnToLanding} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</h2>
                        <p className="text-lg">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: <span className="font-bold text-blue-500">{overallPercentage}%</span></p>
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-2">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
                        <p className="text-lg">Ø§Ù„Ù…Ù†Ø¬Ø²Ø©: <span className="font-bold text-green-500">{Object.keys(currentUserData.scores).length}</span></p>
                        <p className="text-lg">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: <span className="font-bold text-red-500">{allTests.length - Object.keys(currentUserData.scores).length}</span></p>
                    </div>
                </div>
                
                <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
                  <h2 className="text-2xl font-bold mb-4">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {allTests.length > 0 ? allTests.map(test => {
                      const attemptsLeft = currentUserData.attemptsLeft[test.id] !== undefined
                        ? currentUserData.attemptsLeft[test.id]
                        : test.maxAttempts;
                      const prerequisite = test.prerequisitePercentage || 0;
                      const isLocked = overallPercentage < prerequisite;

                      return (
                        <div key={test.id} className="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg border dark:border-slate-600">
                          <h3 className="text-xl font-bold">{test.title}</h3>
                          <p>Ø§Ù„Ù…Ø¯Ø©: {test.duration} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                          <p>Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: {attemptsLeft}</p>
                          {isLocked && <p className="text-sm text-red-500 mt-1">Ù…ØºÙ„Ù‚ (ÙŠØªØ·Ù„Ø¨ {prerequisite}% Ù„Ù„ÙˆØµÙˆÙ„)</p>}
                          <button 
                            onClick={() => handleStartTest(test.id)}
                            disabled={attemptsLeft <= 0 || isLocked}
                            className="mt-4 w-full bg-blue-500 text-white p-2 rounded-lg disabled:bg-slate-400">
                            {isLocked ? 'Ù…ØºÙ„Ù‚' : (attemptsLeft > 0 ? 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª')}
                          </button>
                        </div>
                      );
                    }) : <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ùƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>}
                  </div>
                </div>
            </div>
          </div>
        );
      };

      const renderPreviewPage = () => {
        if (!previewQuiz) return null;
        const question = previewQuiz.questions[currentQuestionIndex];
        const isFirstQuestion = currentQuestionIndex === 0;
        const isLastQuestion = currentQuestionIndex === previewQuiz.questions.length - 1;

        return (
          <div className="flex flex-col items-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl mt-10">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">{previewQuiz.title}</h1>
                <div className="flex items-center space-x-4">
                  <ThemeToggleButton />
                  <button onClick={handleClosePreview} className="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-xl transition duration-300">
                    Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                  </button>
                </div>
              </div>

              <div className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600">
                {question.imageUrl && <img src={question.imageUrl} alt={`ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${currentQuestionIndex + 1}`} className="w-full max-h-60 object-contain rounded-lg mb-4"/>}
                <p className="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                  {currentQuestionIndex + 1}. {question.text}
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {question.options.map(option => (
                    <div key={option.id} className={`flex flex-col items-center justify-center p-4 rounded-lg border-2 ${question.correctAnswer === option.id ? 'bg-green-100 dark:bg-green-900 border-green-500' : 'bg-white dark:bg-slate-800'}`}>
                      {option.imageUrl && <img src={option.imageUrl} className="w-24 h-24 object-contain rounded-md mb-2" />}
                      <span className="text-slate-900 dark:text-white text-center font-bold">{option.text}</span>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="mt-8 flex justify-between">
                <button onClick={() => setCurrentQuestionIndex(prev => prev - 1)} disabled={isFirstQuestion} className={`bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md ${isFirstQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}>
                  Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                <button onClick={() => setCurrentQuestionIndex(prev => prev + 1)} disabled={isLastQuestion} className={`bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md ${isLastQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}>
                  Ø§Ù„ØªØ§Ù„ÙŠ
                </button>
              </div>
            </div>
          </div>
        );
      };

      const renderTestPage = () => {
        if (!selectedTest) return null;
        const question = selectedTest.questions[currentQuestionIndex];
        const isFirstQuestion = currentQuestionIndex === 0;
        const isLastQuestion = currentQuestionIndex === selectedTest.questions.length - 1;

        return (
          <div className="flex flex-col items-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl mt-10">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">{selectedTest.title}</h1>
                <div className="flex items-center space-x-4">
                  <ThemeToggleButton />
                  <div className="bg-red-100 text-red-700 px-4 py-2 rounded-full font-bold">
                    Ù…ØªØ¨Ù‚ÙŠ: {formatTime(timer)}
                  </div>
                </div>
              </div>

              <div className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600">
                {question.imageUrl && <img src={question.imageUrl} alt={`ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${currentQuestionIndex + 1}`} className="w-full max-h-60 object-contain rounded-lg mb-4"/>}
                <p className="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                  {currentQuestionIndex + 1}. {question.text}
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {question.options.map(option => (
                    <label key={option.id} onClick={() => handleAnswerChange(question.id, option.id)} className={`flex flex-col items-center justify-center cursor-pointer p-4 rounded-lg border-2 transition duration-200 ${answers[question.id] === option.id ? 'bg-blue-100 dark:bg-blue-900 border-blue-500' : 'bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                      {option.imageUrl && <img src={option.imageUrl} className="w-24 h-24 object-contain rounded-md mb-2" />}
                      <span className="text-slate-900 dark:text-white text-center font-bold">{option.text}</span>
                    </label>
                  ))}
                </div>
              </div>
              
              <div className="mt-8 flex justify-between">
                <button onClick={handlePreviousQuestion} disabled={isFirstQuestion} className={`bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md ${isFirstQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}>
                  Ø§Ù„Ø³Ø§Ø¨Ù‚
                </button>
                {isLastQuestion ? (
                  <button onClick={handleSubmitTest} disabled={quizSubmitted} className={`bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md ${quizSubmitted ? 'opacity-50 cursor-not-allowed' : ''}`}>
                    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                  </button>
                ) : (
                  <button onClick={handleNextQuestion} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md">
                    Ø§Ù„ØªØ§Ù„ÙŠ
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      };

      const renderResultsPage = () => {
        if (!selectedTest) return null;
        let score = 0;
        let totalQuestions = selectedTest.questions.length;
        selectedTest.questions.forEach(q => {
          if (answers[q.id] === q.correctAnswer) score++;
        });
        
        const percentage = (score / totalQuestions) * 100;
        
        const ScoreIndicator = () => {
            if (percentage >= 80) return <span className="text-green-500 text-2xl ml-2">âœ…</span>;
            if (percentage >= 60) return <span className="text-orange-500 text-2xl ml-2">âš ï¸</span>;
            if (percentage >= 50) return <span className="text-red-500 text-2xl ml-2">âŒ</span>;
            return <span className="text-slate-500 text-2xl ml-2">âšªï¸</span>;
        };

        return (
          <div className="flex flex-col items-center justify-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl text-center">
              <div className="absolute top-4 left-4">
                <ThemeToggleButton />
              </div>
              <h1 className="text-3xl font-bold mb-6 text-slate-900 dark:text-white">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h1>
              <p className="text-xl text-slate-600 dark:text-slate-300 mb-8">
                Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø§Ø®ØªØ¨Ø§Ø±: <span className="font-semibold text-blue-500">{selectedTest.title}</span>
              </p>

              <div className="mb-8 flex items-center justify-center">
                <p className="text-2xl font-bold text-slate-900 dark:text-white">
                  Ø¯Ø±Ø¬ØªÙƒ: <span className="text-green-500">{score}</span> / <span className="text-blue-500">{totalQuestions}</span>
                </p>
                <ScoreIndicator />
              </div>
              
              <div className="text-right">
                {selectedTest.questions.map((question, qIndex) => (
                  <div key={question.id} className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600 text-right">
                    {question.imageUrl && <img src={question.imageUrl} alt={`ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù… ${qIndex + 1}`} className="w-full max-h-60 object-contain rounded-lg mb-4"/>}
                    <p className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                      {qIndex + 1}. <MathComponent text={question.text} />
                    </p>
                    <div className="mt-2 text-slate-700 dark:text-slate-300">
                      <p className={`mb-1 ${answers[question.id] === question.correctAnswer ? 'text-green-600' : 'text-red-600'}`}>
                        <span className="font-bold">Ø¥Ø¬Ø§Ø¨ØªÙƒ:</span> <MathComponent text={question.options.find(opt => opt.id === answers[question.id])?.text || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©'} />
                      </p>
                      <p>
                        <span className="font-bold text-green-600 dark:text-green-400">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</span> <MathComponent text={question.options.find(opt => opt.id === question.correctAnswer)?.text} />
                      </p>
                    </div>
                  </div>
                ))}
              </div>

              <button onClick={() => setCurrentPage('dashboard')} className="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105 shadow-md">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
              </button>
            </div>
          </div>
        );
      };

      const UserScoresModal = ({ user, onClose, onResetAttempt, allTests }) => {
          if (!user) return null;
          
          const allUserTests = Array.from(new Set(Object.keys(user.scores).concat(Object.keys(user.attemptsLeft))));

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-4xl w-full text-slate-900 dark:text-slate-100">
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="text-xl font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user.username}</h3>
                          <button onClick={onClose} className="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white">&times;</button>
                      </div>
                      
                      <div className="max-h-96 overflow-y-auto">
                          <table className="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                              <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                                  <tr>
                                      <th scope="col" className="px-6 py-3">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th>
                                      <th scope="col" className="px-6 py-3">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª)</th>
                                      <th scope="col" className="px-6 py-3">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                      <th scope="col" className="px-6 py-3">Ø¥Ø¬Ø±Ø§Ø¡</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {allUserTests.length > 0 ? allUserTests.map(testId => {
                                      const test = allTests.find(t => t.id == testId);
                                      if (!test) return null;
                                      const scoresForTest = user.scores[testId] || [];
                                      const attemptsLeftForTest = user.attemptsLeft[test.id] !== undefined ? user.attemptsLeft[test.id] : test.maxAttempts;

                                      return (
                                          <tr key={test.id} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700">
                                              <th scope="row" className="px-6 py-4 font-medium text-slate-900 dark:text-white whitespace-nowrap">{test.title}</th>
                                              <td className="px-6 py-4">
                                                  {scoresForTest.length > 0 ? scoresForTest.map((scoreData, index) => (
                                                      <div key={index} className="text-xs">
                                                          {scoreData.score}/{scoreData.total} - {scoreData.date} ({formatTime(scoreData.timeTaken)})
                                                      </div>
                                                  )) : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª"}
                                              </td>
                                              <td className="px-6 py-4">{attemptsLeftForTest}</td>
                                              <td className="px-6 py-4">
                                                  <button onClick={() => onResetAttempt(user.id, test.id)} className="text-blue-500 hover:underline text-xs">
                                                      ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                                                  </button>
                                              </td>
                                          </tr>
                                      );
                                  }) : (
                                      <tr><td colSpan="4" className="text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</td></tr>
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          );
      };
      
      const FileUploadModal = ({ onClose }) => (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-md w-full">
                  <h3 className="text-xl font-bold mb-4 text-slate-900 dark:text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø±ÙÙˆØ¹</h3>
                  <div className="space-y-4">
                      <input type="number" placeholder="Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¯Ù‚Ø§Ø¦Ù‚)" value={uploadedQuizDuration} onChange={(e) => setUploadedQuizDuration(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                      <input type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª" value={uploadedQuizAttempts} onChange={(e) => setUploadedQuizAttempts(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                      <input type="number" placeholder="Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (%)" value={uploadedQuizPrerequisite} onChange={(e) => setUploadedQuizPrerequisite(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                      <select value={uploadedQuizCategory} onChange={(e) => setUploadedQuizCategory(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700">
                          <option value="ÙƒÙ…ÙŠ">ÙƒÙ…ÙŠ</option>
                          <option value="Ù„ÙØ¸ÙŠ">Ù„ÙØ¸ÙŠ</option>
                      </select>
                  </div>
                  <div className="flex justify-end space-x-4 rtl:space-x-reverse mt-6">
                      <button onClick={onClose} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded">Ø¥Ù„ØºØ§Ø¡</button>
                      <button onClick={handleGenerateQuizFromFile} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                  </div>
              </div>
          </div>
      );

      // Render the correct page based on the current state
      const renderCurrentPage = () => {
        switch (currentPage) {
          case 'landing': return renderLandingPage();
          case 'login': return renderLoginPage();
          case 'dashboard': return currentUser?.role?.includes('teacher') || currentUser?.role === 'superadmin' ? renderTeacherDashboard() : renderStudentDashboard();
          case 'test': return renderTestPage();
          case 'results': return renderResultsPage();
          case 'preview': return renderPreviewPage();
          default: return renderLandingPage();
        }
      };
      
      const allTests = useMemo(() => [...(testsData['ÙƒÙ…ÙŠ'] || []), ...(testsData['Ù„ÙØ¸ÙŠ'] || [])], [testsData]);

      return (
        <div className="font-sans">
          {renderCurrentPage()}
          {showUserScores && <UserScoresModal user={userScoresToShow} onClose={handleCloseUserScores} onResetAttempt={handleResetSingleTestAttempts} allTests={allTests} />}
          {showFileUploadModal && <FileUploadModal onClose={() => setShowFileUploadModal(false)} />}
        </div>
      );
    }
    
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

