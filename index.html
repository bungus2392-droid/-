<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>الاختبارات والتقويم</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    @keyframes gradient-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .animated-gradient {
      background: linear-gradient(-45deg, #0d47a1, #00796b, #00bfa5, #1e88e5);
      background-size: 400% 400%;
      animation: gradient-animation 15s ease infinite;
    }
    .dragging-over {
        border-top: 2px solid #3b82f6; /* blue-500 */
    }
     .main-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        align-items: flex-start;
      }
      @media (max-width: 1024px) {
        .main-container {
            grid-template-columns: 1fr;
        }
      }
      .c-graph__title {
        font-size: 26px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 2rem;
        text-align: center;
        grid-column: 1 / -1; /* Span across all columns */
      }
      .chart-container {
        position: relative;
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      .c-graph__bar {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
      }
      .c-graph__bar.highlighted {
        fill: #a78bfa; /* A lighter purple for highlight */
      }
      .axis-line { stroke: #e2e8f0; stroke-width: 1; }
      #tooltip {
        position: absolute;
        background-color: rgba(15, 23, 42, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s, transform 0.2s;
        transform: translate(-50%, -110%);
        white-space: nowrap;
      }
      .table-container {
        max-height: 550px;
        overflow-y: auto;
        background-color: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      }
      /* Custom scrollbar */
      .table-container::-webkit-scrollbar { width: 8px; }
      .table-container::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 1rem; }
      .table-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 1rem; }
      .table-container::-webkit-scrollbar-thumb:hover { background: #a8b2c1; }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <!-- MathJax Configuration -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    window.firebase = { initializeApp, getFirestore, doc, onSnapshot, setDoc, collection, addDoc, updateDoc, deleteDoc };
  </script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;
    const { createRoot } = ReactDOM;

    // --| Firebase Configuration | --
    const firebaseConfig = {
      apiKey: "AIzaSyDAqNYMF5H8I1jCJfDwZ5PI_qztLx1MS14",
      authDomain: "bungus-78fc6.firebaseapp.com",
      projectId: "bungus-78fc6",
      storageBucket: "bungus-78fc6.appspot.com",
      messagingSenderId: "546709528555",
      appId: "1:546709528555:web:dbed8e2e70d77ed532c3ae",
      measurementId: "G-1LB7LVN38E"
    };

    // Initialize Firebase
    let app, db;
    try {
        app = window.firebase.initializeApp(firebaseConfig);
        db = window.firebase.getFirestore(app);
    } catch (e) {
        console.error("Firebase initialization error:", e);
    }

    const MathComponent = ({ text }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (window.MathJax && ref.current) {
          window.MathJax.typesetPromise([ref.current]);
        }
      }, [text]);

      return <span ref={ref}>{text}</span>;
    };

    function App() {
      const [testsData, setTestsData] = useState({ 'كمي': [], 'لفظي': [] });
      const [usersData, setUsersData] = useState([]);
      const [isDataLoaded, setIsDataLoaded] = useState(false);

      useEffect(() => {
        if (!db) {
            alert("فشل تهيئة Firebase. يرجى التحقق من معلومات الإعداد.");
            setIsDataLoaded(true);
            return;
        }
        const unsubscribeTests = window.firebase.onSnapshot(window.firebase.collection(db, "tests"), (snapshot) => {
            const newTestsData = { 'كمي': [], 'لفظي': [] };
            snapshot.forEach(doc => {
                const test = { id: doc.id, ...doc.data() };
                if (newTestsData[test.category]) {
                    newTestsData[test.category].push(test);
                }
            });
            setTestsData(newTestsData);
        });

        const unsubscribeUsers = window.firebase.onSnapshot(window.firebase.collection(db, "users"), (snapshot) => {
            const newUsersData = [];
            snapshot.forEach(doc => {
                newUsersData.push({ id: doc.id, ...doc.data() });
            });
            setUsersData(newUsersData);
            setIsDataLoaded(true);
        });

        return () => {
            unsubscribeTests();
            unsubscribeUsers();
        };
      }, []);

      const [currentPage, setCurrentPage] = useState('landing');
      const [devPage, setDevPage] = useState('dashboard');
      const [loginRole, setLoginRole] = useState(null);
      const [currentUser, setCurrentUser] = useState(null);
      const [selectedTest, setSelectedTest] = useState(null);
      const [answers, setAnswers] = useState({});
      const [timer, setTimer] = useState(0);
      const [quizSubmitted, setQuizSubmitted] = useState(false);
      const [darkMode, setDarkMode] = useState(false);
      const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);

      // State for manual quiz creation
      const [showCreateTestForm, setShowCreateTestForm] = useState(false);
      const [editingTestId, setEditingTestId] = useState(null);
      const [newTestTitle, setNewTestTitle] = useState('');
      const [newTestDuration, setNewTestDuration] = useState('');
      const [newTestMaxAttempts, setNewTestMaxAttempts] = useState('');
      const [newTestPrerequisite, setNewTestPrerequisite] = useState('');
      const [newTestQuestions, setNewTestQuestions] = useState([]);
      const [newTestCategory, setNewTestCategory] = useState('كمي');
      const [previewQuiz, setPreviewQuiz] = useState(null);

      // State for file upload
      const [uploadedFile, setUploadedFile] = useState(null);
      const [fileLoading, setFileLoading] = useState(false);
      const [showFileUploadModal, setShowFileUploadModal] = useState(false);
      const [uploadedQuizDuration, setUploadedQuizDuration] = useState('');
      const [uploadedQuizAttempts, setUploadedQuizAttempts] = useState('');
      const [uploadedQuizCategory, setUploadedQuizCategory] = useState('كمي');
      const [uploadedQuizPrerequisite, setUploadedQuizPrerequisite] = useState('');

      // State for Login
      const [devUsername, setDevUsername] = useState('');
      const [devPassword, setDevPassword] = useState('');
      const [userUsernameInput, setUserUsernameInput] = useState('');
      const [userAccessCodeInput, setUserAccessCodeInput] = useState('');
      const [devUsernameToGenerate, setDevUsernameToGenerate] = useState('');
      const [loginError, setLoginError] = useState('');
      
      // Hardcoded credentials for demonstration
      const DEV_USERNAME = 'tarek2000';
      const DEV_PASSWORD = 'BossX@786';

      useEffect(() => {
        if (darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [darkMode]);

      useEffect(() => {
        if (currentPage === 'test' && timer > 0) {
          const intervalId = setInterval(() => {
            setTimer(prevTimer => prevTimer - 1);
          }, 1000);
          return () => clearInterval(intervalId);
        } else if (currentPage === 'test' && timer === 0 && !quizSubmitted) {
          handleSubmitTest();
        }
      }, [currentPage, timer, quizSubmitted]);
      
      const handleLogin = () => {
        setLoginError('');
        if (loginRole === 'teacher') {
          if (devUsername === DEV_USERNAME && devPassword === DEV_PASSWORD) {
            setCurrentUser({username: DEV_USERNAME, role: 'superadmin'});
            setCurrentPage('dashboard');
            setDevPage('dashboard');
            return;
          }
          const developer = usersData.find(u => u.role === 'teacher' && u.username === devUsername && u.password === devPassword);
          if (developer) {
            setCurrentUser(developer);
            setCurrentPage('dashboard');
            setDevPage('dashboard');
          } else {
            setLoginError('اسم المستخدم أو كلمة المرور غير صحيحة للمطور.');
          }
        } else if (loginRole === 'student') {
          const user = usersData.find(u => u.username === userUsernameInput && u.accessCode === userAccessCodeInput);
          if (user) {
            setCurrentUser(user);
            setCurrentPage('dashboard');
          } else {
            setLoginError('اسم المستخدم أو رمز الدخول غير صحيح.');
          }
        }
      };
      
      const handleGenerateAccessCode = async (username) => {
        if (!username) {
          alert('الرجاء إدخال اسم المستخدم أولاً.');
          return;
        }
        const existingUser = usersData.find(u => u.username === username);
        if (existingUser) {
          alert('هذا المستخدم موجود بالفعل.');
          return;
        }

        const newCode = Math.floor(100000 + Math.random() * 900000).toString();
        const newUser = {
          username: username,
          accessCode: newCode,
          scores: {},
          attemptsLeft: {},
          role: 'student',
          allowedSections: ['كمي', 'لفظي']
        };
        
        await window.firebase.addDoc(window.firebase.collection(db, "users"), newUser);
        setDevUsernameToGenerate('');
        alert(`تم توليد رمز دخول جديد للمستخدم ${username}: ${newCode}`);
      };

      const handleDeleteUser = async (userId) => {
        if(confirm(`هل أنت متأكد من رغبتك في حذف هذا المستخدم؟ لا يمكن التراجع عن هذا الإجراء.`)){
            await window.firebase.deleteDoc(window.firebase.doc(db, "users", userId));
        }
      };

      const handleResetSingleTestAttempts = async (userId, testId) => {
         if(confirm(`هل أنت متأكد من رغبتك في تجديد محاولة هذا الاختبار لهذا المستخدم؟`)){
            const userToUpdate = usersData.find(u => u.id === userId);
            const newAttemptsLeft = { ...userToUpdate.attemptsLeft };
            delete newAttemptsLeft[testId];
            await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), { attemptsLeft: newAttemptsLeft });
            alert(`تم تجديد المحاولة للمستخدم.`);
        }
      };
      
      const handleToggleUserRole = async (userId) => {
        const userToUpdate = usersData.find(u => u.id === userId);
        const newRole = userToUpdate.role === 'teacher' ? 'student' : 'teacher';
        let updateData = { role: newRole };

        if (newRole === 'teacher') {
          const password = prompt(`الرجاء تعيين كلمة مرور للمطور الجديد: ${userToUpdate.username}`);
          if (password && password.length > 0) {
            updateData.password = password;
            alert(`تم ترقية المستخدم ${userToUpdate.username} إلى مطور.`);
          } else {
            alert('تم إلغاء الترقية لعدم إدخال كلمة مرور.');
            return;
          }
        } else {
          updateData.password = null;
          alert(`تم تغيير صلاحية المستخدم ${userToUpdate.username} إلى طالب.`);
        }
        await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), updateData);
      };
      
      const handleSectionPermissionChange = async (userId, section) => {
        const userToUpdate = usersData.find(u => u.id === userId);
        const allowed = userToUpdate.allowedSections || ['كمي', 'لفظي'];
        const newAllowedSections = allowed.includes(section)
            ? allowed.filter(s => s !== section)
            : [...allowed, section];
        await window.firebase.updateDoc(window.firebase.doc(db, "users", userId), { allowedSections: newAllowedSections });
    };

      const handleDeleteTest = async (testId) => {
        if(confirm('هل أنت متأكد من رغبتك في حذف هذا الاختبار؟ سيتم حذف جميع درجات الطلاب المتعلقة به.')){
            await window.firebase.deleteDoc(window.firebase.doc(db, "tests", testId));
        }
      };

      const handleReturnToLanding = () => {
        setDevUsername('');
        setDevPassword('');
        setUserUsernameInput('');
        setUserAccessCodeInput('');
        setLoginError('');
        setCurrentPage('landing');
        setCurrentUser(null);
        setLoginRole(null);
      };

      const handleStartTest = (testId) => {
        const allTests = [...(testsData['كمي'] || []), ...(testsData['لفظي'] || [])];
        const test = allTests.find(t => t.id === testId);
        
        const shuffledQuestions = [...test.questions].sort(() => Math.random() - 0.5);
        const testWithShuffledQuestions = { ...test, questions: shuffledQuestions };

        const currentUserData = usersData.find(u => u.username === currentUser.username);
        if (!currentUserData) {
          alert("حدث خطأ في بيانات المستخدم.");
          return;
        }
        
        const attemptsLeft = currentUserData.attemptsLeft[test.id] !== undefined
          ? currentUserData.attemptsLeft[test.id]
          : test.maxAttempts;

        if (attemptsLeft <= 0) {
          alert("لا توجد فرص متبقية لهذا الاختبار.");
          return;
        }

        const allAttempts = Object.values(currentUserData.scores).flat();
        const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
        const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
        const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
        const prerequisite = test.prerequisitePercentage || 0;

        if (overallPercentage < prerequisite) {
            alert(`لا يمكنك بدء هذا الاختبار. يتطلب نسبة كلية تبلغ ${prerequisite}% على الأقل.`);
            return;
        }

        setSelectedTest(testWithShuffledQuestions);
        setAnswers({});
        setQuizSubmitted(false);
        setTimer(test.duration * 60);
        setCurrentPage('test');
        setCurrentQuestionIndex(0);
      };
      
      const handleNextQuestion = () => {
        if (currentQuestionIndex < selectedTest.questions.length - 1) {
          setCurrentQuestionIndex(prevIndex => prevIndex + 1);
        }
      };

      const handlePreviousQuestion = () => {
        if (currentQuestionIndex > 0) {
          setCurrentQuestionIndex(prevIndex => prevIndex - 1);
        }
      };

      const handleAnswerChange = (questionId, selectedOption) => {
        setAnswers({
          ...answers,
          [questionId]: selectedOption
        });
      };

      const handleSubmitTest = async () => {
        if (quizSubmitted) return;
        setQuizSubmitted(true);

        const score = selectedTest.questions.filter(q => answers[q.id] === q.correctAnswer).length;
        const timeTaken = selectedTest.duration * 60 - timer;
        
        const userToUpdate = usersData.find(user => user.username === currentUser.username);
        const userRef = window.firebase.doc(db, "users", userToUpdate.id);

        const newAttemptsLeft = (userToUpdate.attemptsLeft[selectedTest.id] !== undefined
            ? userToUpdate.attemptsLeft[selectedTest.id]
            : selectedTest.maxAttempts) - 1;
            
        const newScoreData = {
            score: score,
            total: selectedTest.questions.length,
            date: new Date().toLocaleDateString('ar-SA'),
            time: new Date().toLocaleTimeString('ar-SA'),
            timeTaken: timeTaken
        };

        const updatedScores = { ...userToUpdate.scores };
        if (!updatedScores[selectedTest.id]) {
            updatedScores[selectedTest.id] = [];
        }
        updatedScores[selectedTest.id].push(newScoreData);

        await window.firebase.updateDoc(userRef, {
            scores: updatedScores,
            [`attemptsLeft.${selectedTest.id}`]: newAttemptsLeft
        });

        setCurrentPage('results');
      };

      const [showUserScores, setShowUserScores] = useState(false);
      const [userScoresToShow, setUserScoresToShow] = useState(null);

      const handleShowUserScores = (user) => {
        setUserScoresToShow(user);
        setShowUserScores(true);
      };

      const handleCloseUserScores = () => {
        setShowUserScores(false);
        setUserScoresToShow(null);
      };

      const dragItem = useRef();
      const dragOverItem = useRef();

      const handleDragStart = (e, position) => {
        dragItem.current = position;
      };

      const handleDragEnter = (e, position) => {
        dragOverItem.current = position;
        const list = [...newTestQuestions];
        const dragItemContent = list[dragItem.current];
        list.splice(dragItem.current, 1);
        list.splice(dragOverItem.current, 0, dragItemContent);
        dragItem.current = dragOverItem.current;
        dragOverItem.current = null;
        setNewTestQuestions(list);
      };

      const handleAddQuestion = () => {
        setNewTestQuestions([...newTestQuestions, {
          id: Date.now(),
          text: '',
          imageUrl: '',
          type: 'mcq',
          options: [
            { id: 'a', text: '', imageUrl: '' },
            { id: 'b', text: '', imageUrl: '' },
            { id: 'c', text: '', imageUrl: '' },
            { id: 'd', text: '', imageUrl: '' }
          ],
          correctAnswer: 'a'
        }]);
      };

      const handleUpdateQuestion = (qIndex, field, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex][field] = value;
        setNewTestQuestions(updatedQuestions);
      };
      
      const handleDeleteQuestion = (qIndex) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions.splice(qIndex, 1);
        setNewTestQuestions(updatedQuestions);
      };
      
      const handleUpdateCorrectAnswer = (qIndex, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex].correctAnswer = value;
        setNewTestQuestions(updatedQuestions);
      };

      const handleUpdateOption = (qIndex, oIndex, field, value) => {
        const updatedQuestions = [...newTestQuestions];
        updatedQuestions[qIndex].options[oIndex][field] = value;
        setNewTestQuestions(updatedQuestions);
      };
      
      const resetCreateTestForm = () => {
          setNewTestTitle('');
          setNewTestDuration('');
          setNewTestMaxAttempts('');
          setNewTestPrerequisite('');
          setNewTestQuestions([]);
          setShowCreateTestForm(false);
          setEditingTestId(null);
      }

      const handleSaveNewTest = async () => {
        if (!newTestTitle || !newTestDuration || !newTestMaxAttempts || newTestQuestions.length === 0) {
            alert('الرجاء إكمال جميع الحقول.');
            return;
        }
        
        const newTest = {
          title: newTestTitle,
          category: newTestCategory,
          duration: parseInt(newTestDuration, 10),
          maxAttempts: parseInt(newTestMaxAttempts, 10),
          prerequisitePercentage: parseInt(newTestPrerequisite, 10) || 0,
          questions: newTestQuestions
        };

        if(editingTestId) {
            await window.firebase.setDoc(window.firebase.doc(db, "tests", editingTestId), newTest);
            alert('تم تحديث الاختبار بنجاح!');
        } else {
            await window.firebase.addDoc(window.firebase.collection(db, "tests"), newTest);
            alert('تم حفظ الاختبار الجديد بنجاح!');
        }
        resetCreateTestForm();
      };

      const handleEditTest = (testToEdit, category) => {
        setEditingTestId(testToEdit.id);
        setNewTestTitle(testToEdit.title);
        setNewTestDuration(testToEdit.duration.toString());
        setNewTestMaxAttempts(testToEdit.maxAttempts.toString());
        setNewTestPrerequisite(testToEdit.prerequisitePercentage?.toString() || '0');
        setNewTestQuestions(JSON.parse(JSON.stringify(testToEdit.questions)));
        setNewTestCategory(category);
        setShowCreateTestForm(true);
      };
      
      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
          setUploadedFile(file);
          setShowFileUploadModal(true);
        }
      };

      const handleGenerateQuizFromFile = async () => {
        if (!uploadedFile || !uploadedQuizDuration || !uploadedQuizAttempts) {
          alert('الرجاء إدخال جميع إعدادات الاختبار.');
          return;
        }

        setShowFileUploadModal(false);
        setFileLoading(true);

        const simulatedFileContent = `
        السؤال 1: ما هي عاصمة المملكة العربية السعودية؟
        أ) جدة
        ب) الرياض
        ج) الدمام
        د) مكة المكرمة
        الإجابة الصحيحة: ب
        `;

        const prompt = `استخدم المحتوى التالي لإنشاء اختبار من 3 أسئلة اختيار من متعدد باللغة العربية. يجب أن يحتوي كل سؤال على 4 خيارات وإجابة صحيحة واحدة. المحتوى هو: "${simulatedFileContent}"`;

        const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
        const payload = {
          contents: chatHistory,
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "OBJECT",
              properties: {
                "title": { "type": "STRING" },
                "questions": {
                  "type": "ARRAY",
                  "items": {
                    "type": "OBJECT",
                    "properties": {
                      "id": { "type": "INTEGER" },
                      "text": { "type": "STRING" },
                      "type": { "type": "STRING", "default": "mcq" },
                      "options": {
                        "type": "ARRAY",
                        "items": {
                          "type": "OBJECT",
                          "properties": {
                            "id": { "type": "STRING" },
                            "text": { "type": "STRING" }
                          }
                        }
                      },
                      "correctAnswer": { "type": "STRING" }
                    }
                  }
                }
              }
            }
          }
        };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await response.json();
          if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
            const jsonString = result.candidates[0].content.parts[0].text.replace(/```json\n|\n```/g, '');
            try {
                const uploadedQuiz = JSON.parse(jsonString);
                
                const newTest = {
                  id: Date.now(),
                  title: uploadedQuiz.title || (uploadedFile ? uploadedFile.name : "اختبار جديد"),
                  duration: parseInt(uploadedQuizDuration, 10),
                  maxAttempts: parseInt(uploadedQuizAttempts, 10),
                  prerequisitePercentage: parseInt(uploadedQuizPrerequisite, 10) || 0,
                  questions: uploadedQuiz.questions.map(q => ({...q, imageUrl: '', options: q.options.map(o => ({...o, imageUrl: ''}))}))
                };

                setTestsData(prev => ({
                  ...prev,
                  [uploadedQuizCategory]: [...(prev[uploadedQuizCategory] || []), newTest]
                }));

                alert('تم إنشاء الاختبار من الملف بنجاح!');
            } catch (parseError) {
                console.error("Error parsing JSON from file generation:", parseError);
                console.error("Malformed JSON string was:", jsonString);
                alert('فشل في تحليل الاختبار الذي تم إنشاؤه.');
            }
          } else {
            console.error("Unexpected API response structure:", result);
            alert('فشل إنشاء الاختبار من الملف.');
          }
        } catch (error) {
          console.error("Error generating quiz from file:", error);
          alert('حدث خطأ أثناء إنشاء الاختبار.');
        } finally {
          setFileLoading(false);
          setUploadedFile(null);
          setUploadedQuizDuration('');
          setUploadedQuizAttempts('');
          setUploadedQuizPrerequisite('');
        }
      };


      const handlePreviewQuiz = (test) => {
        setPreviewQuiz(JSON.parse(JSON.stringify(test)));
        setCurrentPage('preview');
      };

      const handleClosePreview = () => {
        setPreviewQuiz(null);
        setCurrentPage('dashboard');
        setCurrentQuestionIndex(0);
      };
      
      const handleSavePreview = () => {
        if (!previewQuiz) return;
        setTestsData(prevTests => {
          const newTests = { ...prevTests };
          let found = false;
          for (const category in newTests) {
            const testIndex = newTests[category].findIndex(t => t.id === previewQuiz.id);
            if (testIndex !== -1) {
              newTests[category][testIndex] = previewQuiz;
              found = true;
              break;
            }
          }
          if (!found) {
            console.log("Could not find test to save in existing data.");
          }
          return newTests;
        });
        alert('تم حفظ التغييرات بنجاح!');
        handleClosePreview();
      };

      const formatTime = (seconds) => {
          if (isNaN(seconds) || seconds < 0) return "00:00";
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      };

      const ThemeToggleButton = () => (
          <button
              onClick={() => setDarkMode(!darkMode)}
              className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200"
          >
              {darkMode ? (
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
              ) : (
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
              )}
          </button>
      );
      
      const renderLandingPage = () => (
        <div className="flex flex-col items-center justify-center min-h-screen animated-gradient text-center p-4 relative" dir="rtl">
          <div className="absolute top-8 left-1/2 -translate-x-1/2 bg-white p-2 rounded-full shadow-lg">
              <img 
                src="https://fv5-6.files.fm/thumb_show.php?i=jtsxwvdzx7&view&v=1&PHPSESSID=840289eb9c827cf9e763225e5338ec7bcb614132" 
                alt="شعار" 
                className="h-48 w-48 rounded-full object-contain"
                onError={(e) => { e.target.onerror = null; e.target.src = "https://placehold.co/192x192/FFFFFF/000000?text=شعار" }}
              />
          </div>
          <h1 className="text-5xl font-bold text-white mb-4 drop-shadow-lg mt-72">أهلاً بك في منصة الاختبارات</h1>
          <p className="text-xl text-gray-200 mb-12 drop-shadow-md">اختر طريقة الدخول للمتابعة</p>
          <div className="flex flex-col space-y-6 items-center">
             <button 
              onClick={() => { setLoginRole('student'); setCurrentPage('login'); }} 
              className="bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-10 rounded-full text-xl transition duration-300 transform hover:scale-105 shadow-lg backdrop-blur-sm border border-white/30 w-64 flex items-center justify-center space-x-3"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>
              <span>الدخول كمستخدم</span>
            </button>
            <button 
              onClick={() => { setLoginRole('teacher'); setCurrentPage('login'); }} 
              className="bg-white/20 hover:bg-white/30 text-white font-bold py-4 px-10 rounded-full text-xl transition duration-300 transform hover:scale-105 shadow-lg backdrop-blur-sm border border-white/30 w-64 flex items-center justify-center space-x-3"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
              <span>الدخول كمطور</span>
            </button>
          </div>
          <footer className="absolute bottom-4 text-white/70 text-sm">
            جميع الحقوق محفوظة لدى Bungus ® 2025-2026
          </footer>
        </div>
      );

      const renderLoginPage = () => (
        <div className="flex items-center justify-center min-h-screen bg-slate-100 dark:bg-slate-900" dir="rtl">
          <div className="absolute top-4 left-4">
              <ThemeToggleButton />
          </div>
          <div className="w-full max-w-md">
              <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold text-center text-slate-900 dark:text-white mb-6">
                  تسجيل الدخول - {loginRole === 'teacher' ? 'مطور' : 'مستخدم'}
                </h2>
                {loginError && <p className="text-red-500 text-center mb-4">{loginError}</p>}
                {loginRole === 'teacher' ? (
                  <div>
                    <input
                      type="text"
                      placeholder="اسم المستخدم"
                      value={devUsername}
                      onChange={(e) => setDevUsername(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <input
                      type="password"
                      placeholder="كلمة المرور"
                      value={devPassword}
                      onChange={(e) => setDevPassword(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                ) : (
                  <div>
                    <input
                      type="text"
                      placeholder="اسم المستخدم"
                      value={userUsernameInput}
                      onChange={(e) => setUserUsernameInput(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <input
                      type="text"
                      placeholder="رمز الدخول"
                      value={userAccessCodeInput}
                      onChange={(e) => setUserAccessCodeInput(e.target.value)}
                      className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                )}
                <button onClick={handleLogin} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-300">
                  دخول
                </button>
                <button onClick={handleReturnToLanding} className="w-full mt-4 bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 rounded-lg transition duration-300">
                  العودة
                </button>
              </div>
          </div>
        </div>
      );
      
      const [activeTestTab, setActiveTestTab] = useState('كمي');

      const renderMainDashboard = () => (
         <div className="space-y-8">
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold mb-4">إدارة المستخدمين</h2>
                <div className="flex items-center mb-4 space-x-4 rtl:space-x-reverse">
                    <input
                        type="text"
                        placeholder="اسم مستخدم جديد"
                        value={devUsernameToGenerate}
                        onChange={(e) => setDevUsernameToGenerate(e.target.value)}
                        className="p-2 border rounded-lg flex-grow bg-slate-50 dark:bg-slate-700 border-slate-300 dark:border-slate-600"
                    />
                    <button onClick={() => handleGenerateAccessCode(devUsernameToGenerate)} className="bg-green-500 text-white py-2 px-4 rounded-lg">إنشاء رمز دخول</button>
                </div>
                <button onClick={() => setDevPage('users')} className="text-blue-500 hover:underline mb-2 block">
                    الانتقال إلى الإدارة المتقدمة للمستخدمين &larr;
                </button>
                <button onClick={() => setDevPage('resultsDashboard')} className="text-blue-500 hover:underline">
                    الانتقال الي النتائج المتقدمة للمستخدمين &larr;
                </button>
            </div>

            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
              <h2 className="text-2xl font-bold mb-4">إنشاء اختبار</h2>
              {!showCreateTestForm ? (
                  <div className="flex space-x-4 rtl:space-x-reverse">
                      <button onClick={() => { setShowCreateTestForm(true); setNewTestCategory('كمي'); }} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">
                          اضافة اختبار كمي
                      </button>
                      <button onClick={() => { setShowCreateTestForm(true); setNewTestCategory('لفظي'); }} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">
                          اضافة اختبار لفظي
                      </button>
                  </div>
              ) : (
                  <div>
                      <h3 className="text-xl font-semibold mb-4">{editingTestId ? `تعديل اختبار ${newTestCategory}` : `إضافة اختبار ${newTestCategory} جديد`}</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                          <input type="text" placeholder="عنوان الاختبار" value={newTestTitle} onChange={(e) => setNewTestTitle(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                          <input type="number" placeholder="المدة (دقائق)" value={newTestDuration} onChange={(e) => setNewTestDuration(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                          <input type="number" placeholder="أقصى عدد محاولات" value={newTestMaxAttempts} onChange={(e) => setNewTestMaxAttempts(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                          <input type="number" placeholder="النسبة المطلوبة (%)" value={newTestPrerequisite} onChange={(e) => setNewTestPrerequisite(e.target.value)} className="p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                      </div>
                      {newTestQuestions.map((q, qIndex) => (
                          <div 
                            key={q.id} 
                            className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg mb-4 border dark:border-slate-600"
                          >
                            <div 
                                className="cursor-grab"
                                draggable
                                onDragStart={(e) => handleDragStart(e, qIndex)}
                                onDragEnter={(e) => handleDragEnter(e, qIndex)}
                            >
                              <h4 className="font-bold mb-2">السؤال {qIndex + 1}</h4>
                              <textarea value={q.text} onChange={(e) => handleUpdateQuestion(qIndex, 'text', e.target.value)} placeholder="نص السؤال" className="w-full p-2 border rounded-lg mb-2 bg-white dark:bg-slate-600"></textarea>
                            </div>
                              <input
                                type="text"
                                placeholder="أدخل رابط صورة للسؤال (اختياري)"
                                value={q.imageUrl}
                                onChange={(e) => handleUpdateQuestion(qIndex, 'imageUrl', e.target.value)}
                                className="w-full p-2 border rounded-lg mb-2 bg-white dark:bg-slate-600"
                              />
                              {q.imageUrl && <img src={q.imageUrl} className="w-32 h-32 object-cover rounded-lg my-2 mx-auto" alt="معاينة السؤال"/>}
                              
                              {q.options.map((opt, oIndex) => (
                                  <div key={opt.id} className="flex items-center mb-2 bg-white dark:bg-slate-600 p-2 rounded-lg">
                                      <input type="radio" name={`correct-answer-${q.id}`} checked={q.correctAnswer === opt.id} onChange={() => handleUpdateCorrectAnswer(qIndex, opt.id)} className="ml-2"/>
                                      <input type="text" value={opt.text} onChange={(e) => handleUpdateOption(qIndex, oIndex, 'text', e.target.value)} placeholder={`الخيار ${String.fromCharCode(97 + oIndex)}`} className="p-2 border rounded-lg flex-grow bg-white dark:bg-slate-500"/>
                                      <input type="text" placeholder="رابط صورة للخيار" value={opt.imageUrl} onChange={(e) => handleUpdateOption(qIndex, oIndex, 'imageUrl', e.target.value)} className="p-2 border rounded-lg w-1/3 ml-2 bg-white dark:bg-slate-500"/>
                                      {opt.imageUrl && <img src={opt.imageUrl} className="w-16 h-16 object-cover rounded-md ml-2" alt="معاينة الخيار"/>}
                                  </div>
                              ))}
                              <button onClick={() => handleDeleteQuestion(qIndex)} className="text-red-500 hover:text-red-700 text-xs mt-2">حذف السؤال</button>
                          </div>
                      ))}
                      <div className="flex space-x-4 rtl:space-x-reverse">
                          <button onClick={handleAddQuestion} className="bg-slate-200 dark:bg-slate-600 p-2 rounded-lg">إضافة سؤال</button>
                          <button onClick={handleSaveNewTest} className="bg-green-500 text-white p-2 rounded-lg">{editingTestId ? 'تحديث الاختبار' : 'حفظ الاختبار'}</button>
                          <button onClick={resetCreateTestForm} className="bg-red-500 text-white p-2 rounded-lg">إلغاء</button>
                      </div>
                  </div>
              )}
            </div>
            
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
               <h2 className="text-2xl font-bold mb-4">الاختبارات الحالية</h2>
                <div className="border-b border-slate-200 dark:border-slate-700 mb-4">
                    <nav className="-mb-px flex space-x-8 rtl:space-x-reverse" aria-label="Tabs">
                        <button onClick={() => setActiveTestTab('كمي')} className={`${activeTestTab === 'كمي' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
                            كمي
                        </button>
                        <button onClick={() => setActiveTestTab('لفظي')} className={`${activeTestTab === 'لفظي' ? 'border-blue-500 text-blue-600' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 dark:text-slate-400 dark:hover:text-slate-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
                            لفظي
                        </button>
                    </nav>
                </div>
                
                <div>
                    {(testsData[activeTestTab]?.length ?? 0) === 0 ? (
                        <p>لا توجد اختبارات في قسم {activeTestTab}.</p>
                    ) : (
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {testsData[activeTestTab].map(test => (
                                <div key={test.id} className="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg border dark:border-slate-600">
                                    <h4 className="text-lg font-bold">{test.title}</h4>
                                    <p>{test.questions.length} أسئلة</p>
                                    <div className="mt-4 flex space-x-2 rtl:space-x-reverse">
                                        <button onClick={() => handlePreviewQuiz(test)} className="flex-1 bg-blue-500 text-white p-2 rounded-lg">معاينة</button>
                                        <button onClick={() => handleEditTest(test, activeTestTab)} className="flex-1 bg-yellow-500 text-white p-2 rounded-lg">تعديل</button>
                                        <button onClick={() => handleDeleteTest(test.id)} className="flex-1 bg-red-500 text-white p-2 rounded-lg">حذف</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
      );

      const [userSearchTerm, setUserSearchTerm] = useState('');
      const filteredUsers = usersData
        .filter(user => 
            user.username.toLowerCase().includes(userSearchTerm.toLowerCase())
        )
        .sort((a, b) => {
            if (a.role === 'teacher' && b.role !== 'teacher') return -1;
            if (a.role !== 'teacher' && b.role === 'teacher') return 1;
            return a.username.localeCompare(b.username);
        });

      const renderUserManagementPage = () => (
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold">الإدارة المتقدمة للمستخدمين</h2>
                <button onClick={() => setDevPage('dashboard')} className="text-blue-500 hover:underline">
                    &rarr; العودة إلى لوحة التحكم الرئيسية
                </button>
            </div>
            <div className="mb-4">
                <input 
                    type="text"
                    placeholder="ابحث عن اسم مستخدم..."
                    value={userSearchTerm}
                    onChange={(e) => setUserSearchTerm(e.target.value)}
                    className="w-full p-3 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg"
                />
            </div>
            <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                    <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                        <tr>
                            <th scope="col" className="px-6 py-3">اسم المستخدم</th>
                            <th scope="col" className="px-6 py-3">رمز الدخول</th>
                            <th scope="col" className="px-6 py-3">الصلاحية</th>
                            <th scope="col" className="px-6 py-3">الأقسام المتاحة</th>
                            <th scope="col" className="px-6 py-3 text-center">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredUsers.map(user => (
                            <tr key={user.username} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600">
                                <td className="px-6 py-4 font-medium text-slate-900 dark:text-white">{user.username}</td>
                                <td className="px-6 py-4">{user.accessCode}</td>
                                <td className="px-6 py-4">
                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${user.role === 'teacher' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300'}`}>
                                        {user.role === 'teacher' ? 'مطور' : 'طالب'}
                                    </span>
                                </td>
                                <td className="px-6 py-4">
                                    <div className="flex items-center space-x-4 rtl:space-x-reverse">
                                        <label className="flex items-center">
                                            <input 
                                                type="checkbox" 
                                                checked={user.allowedSections?.includes('كمي') ?? true} 
                                                onChange={() => handleSectionPermissionChange(user.id, 'كمي')}
                                                className="form-checkbox h-4 w-4 text-blue-600 rounded"
                                            />
                                            <span className="mr-2">كمي</span>
                                        </label>
                                        <label className="flex items-center">
                                            <input 
                                                type="checkbox" 
                                                checked={user.allowedSections?.includes('لفظي') ?? true} 
                                                onChange={() => handleSectionPermissionChange(user.id, 'لفظي')}
                                                className="form-checkbox h-4 w-4 text-green-600 rounded"
                                            />
                                            <span className="mr-2">لفظي</span>
                                        </label>
                                    </div>
                                </td>
                                <td className="px-6 py-4 flex items-center justify-center space-x-2 rtl:space-x-reverse">
                                    <button onClick={() => handleShowUserScores(user)} title="عرض بيانات المستخدم" className="p-2 text-slate-500 hover:text-blue-600 dark:hover:text-blue-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fillRule="evenodd" d="M.458 10C3.732 4.943 9.522 3 10 3s6.268 1.943 9.542 7c-3.274 5.057-9.064 7-9.542 7S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clipRule="evenodd" /></svg>
                                    </button>
                                    <button onClick={() => handleToggleUserRole(user.id)} title="اجعله مطور" className="p-2 text-slate-500 hover:text-green-600 dark:hover:text-green-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" /></svg>
                                    </button>
                                    <button onClick={() => handleDeleteUser(user.id)} title="حذف المستخدم" className="p-2 text-slate-500 hover:text-red-600 dark:hover:text-red-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
      );
      
      const Leaderboard = ({ users, limit = 10 }) => {
        const leaderboardData = useMemo(() => {
            return users
                .filter(user => user.role === 'student') // Filter out teachers
                .map(user => {
                    const allAttempts = Object.values(user.scores).flat();
                    const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
                    const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
                    const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
                    return { username: user.username, score: overallPercentage.toFixed(2) };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, limit);
        }, [users]);

        const Medal = ({ rank }) => {
            if (rank === 0) return <span title="المركز الأول" className="text-yellow-400">🥇</span>;
            if (rank === 1) return <span title="المركز الثاني" className="text-slate-400">🥈</span>;
            if (rank === 2) return <span title="المركز الثالث" className="text-yellow-600">🥉</span>;
            return <span className="text-slate-400">{rank + 1}</span>;
        };

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 className="text-2xl font-bold mb-4 text-center">قائمة المتصدرين</h2>
                <ul className="space-y-4">
                    {leaderboardData.map((user, index) => (
                        <li key={user.username} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700 rounded-lg">
                            <div className="flex items-center">
                                <span className="text-lg font-bold w-8 text-center"><Medal rank={index} /></span>
                                <span className="font-medium text-slate-900 dark:text-white">{user.username}</span>
                            </div>
                            <span className="font-bold text-blue-500">{user.score}%</span>
                        </li>
                    ))}
                </ul>
            </div>
        );
      };

      const ResultsDashboard = ({ users, onBack }) => {
        const [highlightedIndex, setHighlightedIndex] = useState(null);
        const [tooltip, setTooltip] = useState({ show: false, content: '', x: 0, y: 0 });
        const containerRef = useRef(null);

        const studentsData = useMemo(() => {
            return users
                .filter(user => user.role === 'student')
                .map(user => {
                    const allAttempts = Object.values(user.scores).flat();
                    const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
                    const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
                    const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100) : 0;
                    return { name: user.username, score: Math.round(overallPercentage) };
                })
                .sort((a, b) => b.score - a.score);
        }, [users]);

        const Chart = () => {
            const chartRef = useRef(null);
            const [dimensions, setDimensions] = useState({ width: 0, height: 500 });

            useEffect(() => {
                const handleResize = () => {
                    if (chartRef.current) {
                        setDimensions({ width: chartRef.current.clientWidth, height: 500 });
                    }
                };
                handleResize();
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            if (dimensions.width === 0) {
                return <div ref={chartRef} className="w-full h-[500px]"></div>;
            }

            const padding = { top: 20, right: 10, bottom: 20, left: 10 };
            const chartWidth = dimensions.width - padding.left - padding.right;
            const chartHeight = dimensions.height - padding.top - padding.bottom;
            const barWidth = studentsData.length > 0 ? chartWidth / studentsData.length * 0.8 : 0;
            const barSpacing = studentsData.length > 0 ? chartWidth / studentsData.length * 0.2 : 0;

            return (
                <div ref={chartRef} className="w-full">
                    <svg width="100%" height={dimensions.height} viewBox={`0 0 ${dimensions.width} ${dimensions.height}`}>
                        <g transform={`translate(${padding.left}, ${padding.top})`}>
                            {/* Y-axis grid lines */}
                            {Array.from({ length: 11 }).map((_, i) => {
                                const y = chartHeight - (i * chartHeight / 10);
                                return <line key={i} className="axis-line" x1={0} y1={y} x2={chartWidth} y2={y} />;
                            })}
                            {/* Bars */}
                            {studentsData.map((student, i) => {
                                const barHeight = (student.score / 100) * chartHeight;
                                const xPos = i * (barWidth + barSpacing);
                                const yPos = chartHeight - barHeight;
                                return (
                                    <rect
                                        key={student.name}
                                        className={`c-graph__bar ${highlightedIndex === i ? 'highlighted' : ''}`}
                                        x={xPos}
                                        y={yPos}
                                        width={barWidth}
                                        height={barHeight}
                                        fill="#6d28d9"
                                        rx="2"
                                        onMouseMove={(e) => {
                                            setTooltip({
                                                show: true,
                                                content: `<strong>${student.name}</strong><br>النسبة: ${student.score}%`,
                                                x: e.pageX,
                                                y: e.pageY
                                            });
                                        }}
                                        onMouseLeave={() => setTooltip({ ...tooltip, show: false })}
                                        onMouseEnter={() => setHighlightedIndex(i)}
                                        onMouseOut={() => setHighlightedIndex(null)}
                                    />
                                );
                            })}
                        </g>
                    </svg>
                </div>
            );
        };

        return (
            <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg w-full" ref={containerRef}>
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold">تحليل الأداء الفردي للطلاب</h2>
                    <button onClick={onBack} className="text-blue-500 hover:underline">
                        &rarr; العودة إلى لوحة التحكم الرئيسية
                    </button>
                </div>

                <div className="main-container">
                    <div className="chart-container">
                        <Chart />
                    </div>
                    <div className="table-container">
                        <table className="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400 sticky top-0">
                                <tr>
                                    <th scope="col" className="px-6 py-3">اسم الطالب</th>
                                    <th scope="col" className="px-6 py-3">النسبة</th>
                                </tr>
                            </thead>
                            <tbody>
                                {studentsData.map((student, index) => (
                                    <tr
                                        key={student.name}
                                        className="bg-white dark:bg-slate-800 border-b dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600"
                                        onMouseEnter={() => setHighlightedIndex(index)}
                                        onMouseLeave={() => setHighlightedIndex(null)}
                                    >
                                        <td className="px-6 py-4 font-medium text-gray-900 dark:text-white whitespace-nowrap">{student.name}</td>
                                        <td className="px-6 py-4">{student.score}%</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
                {tooltip.show && (
                    <div
                        id="tooltip"
                        style={{ left: tooltip.x, top: tooltip.y, opacity: 1 }}
                        dangerouslySetInnerHTML={{ __html: tooltip.content }}
                    />
                )}
            </div>
        );
      };


      // Main Developer Dashboard Container
      const renderTeacherDashboard = () => (
        <div className="min-h-screen text-slate-900 dark:text-slate-100 p-4 sm:p-8">
            <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-8">
                    <h1 className="text-3xl font-bold">مرحباً بك، {currentUser.username}</h1>
                    <div className="flex items-center space-x-4">
                        <ThemeToggleButton />
                        <button onClick={handleReturnToLanding} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl">تسجيل الخروج</button>
                    </div>
                </div>
                {devPage === 'resultsDashboard' ? (
                     <ResultsDashboard users={usersData} onBack={() => setDevPage('dashboard')} />
                ) : (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 order-2 lg:order-1">
                            {devPage === 'dashboard' ? renderMainDashboard() : renderUserManagementPage()}
                        </div>
                        <div className="lg:col-span-1 order-1 lg:order-2">
                            <Leaderboard users={usersData} />
                        </div>
                    </div>
                )}
            </div>
        </div>
      );
      
      // Render Student Dashboard
      const renderStudentDashboard = () => {
        const currentUserData = currentUser;
        
        if (!isDataLoaded) {
            return <div className="min-h-screen flex items-center justify-center"><p>جاري تحميل البيانات...</p></div>;
        }
        
        if (!currentUserData || currentUserData.role !== 'student') {
            return <div className="min-h-screen flex items-center justify-center"><p>خطأ في تحميل بيانات المستخدم. الرجاء محاولة تسجيل الدخول مرة أخرى.</p></div>;
        }

        const allowedSections = currentUserData.allowedSections || ['كمي', 'لفظي'];
        const allTests = [
            ...(allowedSections.includes('كمي') ? (testsData['كمي'] || []) : []),
            ...(allowedSections.includes('لفظي') ? (testsData['لفظي'] || []) : [])
        ];
        
        const allAttempts = Object.values(currentUserData.scores).flat();
        const totalScored = allAttempts.reduce((acc, scoreData) => acc + scoreData.score, 0);
        const totalPossible = allAttempts.reduce((acc, scoreData) => acc + scoreData.total, 0);
        const overallPercentage = totalPossible > 0 ? ((totalScored / totalPossible) * 100).toFixed(2) : 0;

        return (
          <div className="min-h-screen text-slate-900 dark:text-slate-100 p-4 sm:p-8">
            <div className="max-w-7xl mx-auto">
                <div className="flex justify-between items-center mb-8">
                  <h1 className="text-3xl font-bold">مرحباً بك، {currentUser.username}</h1>
                  <div className="flex items-center space-x-4">
                    <ThemeToggleButton />
                    <button onClick={handleReturnToLanding} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl">تسجيل الخروج</button>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-2">ملخص الأداء</h2>
                        <p className="text-lg">النسبة الكلية لجميع الاختبارات: <span className="font-bold text-blue-500">{overallPercentage}%</span></p>
                    </div>
                    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-2">الاختبارات</h2>
                        <p className="text-lg">المنجزة: <span className="font-bold text-green-500">{Object.keys(currentUserData.scores).length}</span></p>
                        <p className="text-lg">المتبقية: <span className="font-bold text-red-500">{allTests.length - Object.keys(currentUserData.scores).length}</span></p>
                    </div>
                </div>
                
                <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
                  <h2 className="text-2xl font-bold mb-4">الاختبارات المتاحة</h2>
                  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {allTests.length > 0 ? allTests.map(test => {
                      const attemptsLeft = currentUserData.attemptsLeft[test.id] !== undefined
                        ? currentUserData.attemptsLeft[test.id]
                        : test.maxAttempts;
                      const prerequisite = test.prerequisitePercentage || 0;
                      const isLocked = overallPercentage < prerequisite;

                      return (
                        <div key={test.id} className="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg border dark:border-slate-600">
                          <h3 className="text-xl font-bold">{test.title}</h3>
                          <p>المدة: {test.duration} دقيقة</p>
                          <p>المحاولات المتبقية: {attemptsLeft}</p>
                          {isLocked && <p className="text-sm text-red-500 mt-1">مغلق (يتطلب {prerequisite}% للوصول)</p>}
                          <button 
                            onClick={() => handleStartTest(test.id)}
                            disabled={attemptsLeft <= 0 || isLocked}
                            className="mt-4 w-full bg-blue-500 text-white p-2 rounded-lg disabled:bg-slate-400">
                            {isLocked ? 'مغلق' : (attemptsLeft > 0 ? 'ابدأ الاختبار' : 'لا توجد محاولات')}
                          </button>
                        </div>
                      );
                    }) : <p>لا توجد اختبارات متاحة لك حالياً.</p>}
                  </div>
                </div>
            </div>
          </div>
        );
      };

      const renderPreviewPage = () => {
        if (!previewQuiz) {
          return null;
        }

        const question = previewQuiz.questions[currentQuestionIndex];
        const isFirstQuestion = currentQuestionIndex === 0;
        const isLastQuestion = currentQuestionIndex === previewQuiz.questions.length - 1;

        return (
          <div className="flex flex-col items-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl mt-10">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">{previewQuiz.title}</h1>
                <div className="flex items-center space-x-4">
                  <ThemeToggleButton />
                  <button onClick={handleClosePreview} className="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-xl transition duration-300">
                    إغلاق المعاينة
                  </button>
                </div>
              </div>

              <div className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600">
                {question.imageUrl && (
                  <img
                    src={question.imageUrl}
                    alt={`صورة للسؤال رقم ${currentQuestionIndex + 1}`}
                    className="w-full max-h-60 object-contain rounded-lg mb-4"
                  />
                )}
                <p className="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                  {currentQuestionIndex + 1}. {question.text}
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {question.options.map(option => (
                    <div
                      key={option.id}
                      className={`flex flex-col items-center justify-center p-4 rounded-lg border-2
                      ${question.correctAnswer === option.id ? 'bg-green-100 dark:bg-green-900 border-green-500' : 'bg-white dark:bg-slate-800'}`}
                    >
                      {option.imageUrl && <img src={option.imageUrl} className="w-24 h-24 object-contain rounded-md mb-2" />}
                      <span className="text-slate-900 dark:text-white text-center font-bold">{option.text}</span>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="mt-8 flex justify-between">
                <button
                  onClick={() => setCurrentQuestionIndex(prevIndex => prevIndex - 1)}
                  disabled={isFirstQuestion}
                  className={`bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md
                  ${isFirstQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}
                >
                  السابق
                </button>
                <button
                  onClick={() => setCurrentQuestionIndex(prevIndex => prevIndex + 1)}
                  disabled={isLastQuestion}
                  className={`bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md
                  ${isLastQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}
                >
                  التالي
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Render the Test page
      const renderTestPage = () => {
        if (!selectedTest) return null;
        const question = selectedTest.questions[currentQuestionIndex];
        const isFirstQuestion = currentQuestionIndex === 0;
        const isLastQuestion = currentQuestionIndex === selectedTest.questions.length - 1;

        return (
          <div className="flex flex-col items-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl mt-10">
              <div className="flex justify-between items-center mb-6">
                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">{selectedTest.title}</h1>
                <div className="flex items-center space-x-4">
                  <ThemeToggleButton />
                  <div className="bg-red-100 text-red-700 px-4 py-2 rounded-full font-bold">
                    متبقي: {formatTime(timer)}
                  </div>
                </div>
              </div>

              <div className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600">
                {question.imageUrl && (
                  <img
                    src={question.imageUrl}
                    alt={`صورة للسؤال رقم ${currentQuestionIndex + 1}`}
                    className="w-full max-h-60 object-contain rounded-lg mb-4"
                  />
                )}
                <p className="text-lg font-semibold text-slate-900 dark:text-white mb-4">
                  {currentQuestionIndex + 1}. {question.text}
                </p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {question.options.map(option => (
                    <label
                      key={option.id}
                      onClick={() => handleAnswerChange(question.id, option.id)}
                      className={`flex flex-col items-center justify-center cursor-pointer p-4 rounded-lg border-2 transition duration-200
                      ${answers[question.id] === option.id ? 'bg-blue-100 dark:bg-blue-900 border-blue-500' : 'bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
                    >
                      {option.imageUrl && <img src={option.imageUrl} className="w-24 h-24 object-contain rounded-md mb-2" />}
                      <span className="text-slate-900 dark:text-white text-center font-bold">{option.text}</span>
                    </label>
                  ))}
                </div>
              </div>
              
              <div className="mt-8 flex justify-between">
                <button
                  onClick={handlePreviousQuestion}
                  disabled={isFirstQuestion}
                  className={`bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md
                  ${isFirstQuestion ? 'opacity-50 cursor-not-allowed' : ''}`}
                >
                  السابق
                </button>
                {isLastQuestion ? (
                  <button
                    onClick={handleSubmitTest}
                    disabled={quizSubmitted}
                    className={`bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md
                    ${quizSubmitted ? 'opacity-50 cursor-not-allowed' : ''}`}
                  >
                    إرسال الاختبار
                  </button>
                ) : (
                  <button
                    onClick={handleNextQuestion}
                    className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-md"
                  >
                    التالي
                  </button>
                )}
              </div>
            </div>
          </div>
        );
      };

      // Render the results page
      const renderResultsPage = () => {
        if (!selectedTest) return null;
        let score = 0;
        let totalQuestions = selectedTest.questions.length;

        selectedTest.questions.forEach(question => {
          if (answers[question.id] === question.correctAnswer) {
            score++;
          }
        });
        
        const percentage = (score / totalQuestions) * 100;
        
        const ScoreIndicator = () => {
            if (percentage >= 80) return <span className="text-green-500 text-2xl ml-2">✅</span>;
            if (percentage >= 60) return <span className="text-orange-500 text-2xl ml-2">⚠️</span>;
            if (percentage >= 50) return <span className="text-red-500 text-2xl ml-2">❌</span>;
            return <span className="text-slate-500 text-2xl ml-2">⚪️</span>;
        };

        return (
          <div className="flex flex-col items-center justify-center min-h-screen p-4" dir="rtl">
            <div className="bg-white dark:bg-slate-800 p-8 rounded-xl shadow-lg w-full max-w-4xl text-center">
              <div className="absolute top-4 left-4">
                <ThemeToggleButton />
              </div>
              <h1 className="text-3xl font-bold mb-6 text-slate-900 dark:text-white">نتائج الاختبار</h1>
              <p className="text-xl text-slate-600 dark:text-slate-300 mb-8">
                لقد أنهيت اختبار: <span className="font-semibold text-blue-500">{selectedTest.title}</span>
              </p>

              <div className="mb-8 flex items-center justify-center">
                <p className="text-2xl font-bold text-slate-900 dark:text-white">
                  درجتك: <span className="text-green-500">{score}</span> / <span className="text-blue-500">{totalQuestions}</span>
                </p>
                <ScoreIndicator />
              </div>
              
              <div className="text-right">
                {selectedTest.questions.map((question, qIndex) => (
                  <div key={question.id} className="bg-slate-50 dark:bg-slate-700 p-6 rounded-xl shadow-inner mb-6 border border-slate-200 dark:border-slate-600 text-right">
                    {question.imageUrl && (
                      <img
                        src={question.imageUrl}
                        alt={`صورة للسؤال رقم ${qIndex + 1}`}
                        className="w-full max-h-60 object-contain rounded-lg mb-4"
                      />
                    )}
                    <p className="text-lg font-semibold text-slate-900 dark:text-white mb-2">
                      {currentQuestionIndex + 1}. <MathComponent text={question.text} />
                    </p>
                    <div className="mt-2 text-slate-700 dark:text-slate-300">
                      <p className={`mb-1 ${answers[question.id] === question.correctAnswer ? 'text-green-600' : 'text-red-600'}`}>
                        <span className="font-bold">إجابتك:</span> <MathComponent text={question.options.find(opt => opt.id === answers[question.id])?.text || 'لم يتم الإجابة'} />
                      </p>
                      <p>
                        <span className="font-bold text-green-600 dark:text-green-400">الإجابة الصحيحة:</span> <MathComponent text={question.options.find(opt => opt.id === question.correctAnswer)?.text} />
                      </p>
                      
                    </div>
                  </div>
                ))}
              </div>

              <button
                onClick={() => setCurrentPage('dashboard')}
                className="mt-8 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105 shadow-md"
              >
                العودة إلى لوحة التحكم
              </button>
            </div>
          </div>
        );
      };

      const UserScoresModal = ({ user, onClose, onResetAttempt, allTests }) => {
          if (!user) return null;
          
          const allUserTests = Array.from(new Set(Object.keys(user.scores).concat(Object.keys(user.attemptsLeft))));

          return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-4xl w-full text-slate-900 dark:text-slate-100">
                      <div className="flex justify-between items-center mb-4">
                          <h3 className="text-xl font-bold">بيانات المستخدم: {user.username}</h3>
                          <button onClick={onClose} className="text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white">&times;</button>
                      </div>
                      
                      <div className="max-h-96 overflow-y-auto">
                          <table className="w-full text-sm text-left text-slate-500 dark:text-slate-400">
                              <thead className="text-xs text-slate-700 uppercase bg-slate-50 dark:bg-slate-700 dark:text-slate-400">
                                  <tr>
                                      <th scope="col" className="px-6 py-3">الاختبار</th>
                                      <th scope="col" className="px-6 py-3">الدرجات (التاريخ والوقت)</th>
                                      <th scope="col" className="px-6 py-3">المحاولات المتبقية</th>
                                      <th scope="col" className="px-6 py-3">إجراء</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {allUserTests.length > 0 ? allUserTests.map(testId => {
                                      const test = allTests.find(t => t.id == testId);
                                      if (!test) return null;
                                      const scoresForTest = user.scores[testId] || [];
                                      const attemptsLeftForTest = user.attemptsLeft[test.id] !== undefined ? user.attemptsLeft[test.id] : test.maxAttempts;

                                      return (
                                          <tr key={test.id} className="bg-white dark:bg-slate-800 border-b dark:border-slate-700">
                                              <th scope="row" className="px-6 py-4 font-medium text-slate-900 dark:text-white whitespace-nowrap">{test.title}</th>
                                              <td className="px-6 py-4">
                                                  {scoresForTest.length > 0 ? scoresForTest.map((scoreData, index) => (
                                                      <div key={index} className="text-xs">
                                                          {scoreData.score}/{scoreData.total} - {scoreData.date} ({formatTime(scoreData.timeTaken)})
                                                      </div>
                                                  )) : "لا توجد درجات"}
                                              </td>
                                              <td className="px-6 py-4">{attemptsLeftForTest}</td>
                                              <td className="px-6 py-4">
                                                  <button onClick={() => onResetAttempt(user.id, test.id)} className="text-blue-500 hover:underline text-xs">
                                                      تجديد المحاولة
                                                  </button>
                                              </td>
                                          </tr>
                                      );
                                  }) : (
                                      <tr><td colSpan="4" className="text-center py-4">لا توجد بيانات اختبارات لهذا المستخدم.</td></tr>
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          );
      };
      
      const FileUploadModal = ({ onClose }) => (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 max-w-md w-full">
                  <h3 className="text-xl font-bold mb-4 text-slate-900 dark:text-white">إعدادات الاختبار المرفوع</h3>
                  <div className="space-y-4">
                      <input type="number" placeholder="مدة الاختبار (دقائق)" value={uploadedQuizDuration} onChange={(e) => setUploadedQuizDuration(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                      <input type="number" placeholder="عدد المحاولات" value={uploadedQuizAttempts} onChange={(e) => setUploadedQuizAttempts(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                      <input type="number" placeholder="النسبة المطلوبة لدخول الاختبار (%)" value={uploadedQuizPrerequisite} onChange={(e) => setUploadedQuizPrerequisite(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700" />
                      <select value={uploadedQuizCategory} onChange={(e) => setUploadedQuizCategory(e.target.value)} className="w-full p-2 border rounded-lg bg-slate-50 dark:bg-slate-700">
                          <option value="كمي">كمي</option>
                          <option value="لفظي">لفظي</option>
                      </select>
                  </div>
                  <div className="flex justify-end space-x-4 rtl:space-x-reverse mt-6">
                      <button onClick={onClose} className="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded">إلغاء</button>
                      <button onClick={handleGenerateQuizFromFile} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">إنشاء الاختبار</button>
                  </div>
              </div>
          </div>
      );

      // Render the correct page based on the current state
      const renderCurrentPage = () => {
        switch (currentPage) {
          case 'landing':
            return renderLandingPage();
          case 'login':
            return renderLoginPage();
          case 'dashboard':
            return currentUser?.role?.includes('teacher') || currentUser?.role === 'superadmin' ? renderTeacherDashboard() : renderStudentDashboard();
          case 'test':
            return renderTestPage();
          case 'results':
            return renderResultsPage();
          case 'preview':
            return renderPreviewPage();
          default:
            return renderLandingPage();
        }
      };
      
      const allTests = useMemo(() => [...(testsData['كمي'] || []), ...(testsData['لفظي'] || [])], [testsData]);

      return (
        <div className="font-sans">
          {renderCurrentPage()}
          {showUserScores && <UserScoresModal user={userScoresToShow} onClose={handleCloseUserScores} onResetAttempt={handleResetSingleTestAttempts} allTests={allTests} />}
          {showFileUploadModal && <FileUploadModal onClose={() => setShowFileUploadModal(false)} />}
        </div>
      );
    }
    
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
